<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="linux, iptables, firewall, NAT, ufw, linux, " />
        <title>firewall iptables ufw ssh https nat forwarding redirect  · johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/firewall-iptables-ufw-ssh-https-nat-forwarding-redirect/"> firewall iptables ufw ssh https nat forwarding redirect  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#most-common-commands">Most common commands</a></li>
<li><a href="#interactive-commands">Interactive commands</a><ul>
<li><a href="#iptables-allow-ping-with-a-ratelimit">iptables allow ping with a ratelimit</a></li>
<li><a href="#clean-out-the-old-iptables-very-insecure-settings">Clean out the old iptables - very insecure settings</a></li>
<li><a href="#allow-ssh-ping-and-established-but-block-all-by-default">Allow SSH, ping, and Established but block all by default</a></li>
<li><a href="#bash-script-to-set-iptables-during-initd">bash script to set iptables during init.d</a></li>
<li><a href="#web-server">Web Server</a></li>
<li><a href="#web-and-xmpp-server">Web and XMPP Server</a></li>
<li><a href="#ntp">NTP</a></li>
<li><a href="#nat-forwarding">NAT forwarding</a></li>
<li><a href="#cifs">CIFS</a></li>
<li><a href="#allow-ad-lookups-ldapldaps">Allow AD Lookups LDAP/LDAPS</a></li>
<li><a href="#dmz-setup-with-dual-nic">DMZ Setup with dual nic</a><ul>
<li><a href="#forward-traffic-between-dmz-and-lan">forward traffic between DMZ and LAN</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#uncomplicated-firewall-ufw">Uncomplicated Firewall UFW</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<p>iptables is the tool to create a firewall in linux (manipulate the tables provided by the kernel firewall aka the netfilter)
<a href="https://en.wikipedia.org/wiki/Netfilter">https://en.wikipedia.org/wiki/Netfilter</a></p>
<div class="highlight"><pre><span></span><code>which iptables
sudo /sbin/iptables --version
</code></pre></div>
<h2 id="most-common-commands">Most common commands</h2>
<div class="highlight"><pre><span></span><code>iptables -nvL
</code></pre></div>
<blockquote>
<p>output the rules in the default "FILTER" table (INPUT, OUTPUT) in numeric , verbose, List all rules</p>
</blockquote>
<p><a href="http://ipset.netfilter.org/iptables.man.html">http://ipset.netfilter.org/iptables.man.html</a></p>
<div class="highlight"><pre><span></span><code>iptables -nvL --line-numbers
</code></pre></div>
<blockquote>
<p>numeric so no hostname lookups, verbose, List the rules in the chain</p>
</blockquote>
<h2 id="interactive-commands">Interactive commands</h2>
<div class="highlight"><pre><span></span><code>iptables -D INPUT 5
</code></pre></div>
<blockquote>
<p>delete the 5th line</p>
</blockquote>
<p><em>don't forget chmod +x firewall-script-filename.sh and /sbin/service iptables save</em></p>
<h3 id="iptables-allow-ping-with-a-ratelimit">iptables allow ping with a ratelimit</h3>
<div class="highlight"><pre><span></span><code>iptables -A INPUT -p icmp -m limit --limit 10/second -j ACCEPT
iptables -A OUPUT -p icmp -j ACCEPT
&gt; allow 10 inbound icmp packets (not tcp nor udp) per second and allow all icmp traffic outbound

iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
&gt; echo-request = 8 in numeric

iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
&gt; Allow outgoing ping replies, echo reply = 0 in numeric
</code></pre></div>
<h3 id="clean-out-the-old-iptables-very-insecure-settings">Clean out the old iptables - very insecure settings</h3>
<div class="highlight"><pre><span></span><code>iptables -F
iptables --delete-chain
iptables -t nat -F
iptables -t mangle -F

iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
</code></pre></div>
<blockquote>
<p>Flush out all of the iptables and delete all of the chains (including the nat and mangle tables)
Set the default policies to accept all packets</p>
</blockquote>
<h3 id="allow-ssh-ping-and-established-but-block-all-by-default">Allow SSH, ping, and Established but block all by default</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
iptables -I INPUT <span class="m">1</span> -i lo -j ACCEPT
iptables -I OUTPUT <span class="m">1</span> -o lo -j ACCEPT
&gt; Always allow the loopback device

iptables -A INPUT -p tcp --dport <span class="m">22</span> -j ACCEPT
iptables -A OUTPUT -p tcp --sport <span class="m">22</span> -j ACCEPT
&gt; allow SSH server to accept connections

iptables -A INPUT -i eth1 -p tcp --dport <span class="m">22</span> -j ACCEPT
iptables -A OUTPUT -o eth1 -p tcp --sport <span class="m">22</span> -j ACCEPT
&gt; ssh server on eth1 on port <span class="m">22</span>

iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
&gt; default to block all traffic

iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
&gt; Accept packets belonging to established and related connections

iptables -A INPUT -i eth1 -p icmp --icmp-type echo-request -j ACCEPT
&gt; Allow incoming ping requests from eth1 , echo-request <span class="o">=</span> <span class="m">8</span> <span class="k">in</span> numeric

iptables -A OUTPUT -o eth1 -p icmp --icmp-type echo-reply -j ACCEPT
&gt; Allow outgoing ping replies to eth1 , <span class="nb">echo</span> <span class="nv">reply</span> <span class="o">=</span> <span class="m">0</span> <span class="k">in</span> numeric
</code></pre></div>
<hr/>
<div class="highlight"><pre><span></span><code>cat /proc/sys/net/ipv4/ip_forward
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</code></pre></div>
<blockquote>
<p>enable packet forwarding by the kernel, required to enable routing (especially with dual nics)</p>
</blockquote>
<h3 id="bash-script-to-set-iptables-during-initd">bash script to set iptables during init.d</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># script to set the initial firewall state as very restrictive</span>
<span class="c1"># chmod +x SCRIPTNAME.sh</span>
<span class="c1"># cd /etc/init.d</span>
<span class="c1"># sudo update-rc.d SCRIPTNAME.sh defaults</span>
<span class="c1"># sudo update-rc.d -f SCRIPTNAME.sh remove</span>
<span class="c1"># or add it to /etc/rc.d/rc.local (which runs once after all other scripts)</span>

<span class="c1"># clear any existing firewall</span>
iptables -F
iptables -X
iptables -F -t mangle
iptables -F -t nat
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP

<span class="c1"># Protect against SYN flood attacks (see http://cr.yp.to/syncookies.html).</span>
<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/tcp_syncookies

<span class="c1"># Allow loopback</span>
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

<span class="c1"># Allow DNS queries</span>
iptables -A OUTPUT -p udp --dport <span class="m">53</span> -m state --state NEW -j ACCEPT
iptables -A INPUT -p udp --sport <span class="m">53</span> --dport <span class="m">1024</span>:65535  -m state --state ESTABLISHED -j ACCEPT

<span class="c1"># Allow NTP (query time server)</span>
iptables -A INPUT -p udp --dport <span class="m">123</span> -j ACCEPT
iptables -A OUTPUT -p udp --sport <span class="m">123</span> -j ACCEPT

<span class="c1"># Allow SSH on port 22</span>
iptables -A INPUT -p tcp --dport <span class="m">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport <span class="m">22</span> -m state --state NEW,ESTABLISHED -j ACCEPT

<span class="c1"># Allow incoming HTTPS</span>
iptables -A INPUT -p tcp -s <span class="m">0</span>/0 --sport <span class="m">1024</span>:65535 --dport <span class="m">443</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s <span class="m">0</span>/0 --sport <span class="m">443</span> --dport <span class="m">1024</span>:65535 -m state --state ESTABLISHED -j ACCEPT

<span class="c1"># Allow outgoing HTTPS (note state for INPUT is only ESTABLISHED)</span>
iptables -A OUTPUT -p tcp --dport <span class="m">443</span> -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp -s <span class="m">0</span>/0 --sport <span class="m">443</span> --dport <span class="m">1024</span>:65535 -m state --state ESTABLISHED -j ACCEPT
</code></pre></div>
<h3 id="web-server">Web Server</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
iptables -F
iptables --delete-chain
iptables -t nat -F
iptables -t mangle -F

iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

<span class="c1"># LOOPBACK 127.0.0.1</span>
iptables -I INPUT <span class="m">1</span> -i lo -j ACCEPT
iptables -I OUTPUT <span class="m">1</span> -o lo -j ACCEPT

<span class="c1"># SSH</span>
iptables -A INPUT -p tcp --dport <span class="m">22</span> -j ACCEPT
iptables -A OUTPUT -p tcp --sport <span class="m">22</span> -j ACCEPT

<span class="c1"># NTP</span>
iptables -A INPUT -p udp --dport <span class="m">123</span> -j ACCEPT
iptables -A OUTPUT -p udp --sport <span class="m">123</span> -j ACCEPT

<span class="c1"># DNS</span>
iptables -A OUTPUT -p udp --dport <span class="m">53</span> -m state --state NEW -j ACCEPT
iptables -A INPUT -p udp --sport <span class="m">53</span> --dport <span class="m">1024</span>:65535  -m state --state ESTABLISHED -j ACCEPT

<span class="c1"># HTTP</span>
iptables -A INPUT -p tcp --dport <span class="m">80</span> -j ACCEPT
iptables -A OUTPUT -p tcp --sport <span class="m">80</span> -j ACCEPT


<span class="c1"># DROP ALL UNDEFINED PACKETS</span>
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP

<span class="c1"># PING</span>
<span class="c1"># iptables -A INPUT -p icmp -m limit --limit 6/second -j ACCEPT</span>
<span class="c1"># iptables -A OUPUT -p icmp -j ACCEPT</span>
</code></pre></div>
<h3 id="web-and-xmpp-server">Web and XMPP Server</h3>
<p><code>vi /etc/iptables.rules.xmpp</code></p>
<div class="highlight"><pre><span></span><code>*filter
:INPUT DROP <span class="o">[</span><span class="m">3</span>:572<span class="o">]</span>
:FORWARD DROP <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
:OUTPUT ACCEPT <span class="o">[</span><span class="m">10</span>:1744<span class="o">]</span>
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m state --state NEW -j DROP
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">22</span> -m state --state NEW -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">80</span> -m state --state NEW -j ACCEPT
-A INPUT -p udp -m udp --dport <span class="m">161</span> -m state --state NEW -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">443</span> -m state --state NEW -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">5222</span> -m state --state NEW -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">5223</span> -m state --state NEW -j ACCEPT
-A INPUT -p udp -m udp --dport <span class="m">137</span> -j ACCEPT
-A INPUT -p udp -m udp --dport <span class="m">138</span> -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type <span class="m">8</span> -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type <span class="m">11</span> -j ACCEPT
-A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport <span class="m">22</span> -m state --state NEW -j ACCEPT
-A OUTPUT -p udp -m udp --dport <span class="m">53</span> -m state --state NEW -j ACCEPT
-A OUTPUT -p udp -m udp --sport <span class="m">161</span> -m state --state NEW -j ACCEPT
-A OUTPUT -m state --state NEW -j LOG
COMMIT
</code></pre></div>
<p><code>iptables-restore &lt; /etc/iptables.rules.xmpp</code></p>
<hr/>
<h3 id="ntp">NTP</h3>
<p><em>Getting the time and date synchronized through a restricted firewall</em></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># ntpdate port 123</span>
iptables -A INPUT -p udp --dport <span class="m">123</span> -j ACCEPT
iptables -A OUTPUT -p udp --sport <span class="m">123</span> -j ACCEPT

<span class="c1"># variation where rules are inserted as first items in the Tables</span>
<span class="c1"># iptables -I INPUT 1 -p udp --dport 123 -j ACCEPT</span>
<span class="c1"># iptables -I OUTPUT 1 -p udp --sport 123 -j ACCEPT</span>
</code></pre></div>
</td></tr></table>
<blockquote>
<p>Installing NTP...</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nv">sudo</span> <span class="nv">apt</span><span class="o">-</span><span class="nv">get</span> <span class="nv">install</span> <span class="nv">ntp</span>
<span class="nv">nano</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">ntp</span>.<span class="nv">conf</span>
<span class="nv">server</span> <span class="nv">ntp</span>.<span class="nv">ubuntu</span>.<span class="nv">com</span>
<span class="nv">server</span> <span class="nv">pool</span>.<span class="nv">ntp</span>.<span class="nv">org</span>

<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">ntp</span> <span class="nv">restart</span>
<span class="nv">ls</span> <span class="o">-</span><span class="nv">ahl</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">cron</span>.<span class="nv">daily</span>   <span class="o">&gt;</span> <span class="nv">verify</span> <span class="nv">that</span> <span class="nv">ntp</span> <span class="nv">is</span> <span class="o">+</span><span class="nv">x</span> <span class="nv">executable</span>
<span class="nv">ntpq</span> <span class="o">-</span><span class="nv">p</span>                   <span class="o">&gt;</span> <span class="nv">verify</span> <span class="nv">the</span> <span class="nv">service</span> <span class="nv">is</span> <span class="nv">working</span>

<span class="o">&gt;</span> <span class="nv">MANUAL</span> <span class="o">=</span> <span class="nv">ntpdate</span> <span class="nv">pool</span>.<span class="nv">ntp</span>.<span class="nv">org</span> <span class="nv">will</span> <span class="nv">now</span> <span class="k">return</span> <span class="nv">socket</span> <span class="mi">123</span> <span class="nv">is</span> <span class="nv">in</span> <span class="nv">use</span>
</code></pre></div>
<hr/>
<h3 id="nat-forwarding">NAT forwarding</h3>
<div class="highlight"><pre><span></span><code>iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</code></pre></div>
<blockquote>
<p>assuming that eth0 is your WAN and eth1 is your LAN</p>
<p>accept all forwarding from eth1 to eth0 and back</p>
<p>enable "nat" so that packets are addressed properly</p>
</blockquote>
<hr/>
<h3 id="cifs">CIFS</h3>
<div class="highlight"><pre><span></span><code><span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">10</span>.<span class="mi">10</span>.<span class="mi">10</span>.<span class="mi">250</span> <span class="o">--</span><span class="nv">sport</span> <span class="mi">445</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">0</span><span class="o">/</span><span class="mi">0</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">OUTPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">0</span><span class="o">/</span><span class="mi">0</span> <span class="o">--</span><span class="nv">sport</span> <span class="mi">1024</span>:<span class="mi">65535</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">10</span>.<span class="mi">10</span>.<span class="mi">10</span>.<span class="mi">250</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">445</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> <span class="o">--</span><span class="nv">state</span> <span class="nv">NEW</span>,<span class="nv">ESTABLISHED</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>
<span class="o">&gt;</span> <span class="nv">CIFS</span> <span class="nv">has</span> <span class="nv">been</span> <span class="nv">simplified</span> <span class="nv">to</span> <span class="nv">just</span> <span class="nv">use</span> <span class="mi">445</span> <span class="nv">TCP</span> <span class="nv">first</span>...

<span class="nv">netbios</span><span class="o">-</span><span class="nv">ns</span> <span class="o">-</span> <span class="mi">137</span><span class="o">/</span><span class="nv">tcp</span> # <span class="nv">NETBIOS</span> <span class="nv">Name</span> <span class="nv">Service</span>
<span class="nv">netbios</span><span class="o">-</span><span class="nv">dgm</span> <span class="o">-</span> <span class="mi">138</span><span class="o">/</span><span class="nv">tcp</span> # <span class="nv">NETBIOS</span> <span class="nv">Datagram</span> <span class="nv">Service</span>
<span class="nv">netbios</span><span class="o">-</span><span class="nv">ssn</span> <span class="o">-</span> <span class="mi">139</span><span class="o">/</span><span class="nv">tcp</span> # <span class="nv">NETBIOS</span> <span class="nv">session</span> <span class="nv">service</span>
<span class="nv">microsoft</span><span class="o">-</span><span class="nv">ds</span> <span class="o">-</span> <span class="mi">445</span><span class="o">/</span><span class="nv">tcp</span> # <span class="k">if</span> <span class="nv">you</span> <span class="nv">are</span> <span class="nv">using</span> <span class="nv">Active</span> <span class="nv">Directory</span>
</code></pre></div>
<h3 id="allow-ad-lookups-ldapldaps">Allow AD Lookups LDAP/LDAPS</h3>
<div class="highlight"><pre><span></span><code>iptables -A INPUT -p tcp -s 0/0 --sport 1024:65535 --dport 389 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s 0/0 --sport 389 --dport 1024:65535 -m state --state ESTABLISHED -j ACCEPT

iptables -A OUTPUT -p tcp --dport 389 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp -s 0/0 --sport 389 --dport 1024:65535 -m state --state ESTABLISHED -j ACCEPT

iptables -A INPUT -p tcp -s 0/0 --sport 1024:65535 --dport 636 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s 0/0 --sport 636 --dport 1024:65535 -m state --state ESTABLISHED -j ACCEPT

iptables -A OUTPUT -p tcp --dport 636 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp -s 0/0 --sport 636 --dport 1024:65535 -m state --state ESTABLISHED -j ACCEPT
</code></pre></div>
<hr/>
<h3 id="dmz-setup-with-dual-nic">DMZ Setup with dual nic</h3>
<ul>
<li>ATMOS = 10.10.254.195</li>
<li>LAN (router?) =  10.10.254.1</li>
<li>eth0 = LAN  10.10.254.254</li>
<li>eth1 = WAN 172.16.255.254</li>
<li>eth2 = DMZ  192.168.50.1</li>
<li>Router 172.16.255.1</li>
</ul>
<h4 id="forward-traffic-between-dmz-and-lan">forward traffic between DMZ and LAN</h4>
<div class="highlight"><pre><span></span><code>iptables -A FORWARD -i eth0 -o eth2 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i eth2 -o eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
</code></pre></div>
<blockquote>
<p>forward traffic between DMZ and WAN servers SMTP, Mail etc</p>
</blockquote>
<div class="highlight"><pre><span></span><code>iptables -A FORWARD -i eth2 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i eth1 -o eth2 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
</code></pre></div>
<blockquote>
<p>Route incoming SMTP (port 25 ) traffic to DMZ server 192.168.2.2
    iptables -t nat -A PREROUTING -p tcp -i eth1 -d 202.54.1.1 --dport 25 -j DNAT --to-destination 192.168.2.2</p>
<p>Route incoming HTTP (port 80 ) traffic to DMZ server load balancer IP 192.168.2.3
    iptables -t nat -A PREROUTING -p tcp -i eth1 -d 202.54.1.1 --dport 80 -j DNAT --to-destination 192.168.2.3</p>
<p>Route incoming HTTPS (port 443 ) traffic to DMZ server reverse load balancer IP 192.168.2.4
    iptables -t nat -A PREROUTING -p tcp -i eth1 -d 202.54.1.1 --dport 443 -j DNAT --to-destination 192.168.2.4</p>
<p>End DMZ .. Add other rules</p>
</blockquote>
<h2 id="uncomplicated-firewall-ufw">Uncomplicated Firewall UFW</h2>
<p>The uncomplicated firewall is a much simpler way to configure some basic rules and enable the firewall</p>
<div class="highlight"><pre><span></span><code>sudo su
ufw status verbose
ufw allow 22
ufw allow 443
ufw default deny incoming
ufw default deny outgoing
ufw enable
ufw status verbose
</code></pre></div>
<blockquote>
<p>Allowing 22 (SSH) and 443 (HTTPS) and denying all other incoming and outgoing traffic</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="nv">ufw</span> <span class="nv">delete</span> <span class="nv">allow</span> <span class="mi">443</span>
<span class="nv">ufw</span> <span class="k">show</span> <span class="nv">raw</span>
<span class="nv">ufw</span> <span class="nv">disable</span>
</code></pre></div>
<blockquote>
<p>removing a rule is as simple as prefixing the allow or deny command with delete
disabling the firewall allows all traffic</p>
</blockquote>
<p>Most unfortunately there are some basic gaps that make it not very production ready (i.e. if you know what you are doing just keep using iptables)
1. ping, also known as icmp, packets (even just outbound) have to be handled in a very complex way, really not much better than iptables
1. established connection traffic is not just easily allowed
1. attempting to do something more complex very quickly requires very complex commands including just using iptables (lolwut)
1. iptables -nvL becomes almost unreadable with the extra layer</p>
<p><a href="https://wiki.ubuntu.com/UncomplicatedFirewall">https://wiki.ubuntu.com/UncomplicatedFirewall</a></p>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/seo-search-engine-optimization-by-john-pfeiffer/" title="Previous: SEO Search Engine Optimization by John Pfeiffer">SEO Search Engine Optimization by John Pfeiffer</a></li>
 
                <li class="next_article"><a href="https://blog.john-pfeiffer.com/network-ifconfig-ifcfg-static-and-dhcp-eth0-route-wifi-wpa/" title="Next: Network ifconfig ifcfg static and dhcp eth0 route wifi wpa">Network ifconfig ifcfg static and dhcp eth0 route wifi wpa</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2009-01-01T00:00:00-08:00">Jan 1, 2009</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#linux-ref">linux</a> 
            <h4>~1799 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#firewall-ref">firewall
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#iptables-ref">iptables
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#linux-ref">linux
                    <span>11</span>
</a></li>
                <li><a href="/tags.html#NAT-ref">NAT
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#ufw-ref">ufw
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
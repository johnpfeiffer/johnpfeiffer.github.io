<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="security, encryption, aes, https, openssl, certbot, ssh, keygen, openvpn, vpn, letsencrypt, certbot, it, " />
        <title>Security Encryption HTTPS OpenSSL SSH Keygen VPN Letsencrypt Certbot Â· johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/security-encryption-https-openssl-ssh-keygen-vpn-letsencrypt-certbot/"> Security Encryption HTTPS OpenSSL SSH Keygen VPN Letsencrypt Certbot </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#symmetric-and-asymmetric-encryption">Symmetric and Asymmetric Encryption</a><ul>
<li><a href="#pretty-good-encryption-for-pretty-good-privacy">Pretty Good Encryption for Pretty Good Privacy</a><ul>
<li><a href="#gpg-encryption">GPG Encryption</a></li>
</ul>
</li>
<li><a href="#gpg-decryption">GPG Decryption</a></li>
<li><a href="#aes-256-encryption">AES 256 Encryption</a></li>
</ul>
</li>
<li><a href="#generating-ssl-certificates-and-private-and-public-keys">Generating SSL Certificates and Private and Public Keys</a><ul>
<li><a href="#more-private-and-public-key-basics-for-ssl-certificates">More Private and Public Key basics for SSL Certificates</a><ul>
<li><a href="#verify-the-ssl-certificate-and-private-key-match">Verify the SSL Certificate and Private Key match</a></li>
<li><a href="#verify-the-cert-and-intermediate-match-and-then-verify">Verify the Cert and Intermediate match and then Verify</a></li>
<li><a href="#verify-a-csr-matches-the-key-and-certificate">Verify a CSR matches the Key and Certificate</a></li>
</ul>
</li>
<li><a href="#creating-keys-and-certificates-and-certificate-requests">Creating keys and certificates and certificate requests</a><ul>
<li><a href="#openssl-new-key-and-cert-one-liner">openssl New Key and Cert One Liner</a></li>
<li><a href="#openssl-certificate-commands">openssl certificate commands</a></li>
<li><a href="#creating-an-rsa-certificate-with-a-password">Creating an RSA certificate with a password</a></li>
<li><a href="#remove-a-passphrase-to-install-a-private-key-on-a-server">Remove a passphrase to install a private key on a server</a></li>
</ul>
</li>
<li><a href="#use-openssls-built-in-webserver">Use openssl's built in webserver</a><ul>
<li><a href="#get-a-remote-server-ssl-certificate-using-openssl-and-sed">Get a remote server ssl certificate using openssl and sed</a></li>
<li><a href="#getting-and-verifying-an-intermediate-certificate">Getting and verifying an Intermediate Certificate</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#other-certificate-formats">Other certificate formats</a><ul>
<li><a href="#convert-from-windows-iis-pkcs12-or-pfx-to-pem">CONVERT FROM WINDOWS (IIS) PKCS12 OR PFX TO PEM</a></li>
<li><a href="#configure-an-existing-key-certificate-into-pkcs12">Configure an existing key + certificate into PKCS12</a></li>
</ul>
</li>
<li><a href="#keytool-and-java-key-stores">KEYTOOL AND JAVA KEY STORES</a><ul>
<li><a href="#import-a-signed-primary-certificate-to-an-existing-java-keystore">Import a signed primary certificate to an existing Java keystore</a></li>
<li><a href="#extract-a-certificate-from-a-jks-into-a-der-then-convert-it-into-a-pem-and-import-into-the-jvm-cacerts">EXTRACT A CERTIFICATE FROM A JKS INTO A .DER, THEN CONVERT IT INTO A .PEM AND IMPORT INTO THE JVM cacerts</a></li>
</ul>
</li>
<li><a href="#ssh-encryption">SSH Encryption</a><ul>
<li><a href="#create-a-publicprivate-key-pair-for-ssh">Create a public/private key pair for SSH</a><ul>
<li><a href="#output-a-pub-from-a-private-key">output a .pub from a private key</a></li>
<li><a href="#generate-a-fingerprint-for-verification-of-a-host">generate a fingerprint for verification of a host</a></li>
<li><a href="#amazon-ec2-instances-have-a-different-method-ec2-add-keypair">AMAZON ec2 instances have a different method, ec2-add-keypair</a></li>
<li><a href="#ec2-import-keypair">ec2-import-keypair:</a></li>
</ul>
</li>
<li><a href="#adding-a-public-key-to-a-remote-server">Adding a Public Key to a remote server</a><ul>
<li><a href="#connecting-with-ssh-client-to-a-remote-server">Connecting with SSH client to a remote server</a></li>
<li><a href="#ssh-ignore-strict-hosts-checking">SSH ignore strict hosts checking</a></li>
<li><a href="#ssh-agent-forwarding">SSH Agent Forwarding</a></li>
<li><a href="#ssh-tcp-tunnel">SSH TCP tunnel</a><ul>
<li><a href="#use-a-docker-container-to-isolate-the-vpn-software-and-instead-only-allow-an-ssh-tunnel-as-a-web-proxy">Use a docker container to isolate the VPN software and instead only allow an SSH tunnel as a web proxy</a></li>
<li><a href="#configure-firefox-to-use-the-socks-host">Configure Firefox to use the SOCKS Host</a></li>
<li><a href="#configure-firefox-to-use-the-socks5-proxy-for-dns">Configure Firefox to use the socks5 proxy for DNS</a></li>
</ul>
</li>
<li><a href="#ssh-tunnel-for-windows-rdp">SSH tunnel for Windows RDP</a></li>
<li><a href="#ssh-tunneling-in-general">ssh tunneling in general</a><ul>
<li><a href="#ssh-tunnel-on-port-9090-cherokee-admin">ssh tunnel on port 9090 (cherokee-admin)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#virtual-private-networks-and-openvpn">Virtual Private Networks and openVPN</a><ul>
<li><a href="#docker-openvpn">Docker OpenVPN</a></li>
<li><a href="#digital-ocean-openvpn">Digital Ocean OpenVPN</a><ul>
<li><a href="#dedicated-ssh-user">Dedicated SSH User</a></li>
<li><a href="#more-hardening">More Hardening</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#configure-openvpn">Configure openvpn</a></li>
</ul>
</li>
<li><a href="#connect-a-client-to-the-openvpn-server">Connect a client to the OpenVPN server</a><ul>
<li><a href="#openvpn-client-config-infrastructure-on-the-remote-server">OpenVPN client config infrastructure on the remote server</a></li>
<li><a href="#once-you-have-the-configuration">Once you have the configuration</a></li>
<li><a href="#import-a-ovpn-config-file-into-ubuntu-network-manager">Import a .ovpn config file into ubuntu network manager</a><ul>
<li><a href="#connect-to-a-vpn-from-the-cli">Connect to a VPN from the CLI</a></li>
</ul>
</li>
<li><a href="#dns-security">DNS Security</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#letsencrypt-and-certbot-for-free-ssl-certificates">Letsencrypt and certbot for free SSL Certificates</a><ul>
<li><a href="#create-a-free-ssl-cert-with-certbot-in-docker">Create a free SSL cert with certbot in docker</a></li>
<li><a href="#renew-your-ssl-certificate-with-certbot-and-cron">Renew your SSL certificate with certbot and cron</a></li>
</ul>
</li>
<li><a href="#cryptography-exercises">Cryptography Exercises</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<p>As our lives become increasingly monitored and digital the privacy of being unobserved or having a private conversation that we used to be able to take for granted now requires extra effort.  The more people who choose to use these easy and readily available tools the more privacy will become the standard rather than the exception.</p>
<h1 id="symmetric-and-asymmetric-encryption">Symmetric and Asymmetric Encryption</h1>
<p>Using a shared secret key is generally the simplest way to encrypt, both parties use the same key to encrypt and decrypt.</p>
<p>Asymmetric encryption (aka "public and private key") allows for a message to be encrypted without the parties having to meet or exchange a secret.</p>
<p>Both are often used together in a complementary fashion.</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Public-key_cryptography">https://en.wikipedia.org/wiki/Public-key_cryptography</a></li>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">https://en.wikipedia.org/wiki/Transport_Layer_Security</a></li>
</ul>
<p>Codes and the ability to communicate in secret have a very long history which many others have documented and thanks to the amazing efforts of many many people we have the ability to communicate our billions of messages with relative privacy.</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/History_of_cryptography#Modern_cryptography">https://en.wikipedia.org/wiki/History_of_cryptography#Modern_cryptography</a></li>
<li><a href="https://www.goodreads.com/book/show/984428.Crypto">https://www.goodreads.com/book/show/984428.Crypto</a> (Steven Levy)</li>
</ul>
<p>It is important to understand that good encryption depends on randomness to make it as hard as possible for an "attacker" to reverse engineer or guess the key, i.e. <a href="https://en.wikipedia.org/wiki//dev/random">https://en.wikipedia.org/wiki//dev/random</a></p>
<p>The following is my summary of some of the most common and useful tools...</p>
<h2 id="pretty-good-encryption-for-pretty-good-privacy">Pretty Good Encryption for Pretty Good Privacy</h2>
<p>While there is a lot of value in leveraging the GPG public and private keys for authenticity checking this is just about encrypted data...</p>
<h3 id="gpg-encryption">GPG Encryption</h3>
<div class="highlight"><pre><span></span><span class="err">gpg -c example.tar.gz</span>
</pre></div>
<blockquote>
<p>prompts for a password to access the keyring and leverages existing (or automatically generates) public and private keys, and outputs example.tar.gz.gpg</p>
</blockquote>
<p><strong>Note: encrypting before compressing is meaningless since encrypted data is random and compression depends on repetition/patterns</strong></p>
<div class="highlight"><pre><span></span><span class="err">gpg --yes --passphrase=password -c example.txt</span>
</pre></div>
<blockquote>
<p>non interactive encryption (if the private key is password protected), outputs example.txt.gpg</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">echo "password" | gpg --yes --no-tty --batch --passphrase-fd 0 --output encrypted.txt.gpg  --symmetric --cipher-algo AES256 plain.txt</span>
</pre></div>
<blockquote>
<p>non interactive AES 256 symmetric cipher rather than public/private keypairs</p>
</blockquote>
<h2 id="gpg-decryption">GPG Decryption</h2>
<div class="highlight"><pre><span></span><span class="err">gpg example.tar.gz.gpg</span>
</pre></div>
<blockquote>
<p>enter the passphrase to access the private key to decrypt the file</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">gpg --yes --passphrase=password example.txt.gpg</span>
</pre></div>
<blockquote>
<p>non-interactively access the private key to decrypt the file</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">echo "password" | gpg --yes --no-tty --batch --passphrase-fd 0 --output plain.txt --decrypt encrypted.txt.gpg</span>
</pre></div>
<blockquote>
<p>non interactively decrypt with symmetric encryption</p>
</blockquote>
<p><em>Do not pick password as your password ;p</em></p>
<p><a href="https://www.gnupg.org/gph/en/manual/x110.html">https://www.gnupg.org/gph/en/manual/x110.html</a></p>
<h2 id="aes-256-encryption">AES 256 Encryption</h2>
<p>AdvancedEncryptionStandard is one of the US and world standards as an encryption algorithm.</p>
<p>Security benefits from transparency in that if you provide the algorithm and source code in plain sight and attackers are still unable to decrypt/crack/manipulate the data then you are probably in good shape.</p>
<p>Perhaps one of the most well known projects (open source and free!) to advance the practice of encryption is <a href="https://www.openssl.org/">https://www.openssl.org/</a></p>
<p>Here we encrypt and decrypt a text file:</p>
<div class="highlight"><pre><span></span><span class="err">openssl aes-256-cbc -in plain.txt -out message.encrypted</span>
</pre></div>
<blockquote>
<p>prompted for a password (symmetric key) to encrypt the file with AES 256</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl aes-256-cbc -d -in message.encrypted -out plain.txt</span>
</pre></div>
<blockquote>
<p>prompted for a password to decrypt the message</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl aes-256-cbc -in plain.txt -out message.encrypted -pass pass:YOURPASSWORD</span>
</pre></div>
<blockquote>
<p>non-interactively provide the password to encrypt the file with AES 256</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl aes-256-cbc -d -in message.encrypted -out plain.txt -pass pass:YOURPASSWORD</span>
</pre></div>
<blockquote>
<p>non-interactively provide the password to decrypt the file with AES 256</p>
</blockquote>
<p><em>an incorrect password will create a zero byte file</em></p>
<div class="highlight"><pre><span></span><span class="err">openssl aes-256-cbc -a -d -in message.encrypted -out plain.txt</span>
</pre></div>
<blockquote>
<p>if it's base64 encoded do not forget the -a</p>
</blockquote>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">https://en.wikipedia.org/wiki/Advanced_Encryption_Standard</a></li>
<li><a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation</a></li>
<li><a href="https://www.openssl.org/docs/manmaster/man1/openssl.html">https://www.openssl.org/docs/manmaster/man1/openssl.html</a></li>
</ul>
<h1 id="generating-ssl-certificates-and-private-and-public-keys">Generating SSL Certificates and Private and Public Keys</h1>
<p>Perhaps the most common use of TLS/SSL are the keys used to encrypt communication with a web server, these examples use a "self signed certificate" which most libraries and browsers will not trust.</p>
<blockquote>
<p>"Root Certificate Authorities" are the ones you send a "Certificate Signing Request" to generate a certificate that can be mathemetically trusted by the existing software libraries and browsers</p>
</blockquote>
<h2 id="more-private-and-public-key-basics-for-ssl-certificates">More Private and Public Key basics for SSL Certificates</h2>
<p>The private key contains a series of numbers. Two of those numbers form the "public key", the others are part of your "private key".</p>
<p>The "public key" bits are also embedded in your Certificate (we get them from your CSR - certificate signing request).</p>
<h3 id="verify-the-ssl-certificate-and-private-key-match">Verify the SSL Certificate and Private Key match</h3>
<div class="highlight"><pre><span></span><span class="err">(openssl x509 -noout -modulus -in server.pem | openssl md5 ; openssl rsa -noout -modulus -in server.key | openssl md5) | uniq</span>
</pre></div>
<blockquote>
<p>outputs a single hash if matching, if two hashes are output then it is not unique and the key and cert do not match</p>
</blockquote>
<p>To check that the public key in your cert matches the public portion of your private key:</p>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -noout -text -in server.crt</span>
<span class="err">openssl rsa -noout -text -in server.key</span>
</pre></div>
<p>But since the public exponent is usually 65537 and it's challening to compare a long modulus you can use the following approach:</p>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -noout -modulus -in server.crt | openssl md5</span>
<span class="err">openssl rsa -noout -modulus -in server.key | openssl md5</span>
</pre></div>
<blockquote>
<p>the "modulus" and the "public exponent" portions of the cert and key ... aka the two md5sum hashes should match</p>
</blockquote>
<h3 id="verify-the-cert-and-intermediate-match-and-then-verify">Verify the Cert and Intermediate match and then Verify</h3>
<div class="highlight"><pre><span></span><span class="err">openssl verify -purpose sslserver -CAfile intermediate.pem -verbose server.pem</span>
</pre></div>
<blockquote>
<p>ensure the intermediate certificate matches the SSL certificate (if it does not SSL trust will not work correctly)</p>
</blockquote>
<h3 id="verify-a-csr-matches-the-key-and-certificate">Verify a CSR matches the Key and Certificate</h3>
<p>To check to which key or certificate a particular CSR belongs you can compute</p>
<div class="highlight"><pre><span></span><span class="err">openssl req -noout -modulus -in server.csr | openssl md5</span>
</pre></div>
<h2 id="creating-keys-and-certificates-and-certificate-requests">Creating keys and certificates and certificate requests</h2>
<h3 id="openssl-new-key-and-cert-one-liner">openssl New Key and Cert One Liner</h3>
<div class="highlight"><pre><span></span><span class="err">openssl req -subj '/CN=example.com/O=My Company Name LTD./C=US' -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout server.key -out server.crt</span>
</pre></div>
<blockquote>
<p>one liner to generate a self signed SSL key and certificate, since SSL certs are rotated regularly we can use 2048 instead of 4096 bits</p>
</blockquote>
<h3 id="openssl-certificate-commands">openssl certificate commands</h3>
<div class="highlight"><pre><span></span><span class="err">openssl req -out CSR.csr -new -newkey rsa:2048 -nodes -keyout privateKey.key</span>
</pre></div>
<blockquote>
<p>create 2048 bit nopass key + csr (certificate signing request - usually sent to a Certificate Authority that is in the root chain bundled with major browsers and libraries)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -req -days 365 -in CSR.csr -signkey privateKey.key -out cert.crt</span>
</pre></div>
<blockquote>
<p>self sign a CSR and generate a self signed SSL certificate</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl rsa -in mykey.pem -pubout</span>
</pre></div>
<blockquote>
<p>display the public key generated from the private key</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl rsa -in mykey.pem -pubout -out mykey.pub</span>
</pre></div>
<blockquote>
<p>use the private key to generate and save the public key to a file</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl req -text -noout -verify -in CSR.csr</span>
</pre></div>
<blockquote>
<p>Verify a CSR certificate request</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl rsa -check -in cert.key</span>
</pre></div>
<blockquote>
<p>Verify a key</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -text -in cert.crt</span>
</pre></div>
<blockquote>
<p>View INFO about a cert and see the cert</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -noout -issuer -subject -dates -in cert.crt</span>
</pre></div>
<blockquote>
<p>View specific items in the certificate (and do not print out the full certificate)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl req -out CSR.csr -key privateKey.key -new</span>
</pre></div>
<blockquote>
<p>Generate a certificate signing request (CSR) for an existing private key</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -x509toreq -in certificate.crt -out CSR.csr -signkey privateKey.key</span>
</pre></div>
<blockquote>
<p>Generate a certificate signing request based on an existing certificate and private key</p>
</blockquote>
<h3 id="creating-an-rsa-certificate-with-a-password">Creating an RSA certificate with a password</h3>
<div class="highlight"><pre><span></span><span class="err">openssl genrsa -des3 -out domainname.key 2048</span>
</pre></div>
<blockquote>
<p>Create a 2048 bit private key with passphrase</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl req -new -key domainname.key -out domainname.csr</span>
</pre></div>
<blockquote>
<p>CREATE A CSR, CEERTIFICATE SIGNED REQUEST</p>
</blockquote>
<p>Common Name (domain name) = fully qualified domain name</p>
<div class="highlight"><pre><span></span><span class="err">openssl x509 -req -days 365 -in CSR.csr -signkey privateKey.key -out cert.crt</span>
</pre></div>
<blockquote>
<p>Generate a self signed cert</p>
</blockquote>
<h3 id="remove-a-passphrase-to-install-a-private-key-on-a-server">Remove a passphrase to install a private key on a server</h3>
<div class="highlight"><pre><span></span><span class="err">openssl rsa -in domainname-passphrase.key -out domainname-server.key</span>
</pre></div>
<p>OR</p>
<div class="highlight"><pre><span></span><span class="err">openssl rsa -in privateKey.pem -out newPrivateKey.pem</span>
</pre></div>
<h2 id="use-openssls-built-in-webserver">Use openssl's built in webserver</h2>
<div class="highlight"><pre><span></span><span class="err">openssl s_server -cert server.pem -key server-nopass.key</span>
</pre></div>
<blockquote>
<p>start a TCP server with the provided certificate and key on the default port of 4433</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl s_server -cert server.pem -accept 4433 -www</span>
</pre></div>
<blockquote>
<p>start an HTTPS server with the cert and key combined in a .pem on the specific port (e.g. 4433)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">telnet localhost 4433</span>
</pre></div>
<blockquote>
<p>verify basic network connectivity</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">wget https://localhost:4433 --no-check-certificate</span>
</pre></div>
<blockquote>
<p>verify basic network connectivity and download the contents without validating the SSL certificate</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl s_client -showcerts -connect localhost:4433</span>
</pre></div>
<blockquote>
<p>show the ciphers and certificates of a server, "18 (self signed certificate)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">openssl s_client -connect ldaps.example.com:10636 -CAfile intermediate.crt</span>
</pre></div>
<blockquote>
<p>show the ciphers and certificates of a server while providing client-side the Root + Intermediate Chain certificates</p>
</blockquote>
<h3 id="get-a-remote-server-ssl-certificate-using-openssl-and-sed">Get a remote server ssl certificate using openssl and sed</h3>
<div class="highlight"><pre><span></span>echo | openssl s_client -connect <span class="cp">${</span><span class="n">REMOTEHOST</span><span class="cp">}</span>:<span class="cp">${</span><span class="n">REMOTEPORT</span><span class="cp">}</span> 2&gt;<span class="err">&amp;</span>1 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'
</pre></div>
<h3 id="getting-and-verifying-an-intermediate-certificate">Getting and verifying an Intermediate Certificate</h3>
<p>Popular web browsers will often have lock symbols or other ways for you to see (and download) a certificate)</p>
<ol>
<li>startup vm with webserver (tomcat) + current certificate</li>
<li>chrome browse to the https://10.10.10.199</li>
<li>Click on the lock (certificate) symbol =&gt; Certificate information  "Issued to: example.com"</li>
<li>Click on the Certification Path (tab) ... see the root CA + intermediates + cert.</li>
<li>click on "GeoTrust" (or the top level Certificate listed in the path) -&gt; View Certificate</li>
<li>Details (tab) -&gt; Copy to File -&gt; Save Base-64 encoded x.509 (.cer)</li>
<li>Verify that it is different than your original cert.crt</li>
<li>Copy paste that file into a place where you have openssl installed (i.e. ubuntu linux)</li>
<li>Hostfile (/etc/hosts) so that your openssl command can use the DNS name</li>
<li><code>openssl s_client -showcerts -connect example.com:443</code></li>
<li>Without the intermediate you should receive "Verify return code: 21 (unable to verify the first certificate)"</li>
<li><code>openssl s_client -showcerts -connect example.com:443 -CAfile geotrust-intermediate.crt</code></li>
<li>With the intermediate in the command above:   "Verify return code: 0 (ok)"</li>
</ol>
<p>Finally, if the DNS name is publicly available, you can verify: <a href="https://www.sslshopper.com/ssl-checker.html">https://www.sslshopper.com/ssl-checker.html</a></p>
<hr/>
<h1 id="other-certificate-formats">Other certificate formats</h1>
<h2 id="convert-from-windows-iis-pkcs12-or-pfx-to-pem">CONVERT FROM WINDOWS (IIS) PKCS12 OR PFX TO PEM</h2>
<div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="n">info</span> <span class="o">-</span><span class="k">in</span> <span class="n">keystore</span><span class="p">.</span><span class="n">p12</span>

<span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="k">in</span> <span class="n">original</span><span class="p">.</span><span class="n">pfx</span> <span class="o">-</span><span class="k">out</span> <span class="n">cert</span><span class="p">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">nodes</span>
</pre></div>
<blockquote>
<p>This creates both the key and the cert</p>
</blockquote>
<p>You can copy and paste the certificate portion into cert.crt</p>
<p>Also copy and paste the private key portion into the cert.key</p>
<h2 id="configure-an-existing-key-certificate-into-pkcs12">Configure an existing key + certificate into PKCS12</h2>
<div class="highlight"><pre><span></span><span class="err">openssl pkcs12 -export -inkey cert.key -in cert.pem -out keystore.p12</span>
</pre></div>
<hr/>
<h1 id="keytool-and-java-key-stores">KEYTOOL AND JAVA KEY STORES</h1>
<p>Java, just like web servers, have public and private encryption keys in order to enable cryptography and encryption from within the applications.</p>
<div class="highlight"><pre><span></span><span class="err">keytool -list -v -keystore /usr/lib/jvm/java-6-sun-1.6.0.24/jre/lib/security/jssecacerts</span>
</pre></div>
<blockquote>
<p>hit enter as it has no password</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">keytool -list -v -keystore /etc/java-6-sun/security/cacerts</span>
</pre></div>
<blockquote>
<p>default password is changeit</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="n">keytool</span> <span class="o">-</span><span class="n">list</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">java</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">sun</span><span class="o">/</span><span class="k">security</span><span class="o">/</span><span class="n">cacerts</span> <span class="o">-</span><span class="k">alias</span> <span class="n">alpha</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="n">net</span>  <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span>
<span class="n">keytool</span> <span class="o">-</span><span class="n">list</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">keystore</span> <span class="n">jssecacerts</span> <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">atmos</span> <span class="o">-</span><span class="n">n4</span>


<span class="n">Keystore</span> <span class="k">type</span><span class="p">:</span> <span class="n">JKS</span>
<span class="n">Keystore</span> <span class="n">provider</span><span class="p">:</span> <span class="n">SUN</span>

<span class="n">Your</span> <span class="n">keystore</span> <span class="k">contains</span> <span class="mi">76</span> <span class="n">entries</span>

<span class="k">Alias</span> <span class="n">name</span><span class="p">:</span> <span class="n">digicertassuredidrootca</span>
<span class="n">Creation</span> <span class="nb">date</span><span class="p">:</span> <span class="n">Jan</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2008</span>
<span class="n">Entry</span> <span class="k">type</span><span class="p">:</span> <span class="n">trustedCertEntry</span>
</pre></div>
<h3 id="import-a-signed-primary-certificate-to-an-existing-java-keystore">Import a signed primary certificate to an existing Java keystore</h3>
<p>One of the most common tasks is adding a certificate to trust</p>
<div class="highlight"><pre><span></span><span class="n">keytool</span> <span class="o">-</span><span class="kn">import</span> <span class="o">-</span><span class="n">trustcacerts</span> <span class="o">-</span><span class="n">alias</span> <span class="n">mydomain</span> <span class="o">-</span><span class="nb">file</span> <span class="n">mydomain</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">java</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">sun</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">cacerts</span> <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span>
<span class="n">Trust</span> <span class="n">this</span> <span class="n">certificate</span><span class="err">?</span> <span class="p">[</span><span class="n">no</span><span class="p">]:</span>

<span class="nb">type</span> <span class="s2">"yes"</span>

<span class="n">keytool</span> <span class="o">-</span><span class="nb">list</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">java</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">sun</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">cacerts</span> <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span>

<span class="n">keytool</span> <span class="o">-</span><span class="n">printcert</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="nb">file</span> <span class="n">mydomain</span><span class="o">.</span><span class="n">crt</span>

<span class="n">keytool</span> <span class="o">-</span><span class="kn">import</span> <span class="o">-</span><span class="n">trustcacerts</span> <span class="o">-</span><span class="n">alias</span> <span class="n">root</span> <span class="o">-</span><span class="nb">file</span> <span class="n">geotrust</span><span class="o">.</span><span class="n">intermediate</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">java</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">sun</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">cacerts</span> <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span>

<span class="n">keytool</span> <span class="o">-</span><span class="n">delete</span> <span class="o">-</span><span class="n">alias</span> <span class="n">mydomain</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">keystore</span> <span class="n">cacerts</span> <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span>
</pre></div>
<h3 id="extract-a-certificate-from-a-jks-into-a-der-then-convert-it-into-a-pem-and-import-into-the-jvm-cacerts">EXTRACT A CERTIFICATE FROM A JKS INTO A .DER, THEN CONVERT IT INTO A .PEM AND IMPORT INTO THE JVM cacerts</h3>
<div class="highlight"><pre><span></span><span class="n">keytool</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">alias</span> <span class="n">zanzibar</span> <span class="o">-</span><span class="n">keystore</span> <span class="n">zanzibar</span><span class="o">.</span><span class="n">jks</span> <span class="o">&gt;</span> <span class="n">zanzibar</span><span class="o">.</span><span class="n">der</span>
<span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="ow">in</span> <span class="n">zanzibar</span><span class="o">.</span><span class="n">der</span> <span class="o">-</span><span class="n">inform</span> <span class="n">DER</span> <span class="o">-</span><span class="n">out</span> <span class="n">zanzibar</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">outform</span> <span class="n">PEM</span>

<span class="n">keytool</span> <span class="o">-</span><span class="kn">import</span> <span class="o">-</span><span class="n">trustcacerts</span> <span class="o">-</span><span class="n">alias</span> <span class="n">zanzibar</span> <span class="o">-</span><span class="nb">file</span> <span class="n">zanzibar</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">keystore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">java</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">sun</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">cacerts</span> <span class="o">-</span><span class="n">storepass</span> <span class="n">changeit</span>
</pre></div>
<ul>
<li><a href="http://www.openssl.org/docs/HOWTO/certificates.txt">http://www.openssl.org/docs/HOWTO/certificates.txt</a></li>
<li><a href="http://www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html">http://www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html</a></li>
</ul>
<hr/>
<h1 id="ssh-encryption">SSH Encryption</h1>
<p>Secure Shell is for network access over an insecure network <a href="https://en.wikipedia.org/wiki/Secure_Shell">https://en.wikipedia.org/wiki/Secure_Shell</a></p>
<h2 id="create-a-publicprivate-key-pair-for-ssh">Create a public/private key pair for SSH</h2>
<p>Backup any existing ~/.ssh/id_rsa  (cp -a ~./ssh ~./ssh-bak)
Backup any existing ~/.ssh/id_rsa.pub</p>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -t rsa -C "your_email@example.com"</span>
<span class="err">chmod 400 /path/to/id_rsa*</span>
</pre></div>
<blockquote>
<p>id_rsa and id_rsa.pub  *e.g. in /home/USERNAME/.ssh , <a href="https://en.wikipedia.org/wiki/Ssh-keygen">https://en.wikipedia.org/wiki/Ssh-keygen</a>
chmod to modify permissions (to the "only the owner can read") since if the private key is not restricted in security the ssh client will not run but instead return an error</p>
</blockquote>
<p><strong>id_rsa  IS YOUR PRIVATE KEY, GUARD IT!</strong></p>
<blockquote>
<p>id_rsa.pub IS THE PUBLIC PORTION WHICH YOU ADD TO REMOTE SERVERS</p>
<p>if you add a passphrase to your SSH key (to prevent hackers from simply copying the file)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -y</span>
</pre></div>
<blockquote>
<p>prompted for the path to the file, then prompted for the password to outpout a public signature (.pub)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -t dsa</span>
</pre></div>
<blockquote>
<p>RSA is generally preferred, protocol 2, I only include the DSA command for completeness <a href="http://security.stackexchange.com/questions/5096/rsa-vs-dsa-for-ssh-authentication-keys">http://security.stackexchange.com/questions/5096/rsa-vs-dsa-for-ssh-authentication-keys</a></p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -l -f ~/.ssh/id_rsa.pub</span>
</pre></div>
<blockquote>
<p>Check the number of bits for key strength, it should at least 2048 bits</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -t rsa -C "myemail@example.com" -f $HOME/.ssh/myserver.id_rsa</span>
</pre></div>
<blockquote>
<p>Create an RSA based key with a specific email address label as an output in a specific directory and named file</p>
</blockquote>
<h3 id="output-a-pub-from-a-private-key">output a .pub from a private key</h3>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -y -f id_rsa</span>
</pre></div>
<h3 id="generate-a-fingerprint-for-verification-of-a-host">generate a fingerprint for verification of a host</h3>
<div class="highlight"><pre><span></span><span class="err">ssh-keygen -lf id_rsa.pub</span>
</pre></div>
<h3 id="amazon-ec2-instances-have-a-different-method-ec2-add-keypair">AMAZON ec2 instances have a different method, ec2-add-keypair</h3>
<div class="highlight"><pre><span></span><span class="err">openssl pkcs8 -in myec2key.pem -nocrypt -topk8 -outform DER | openssl sha1 -c</span>
</pre></div>
<h3 id="ec2-import-keypair">ec2-import-keypair:</h3>
<div class="highlight"><pre><span></span><span class="err">openssl pkey -in ~/.ssh/ec2/primary.pem -pubout -outform DER | openssl md5 -c</span>
</pre></div>
<h2 id="adding-a-public-key-to-a-remote-server">Adding a Public Key to a remote server</h2>
<p>ON THE REMOTE SERVER IT SHOULD ONLY HAVE THE public key from .ssh/authorized_keys</p>
<div class="highlight"><pre><span></span>mkdir /home/username/.ssh
sudo vi /home/username/.ssh/authorized_keys
&gt; or  cat .ssh/id_rsa.pub <span class="p">|</span> ssh username@123.45.56.78 <span class="s2">"cat &gt;&gt; ~/.ssh/authorized_keys"</span>

chmod <span class="m">400</span>  /home/username/.ssh/authorized_keys
</pre></div>
<p>Don't forget to modify:</p>
<div class="highlight"><pre><span></span>sudo nano /etc/ssh/sshd_config
<span class="c1">#AuthorizedKeysFile     %h/.ssh/authorized_keys</span>

/etc/init.d/ssh force-reload
/etc/init.d/ssh restart
</pre></div>
<p>ON THE SERVER:  <code>ssh-agent sh -c 'ssh-add &lt; /dev/null &amp;&amp; bash'</code>
OPTIONAL?  <code>exec ssh-agent sh -c 'ssh-add &lt;/dev/null &amp;&amp; exec /usr/local/bin/wmaker'</code></p>
<h3 id="connecting-with-ssh-client-to-a-remote-server">Connecting with SSH client to a remote server</h3>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">i</span> <span class="n">id_rsa</span> <span class="n">username</span><span class="mf">@123.45.56.78</span>
</pre></div>
<blockquote>
<p>verbose, use identity from private key</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh -vvvv -i id_rsa username@example.com</span>
</pre></div>
<blockquote>
<p>if errors like (nil) verify permissions and ownership (whoami=username)</p>
</blockquote>
<p><em>Don't forget you sometimes have chmod 400</em></p>
<h3 id="ssh-ignore-strict-hosts-checking">SSH ignore strict hosts checking</h3>
<p>(i.e. developing against an FQDN with a dynamic ip, this does expose you to the improbable risk of an imposter "man in the middle" server)</p>
<div class="highlight"><pre><span></span><span class="err">ssh -i /usr/local/bamboo/bamboo_id_rsa -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no</span>
</pre></div>
<blockquote>
<p>this command line parameter will not store nor verify the remote server's signature</p>
</blockquote>
<p>A more permanent configuration change:</p>
<div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">config</span>

<span class="n">IdentityFile</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span>

<span class="k">Host</span> <span class="n">example</span><span class="p">.</span><span class="n">com</span>
        <span class="n">StrictHostKeyChecking</span> <span class="k">no</span>
        <span class="n">UserKnownHostsFile</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span>
</pre></div>
<h3 id="ssh-agent-forwarding">SSH Agent Forwarding</h3>
<p>It can be insecure to forward your SSH access through a jumpbox to a machine deeper in your network, though it is generally worse to leave SSH keyson a jumpbox.</p>
<div class="highlight"><pre><span></span><span class="err">ssh-add ~/.ssh/example.pem</span>
</pre></div>
<blockquote>
<p>add a specific key to the ssh agent
    ssh-add -L
an optional step to list the keys that ssh-agent has loaded in memory</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">At</span> <span class="n">user</span><span class="mf">@1.2.3.4</span>
</pre></div>
<blockquote>
<p>SSH and explicitly forward the key so that the second shell session (ssh-agent) has access to it</p>
</blockquote>
<div class="highlight"><pre><span></span>    <span class="n">ssh</span> <span class="n">user</span><span class="mf">@5.6.7.8</span>
</pre></div>
<blockquote>
<p>the extra indentation is to indicate that from the jumpbox you are able to ssh to the internal machine</p>
</blockquote>
<p>A more permanent configuration change by using ~/.ssh/config</p>
<div class="highlight"><pre><span></span><span class="err">Host 1.2.3.4</span>
<span class="err">    ForwardAgent yes</span>
<span class="err">    IdentityFile ~/.ssh/example.pem</span>
</pre></div>
<p><a href="https://linux.die.net/man/1/ssh-add">https://linux.die.net/man/1/ssh-add</a></p>
<h3 id="ssh-tcp-tunnel">SSH TCP tunnel</h3>
<p>In this example the SSH tunnel could be used for a SOCKS proxy for the browser...</p>
<div class="highlight"><pre><span></span><span class="err">ssh -ND 9999 user@example.org</span>
</pre></div>
<blockquote>
<p>connect via ssh to a remote server, after the password prompt the process will stay open for connections locally via port 9999</p>
</blockquote>
<h4 id="use-a-docker-container-to-isolate-the-vpn-software-and-instead-only-allow-an-ssh-tunnel-as-a-web-proxy">Use a docker container to isolate the VPN software and instead only allow an SSH tunnel as a web proxy</h4>
<p>An alternative to a remote machine as the SSH target for the tunnel you can instead target a docker container running locally.
- This allows you to package everything required (i.e. vpn software) into the container
- Has a security benefit that only the container (and its filesystem) are directly exposed to the VPN</p>
<blockquote>
<p>Note that for an even more limited security profile the container could run as an HTTP proxy as it will only handle HTTP traffic (rather than all TCP)</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">docker run --detach --rm --privileged --publish 2222:2222 ubuntu-xenial-vpn</span>
</pre></div>
<blockquote>
<p>the container is running SSHD</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh -p 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@localhost</span>
<span class="err">openconnect https://vpn.example.com</span>
</pre></div>
<blockquote>
<p>SSH into the container and start the openconnect vpn connection and authenticate</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh -ND 9999 -p 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@localhost</span>
</pre></div>
<h4 id="configure-firefox-to-use-the-socks-host">Configure Firefox to use the SOCKS Host</h4>
<div class="highlight"><pre><span></span><span class="err">Firefox -&gt; Edit -&gt; Preferences -&gt; Advanced -&gt; Network -&gt; Connection -&gt; Settings</span>
<span class="err">Manual Proxy configuration: SOCKS Host: localhost, Port 9999</span>
</pre></div>
<blockquote>
<p>firefox sends requests to the server over the ssh encrypted connection</p>
</blockquote>
<h4 id="configure-firefox-to-use-the-socks5-proxy-for-dns">Configure Firefox to use the socks5 proxy for DNS</h4>
<div class="highlight"><pre><span></span><span class="n">about</span><span class="o">:</span><span class="n">config</span>
<span class="n">network</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">socks_remote_dns</span>
</pre></div>
<blockquote>
<p>use the address bar to access the advanced configuration option and set socks_remote_dns true</p>
</blockquote>
<p>This ensures the browser will use the SOCKS proxy domain name server rather than the local machines</p>
<h3 id="ssh-tunnel-for-windows-rdp">SSH tunnel for Windows RDP</h3>
<div class="highlight"><pre><span></span><span class="err">ssh -L 3389:172.24.32.40:3389 172.24.32.100 -l sshusername -N</span>
</pre></div>
<ul>
<li>L = local port is forwarded to the remote host and port</li>
<li>l = login_name</li>
<li>.40 = the windows rdp server</li>
<li>.100 = the remote ssh server which has access to the windows rdp server</li>
<li>N = do not execute a remote command (port forwarding only)</li>
</ul>
<h3 id="ssh-tunneling-in-general">ssh tunneling in general</h3>
<p>local port:host:remote-port</p>
<h4 id="ssh-tunnel-on-port-9090-cherokee-admin">ssh tunnel on port 9090 (cherokee-admin)</h4>
<div class="highlight"><pre><span></span><span class="err">sudo vi /etc/sysctl.conf</span>
<span class="err">    net.ipv6.conf.all.disable_ipv6=1</span>
</pre></div>
<p><strong> On the remote server start the admin UI (which only allows access via 127.0.0.1 by default for security reasons)</strong>
    sudo cherokee-admin</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">Cherokee</span><span class="w"> </span><span class="n">Web</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="mf">1.2.101</span><span class="w"> </span><span class="p">(</span><span class="n">Jan</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">2012</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">Listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">9090</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TLS</span><span class="w"> </span><span class="n">disabled</span><span class="p">,</span><span class="w"> </span><span class="n">IPv6</span><span class="w"> </span><span class="n">enabled</span><span class="p">,</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">epoll</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">fds</span><span class="w"> </span><span class="k">system</span><span class="w"> </span><span class="k">limit</span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="p">.</span><span class="w"> </span><span class="mi">2041</span><span class="w"></span>
<span class="w">    </span><span class="n">connections</span><span class="p">,</span><span class="w"> </span><span class="n">caching</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">thread</span><span class="w"></span>

<span class="w">    </span><span class="nl">Login</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="k">User</span><span class="err">:</span><span class="w">              </span><span class="k">admin</span><span class="w"></span>
<span class="w">      </span><span class="n">One</span><span class="o">-</span><span class="nc">time</span><span class="w"> </span><span class="nl">Password</span><span class="p">:</span><span class="w"> </span><span class="n">xoKmLN0aISztVMFs</span><span class="w"></span>

<span class="w">    </span><span class="n">Web</span><span class="w"> </span><span class="nl">Interface</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nl">URL</span><span class="p">:</span><span class="w">               </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">9090</span><span class="o">/</span><span class="w"></span>


<span class="n">ssh</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="mi">9090</span><span class="err">:</span><span class="nl">localhost</span><span class="p">:</span><span class="mi">9090</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="k">user</span><span class="nv">@host</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="o">-</span><span class="n">N</span><span class="w"></span>
</pre></div>
<blockquote>
<ul>
<li>L = local port is forwarded to the remote host and port, so ssh binding the localhost to port 9090</li>
<li>ssh the remote server on port 22</li>
<li>ssh with the specified user to the hostname (assuming DNS is correct)</li>
<li>N = do not execute a remote command (port forwarding only)</li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">ssh -L 9090:localhost:9090 remote_IP</span>
</pre></div>
<blockquote>
<p>assumes the ssh port is 22 and the remote user is the same as the local user, not a good assumption</p>
</blockquote>
<p>On your browser access http://localhost:9090 to see the Cherokee Admin UI</p>
<p>Future ideas: iptables 9090? forwarding?</p>
<hr/>
<h1 id="virtual-private-networks-and-openvpn">Virtual Private Networks and openVPN</h1>
<h2 id="docker-openvpn">Docker OpenVPN</h2>
<p>Using Docker is one of the easiest ways to leverage all of the open source tools (assuming for security you inspect the upstream source code, clone the Dockerfile, build your own docker image/container ;)</p>
<div class="highlight"><pre><span></span><span class="c1"># https://github.com/kylemanna/docker-openvpn</span>
<span class="c1"># https://openvpn.net/index.php/open-source/documentation/howto.html</span>
<span class="nb">export</span> <span class="nv">FQDN</span><span class="o">=</span><span class="s2">"example.com"</span>
<span class="nb">export</span> <span class="nv">OVPN_DATA</span><span class="o">=</span><span class="s2">"ovpn-data"</span>
docker volume create --name <span class="nv">$OVPN_DATA</span>
<span class="c1"># generate the initial configuration in the volume</span>
docker run -v <span class="nv">$OVPN_DATA</span>:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u udp://<span class="nv">$FQDN</span>
<span class="c1"># generate the certificate in the volume (you must choose a passphrase)</span>
docker run -v <span class="nv">$OVPN_DATA</span>:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpki
<span class="c1"># start the openvpn service</span>
docker run -v <span class="nv">$OVPN_DATA</span>:/etc/openvpn -d -p <span class="m">1194</span>:1194/udp --cap-add<span class="o">=</span>NET_ADMIN kylemanna/openvpn

<span class="c1"># generate the client certificate without the passphrase</span>
docker run -v <span class="nv">$OVPN_DATA</span>:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full <span class="nv">$FQDN</span> nopass
<span class="c1"># export the client config with embedded certificates</span>
docker run -v <span class="nv">$OVPN_DATA</span>:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient <span class="nv">$FQDN</span> &gt; <span class="nv">$FQDN</span>.ovpn
</pre></div>
<h2 id="digital-ocean-openvpn">Digital Ocean OpenVPN</h2>
<h3 id="dedicated-ssh-user">Dedicated SSH User</h3>
<ul>
<li>create a new ssh key (ops sec best practice)</li>
<li>Setup a free Firewall with ports tcp 22 and udp 1194</li>
<li>Create and Deploy a new droplet ($5 in a region near you for lower latency, with your newly created SSH key)</li>
<li>Once it has finished booting use the Digital Ocean web ui: Networking -&gt; Firewalls -&gt; FirewallName -&gt; Droplets to add the Droplet to the firewall</li>
<li>ssh -i ~/.ssh/your-new-ssh-key root@1.2.3.4</li>
<li>reset the root password: passwd</li>
<li>Use the WebUI from Digital Ocean to verify you can access local console with the root user (and the new password)</li>
<li>harden the machine by adding a dedicated ssh user (not root!)</li>
<li>
<ul>
<li>useradd -s /bin/bash -m NEWUSERNAME</li>
</ul>
</li>
<li>
<ul>
<li>usermod -a -G admin NEWUSERNAME</li>
</ul>
</li>
<li>
<ul>
<li>passwd NEWUSERNAME</li>
</ul>
</li>
<li>
<ul>
<li>verify this with: cat /etc/passwd | grep NEWUSERNAME ; cat /etc/group | grep NEWUSERNAME</li>
</ul>
</li>
<li>
<ul>
<li>give the new user sudo permissions: visudo </li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>UPDATE THE LINE TO: %admin ALL=(ALL) NOPASSWD:ALL</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>MOVE THE LINE BELOW: %sudo    ALL=(ALL:ALL) ALL</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>VERIFY: cat /etc/sudoers</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>mkdir -p /home/NEWUSERNAME/.ssh</li>
</ul>
</li>
<li>
<ul>
<li>vim /home/NEWUSERNAME/.ssh/authorized_keys (paste the public key that matches the new ssh key)</li>
</ul>
</li>
<li>
<ul>
<li>/etc/init.d/ssh force-reload</li>
</ul>
</li>
<li>
<ul>
<li>/etc/init.d/ssh restart</li>
</ul>
</li>
<li>
<ul>
<li>BE SURE that /home/NEWUSERNAME/.ssh and authorized_keys is owned by the new user (chown)</li>
</ul>
</li>
<li>
<ul>
<li>VERIFY WITH VERBOSE the new user can SSH with: ssh -v -i ~/.ssh/your-new-ssh-key NEWUSERNAME@1.2.3.4</li>
</ul>
</li>
<li>
<ul>
<li>VERIFY PERMISSIONS ONCE LOGGED IN WITH SSH: sudo su</li>
</ul>
</li>
</ul>
<h3 id="more-hardening">More Hardening</h3>
<ul>
<li>disable root user from using SSH access and harden with a non-standard port</li>
<li>
<ul>
<li>vim /etc/ssh/sshd_config</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>Port 22222</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>PermitRootLogin no</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>ADD TO THE END OF THE FILE: AllowUsers NEWUSERNAME</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>service sshd restart</li>
</ul>
</li>
<li>
<ul>
<li>VERIFY: netstat -antp  # should see 0.0.0.0:22222</li>
</ul>
</li>
</ul>
<h3 id="prerequisites">Prerequisites</h3>
<div class="highlight"><pre><span></span><span class="err">apt update</span>
<span class="err">apt install openvpn easy-rsa</span>
<span class="err">vim /etc/sysctl.conf</span>
<span class="err">    net.ipv4.ip_forward=1</span>
<span class="err">sudo sysctl -p</span>
</pre></div>
<p>Setting up the certificate authority (since OpenVPN uses keys)</p>
<div class="highlight"><pre><span></span><span class="err">make-cadir ~/openvpn-ca</span>
<span class="err">cd ~/openvpn-ca</span>
</pre></div>
<p><code>vim vars</code></p>
<blockquote>
<p>update the export KEY_NAME, KEY_ORG, KEY_EMAIL, KEY_OU to something more personalized</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">source vars</span>
<span class="err">./clean-all</span>
<span class="err">./build-ca</span>
</pre></div>
<blockquote>
<p>You can just press enter a bunch to use all the defaults that you preconfigured in the vars file previously</p>
</blockquote>
<p><code>./build-key-server KEY_NAME</code> (i.e. server or myvpn)</p>
<blockquote>
<p>Just press enter to accept all the defaults again (no challenge password!) and press y at the end to Sign and then Commit the certificates</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">./build-dh</span>
<span class="err">openvpn --genkey --secret keys/ta.key</span>
</pre></div>
<p><code>./build-key client1</code></p>
<blockquote>
<p>if you want to build another one later you must use: sudo su ; cd /root/openvpn-ca ; source vars ; ./build-key client2</p>
</blockquote>
<h3 id="configure-openvpn">Configure openvpn</h3>
<div class="highlight"><pre><span></span>cp ~/openvpn-ca/keys
sudo cp ca.crt myvpn.crt myvpn.key ta.key dh2048.pem /etc/openvpn
gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz <span class="p">|</span> sudo tee /etc/openvpn/myvpn.conf
</pre></div>
<p><code>vim /etc/openvpn/myvpn.conf</code>
    :::bash
    tls-auth ta.key 0 # Remove the preceding ; to uncomment this line
    key-direction 0
    cipher AES-256-CBC
    auth SHA256
    user nobody  # Remove the preceding ; to uncomment this line
    group nogroup
    push "redirect-gateway def1 bypass-dhcp"  # Remove the preceding ; to uncomment this line
    push "dhcp-option DNS 208.67.222.222"  # Remove the preceding ; to uncomment this line
    push "dhcp-option DNS 208.67.220.220"  # Remove the preceding ; to uncomment this line
    block-outside-dns
    cert myvpn.crt
    key myvpn.key</p>
<blockquote>
<p>some tweaks for more security https://community.openvpn.net/openvpn/wiki/Hardening (the ta.key = tls auth)
208.67.222.222 = opendns , https://openvpn.net/index.php/open-source/documentation/howto.html</p>
</blockquote>
<p><code>sudo systemctl start openvpn@myvpn</code>
<code>sudo systemctl status openvpn@myvpn</code>
<code>sudo systemctl enable openvpn@server</code></p>
<blockquote>
<p>Should end with "ovpn-myvpn[21142]: Initialization Sequence Completed"
"enable" means that the service will start at boot</p>
</blockquote>
<p><code>netstat -antup</code></p>
<blockquote>
<p>Should list all the TCP and UDP listening services including port 1194, 0.0.0.0:1194</p>
</blockquote>
<p><code>ip addr show tun0</code></p>
<blockquote>
<p>Should show the tunnel interface is created what the network range is (e.g. 10.8.0.1)</p>
</blockquote>
<p>Consider updating myvpn.conf to use port 443 and proto tcp in order to assist clients traverse/reach the openvpn server in restricted environments</p>
<p>TODO: automate using packer and digital ocean apis to create an image</p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04</a></li>
<li><a href="https://wiki.openwrt.org/doc/howto/vpn.openvpn#tab__using_openssl_commands_most_secure">https://wiki.openwrt.org/doc/howto/vpn.openvpn#tab__using_openssl_commands_most_secure</a> (more secure by directly using openssl commands)</li>
</ul>
<h2 id="connect-a-client-to-the-openvpn-server">Connect a client to the OpenVPN server</h2>
<h3 id="openvpn-client-config-infrastructure-on-the-remote-server">OpenVPN client config infrastructure on the remote server</h3>
<div class="highlight"><pre><span></span>mkdir -p /root/client-configs/files
chmod <span class="m">700</span> /root/client-configs/files   
cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /root/client-configs/base.conf
vim /root/client-configs/base.conf
    remote NEW-VPN-SERVER-IP-ADDRESS <span class="m">1194</span>
    user nobody
    group nogroup
    <span class="c1"># ca ca.crt</span>
    <span class="c1"># cert client.crt</span>
    <span class="c1"># key client.key</span>
    cipher AES-256-CBC
    auth SHA256
    key-direction <span class="m">1</span>
</pre></div>
<blockquote>
<p>if you have modified the port and protocol ensure that 1194 and udp are updated accordingly
windows clients will not be able to downgrad the user and group to nobody/nogroup
commenting out the files as they will be embedded in the .ovpn config file</p>
</blockquote>
<p><code>vim /root/client-configs/make_config.sh</code>
    :::bash
    KEY_DIR=/root/openvpn-ca/keys
    OUTPUT_DIR=/root/client-configs/files
    BASE_CONFIG=/root/client-configs/base.conf
    cat ${BASE_CONFIG} \
        &lt;(echo -e '<ca>') \
        ${KEY_DIR}/ca.crt \
        &lt;(echo -e '</ca>\n<cert>') \
        ${KEY_DIR}/${1}.crt \
        &lt;(echo -e '</cert>\n<key>') \
        ${KEY_DIR}/${1}.key \
        &lt;(echo -e '</key>\n<tls-auth>') \
        ${KEY_DIR}/ta.key \
        &lt;(echo -e '</tls-auth>') \
        &gt; ${OUTPUT_DIR}/${1}.ovpn</p>
<blockquote>
<p>This automates creating a config file via a script</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="err">chmod 700 make_config.sh</span>
<span class="err">./make_config.sh client1</span>
<span class="err">ls -ahl /root/client-configs/files/</span>
</pre></div>
<h3 id="once-you-have-the-configuration">Once you have the configuration</h3>
<p><code>sudo apt-get install -y openvpn</code></p>
<blockquote>
<p>For a linux client this installs the openvpn client software</p>
</blockquote>
<p><code>scp -i ~/.ssh/VPNKEY -P 22222  NEWUSERNAME@VPN-IP-ADDRESS:client1.ovpn .</code></p>
<blockquote>
<p>of course no matter what we need the open vpn client configuration</p>
</blockquote>
<p>Or... From a client computer SCP to download the $FQDN.ovpn and then connect to the openvpn server</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">openvpn</span> <span class="c1">--config client1.ovpn</span>

<span class="o">#</span> <span class="n">verify</span> <span class="k">with</span> <span class="n">the</span> <span class="n">following</span> <span class="k">in</span> <span class="n">the</span> <span class="k">output</span><span class="p">:</span> <span class="ss">"/sbin/ip addr add dev tun0 local 192.168.255.6 peer 192.168.255.5"</span>
<span class="o">#</span> <span class="n">ifconfig</span> <span class="o">-</span><span class="n">a</span>  <span class="ss">"tun0 ... inet addr:192.168.255.6"</span>  <span class="p">,</span> <span class="k">as</span> <span class="n">you</span> <span class="n">send</span> <span class="n">traffic</span><span class="p">:</span> <span class="n">RX</span> <span class="n">bytes</span><span class="p">:</span><span class="mi">4145707</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="mi">1</span> <span class="n">MB</span><span class="p">)</span>  <span class="n">TX</span> <span class="n">bytes</span><span class="p">:</span><span class="mi">319025</span> <span class="p">(</span><span class="mi">319</span><span class="p">.</span><span class="mi">0</span> <span class="n">KB</span><span class="p">)</span>
<span class="n">curl</span> <span class="n">checkip</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span>  <span class="o">#</span> <span class="n">should</span> <span class="k">return</span> <span class="n">the</span> <span class="n">IP</span> <span class="n">address</span> <span class="k">of</span> <span class="n">the</span> <span class="n">VPN</span> <span class="n">server</span> <span class="p">(</span><span class="k">not</span> <span class="n">your</span> <span class="k">local</span> <span class="n">Wifi</span><span class="o">/</span><span class="n">ISP</span><span class="p">)</span>
<span class="n">curl</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">dnsleaktest</span><span class="p">.</span><span class="n">com</span><span class="o">/</span>
<span class="o">#</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">whoer</span><span class="p">.</span><span class="n">net</span><span class="o">/#</span><span class="n">extended</span>
</pre></div>
<h3 id="import-a-ovpn-config-file-into-ubuntu-network-manager">Import a .ovpn config file into ubuntu network manager</h3>
<p><code>sudo nmcli connection import type openvpn file myname.tcp.ovpn</code></p>
<blockquote>
<p>[sudo] password for your-username:
Connection 'mynameVPN' (abcd-37c175b2325d) successfully added.</p>
</blockquote>
<h4 id="connect-to-a-vpn-from-the-cli">Connect to a VPN from the CLI</h4>
<p><code>nmcli connection up mynameVPN</code></p>
<blockquote>
<p>presuming the prior connection config was named mynameVPN</p>
</blockquote>
<p><code>nmcli connection show mynameVPN</code></p>
<h3 id="dns-security">DNS Security</h3>
<p>Moreover your DNS server can "leak" or be hijacked, here are some good alternatives to your snooping ISP or "big brother" evil corp.</p>
<ul>
<li>1.1.1.1 (cloudflare <a href="https://developers.cloudflare.com/1.1.1.1/commitment-to-privacy/">https://developers.cloudflare.com/1.1.1.1/commitment-to-privacy/</a>)</li>
<li>185.121.177.177 or 169.239.202.202 (http://dnsrec.meo.ws/ part of opennic)</li>
<li>84.200.69.80 or 84.200.70.40 (dns.watch free, neutral, privacy)</li>
<li>
<p>https://www.opennic.org/</p>
<p>echo 185.121.177.177 &gt;&gt; /etc/resolvconf/resolv.conf.d/tail
sudo resolvconf -u</p>
<blockquote>
<p>This should append the new resolver and force an update, though you may have to ifdown eth0 ; ifup eth0</p>
</blockquote>
</li>
</ul>
<p><code>dig -trace example.com</code>
<code>nslookup -debug example.com</code></p>
<blockquote>
<p>either command will provide copious debugging output (and nslookup has an interactive mode with "d2" for extra debugging)</p>
</blockquote>
<p>These are DNS providers that have been assimilated into the borg:</p>
<ul>
<li>216.146.36.36 (Dyn DNS was acquired by Oracle)</li>
<li>209.244.0.4 (Level3 Communications telco was acquired by CenturyLink)</li>
<li>208.67.220.220 (OpenDNS was acquired by Cisco and they basically store your data)</li>
<li>208.69.38.205 (also opendns)</li>
<li>8.8.8.8 (Google - so basically giving them even more data - especially when you use Chrome too)</li>
</ul>
<p>A non standard protocol to encrypt DNS traffic: <a href="https://en.wikipedia.org/wiki/DNSCrypt">https://en.wikipedia.org/wiki/DNSCrypt</a></p>
<hr/>
<h1 id="letsencrypt-and-certbot-for-free-ssl-certificates">Letsencrypt and certbot for free SSL Certificates</h1>
<p>A relatively recent development has been a widespread effort to help secure more of everyone's communications by encouraing web sites to install SSL certificates (and automate renewals) for free.</p>
<p>Here is the tool that allows you to easily automate getting a free SSL certificate (trusted by libraries and browsers no less)...</p>
<p><em>Once again Docker simplifies things slightly (as long as you trust the container hosted by quay.io CoreOS who was acquired by RedHat ;)</em></p>
<p>Prerequisite: setup a DNS record for yourdomain.com to point to the server ip address.</p>
<h2 id="create-a-free-ssl-cert-with-certbot-in-docker">Create a free SSL cert with certbot in docker</h2>
<div class="highlight"><pre><span></span>systemctl stop nginx
sudo docker run -it --rm -p <span class="m">443</span>:443 --name certbot -v /etc/letsencrypt:/etc/letsencrypt -v /var/log/letsencrypt:/var/log/letsencrypt quay.io/letsencrypt/letsencrypt certonly --standalone -d yourdomain.com
systemctl start nginx
</pre></div>
<ol>
<li>Downloads the container if it is not already in <code>docker images</code></li>
<li>Starts a container with a web server that binds to port 443 </li>
<li>The same web server/tool sends a certificate signing request (from your server running at yourdomain.com) to letsencrypt.org</li>
<li>letsencrypt.org then attempts to contact the provided domain (DNS -&gt; IP -&gt; server -&gt; docker container)</li>
<li>The containerized-certbot-web-server/tool then securely downloads the new SSL certificate</li>
<li>Files created in the process are stored in /etc/letsencrypt</li>
<li>The "evergreen" certs are presented via symlinks in /etc/letsencrypt/live/yourdomain.com/</li>
<li>Specific versioned copies of the certificates are stored in /etc/letsencrypt/archive/yourdomain.com</li>
<li>letsencrypt certbot tool automatically generates the /etc/nginx/conf.d/default.conf (<em>which points to the config and cert files in /etc/letsencrypt/</em>)</li>
</ol>
<h2 id="renew-your-ssl-certificate-with-certbot-and-cron">Renew your SSL certificate with certbot and cron</h2>
<p>You can keep renewing the certificate (which lasts 90 days) for free and there are a number of other open source tools (which leverage the API/process)</p>
<div class="highlight"><pre><span></span>systemctl stop nginx
docker run -it --rm -p <span class="m">443</span>:443 --name certbot -v /etc/letsencrypt:/etc/letsencrypt -v /var/log/letsencrypt:/var/log/letsencrypt quay.io/letsencrypt/letsencrypt certonly --standalone --force-renewal -d yourdomain.com
systemctl start nginx
</pre></div>
<blockquote>
<p>you must stop the production web server briefly in order to generate the updated certificate</p>
</blockquote>
<p>If you want to use a cron job for certificate renewal then put the previous instructions into an executable file named ssl-cert-renewal.sh</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">'59 23 01 * * /home/USERNAME/ssl-cert-renewal.sh'</span> &gt;&gt; /home/USERNAME/mymonthly.cron
crontab /home/USERNAME/mymonthly.cron
crontab -l
</pre></div>
<blockquote>
<p>be sure to append to mymonthly.cron as the crontab command will override any previous cron jobs</p>
</blockquote>
<ul>
<li><a href="https://letsencrypt.org/how-it-works/">https://letsencrypt.org/how-it-works/</a></li>
<li><a href="https://certbot.eff.org/docs/using.html#certbot-commands">https://certbot.eff.org/docs/using.html#certbot-commands</a></li>
<li><a href="https://github.com/certbot/certbot/blob/master/Dockerfile">https://github.com/certbot/certbot/blob/master/Dockerfile</a></li>
</ul>
<h1 id="cryptography-exercises">Cryptography Exercises</h1>
<p>In order to really understand and enjoy cryptography you can dive deeper via some of these exercises</p>
<ul>
<li><a href="https://cryptopals.com/">https://cryptopals.com/</a></li>
</ul>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">Â« <a href="https://blog.john-pfeiffer.com/golang-json-is-challenging/" title="Previous: Golang JSON is challenging">Golang JSON is challenging</a></li>
 
                <li class="next_article"><a href="https://blog.john-pfeiffer.com/code-is-for-humans/" title="Next: Code is for Humans">Code is for Humans</a> Â»</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2017-02-16T23:34:00-08:00">Feb 16, 2017</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#it-ref">it</a> 
            <h4>~4376 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#aes-ref">aes
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#certbot-ref">certbot
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#certbot-ref">certbot
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#encryption-ref">encryption
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#https-ref">https
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#keygen-ref">keygen
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#letsencrypt-ref">letsencrypt
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#openssl-ref">openssl
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#openvpn-ref">openvpn
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#security-ref">security
                    <span>5</span>
</a></li>
                <li><a href="/tags.html#ssh-ref">ssh
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#vpn-ref">vpn
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
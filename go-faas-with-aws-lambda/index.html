<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="go, golang, aws, lambda, cron, iam, cloudwatch, build-CI-CD-devops, " />
        <title>Go FaaS with AWS Lambda  · johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/go-faas-with-aws-lambda/"> Go FaaS with AWS Lambda  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#source-code">Source Code</a></li>
<li><a href="#aws-cli-deployment">AWS CLI Deployment</a><ul>
<li><a href="#packaging-for-upload">Packaging for Upload</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#aws-permissions-and-roles">AWS Permissions and Roles</a></li>
</ul>
</li>
<li><a href="#create-an-aws-user-with-api-credentials">Create an AWS user with API Credentials</a><ul>
<li><a href="#the-actual-create-lambda-command">The Actual Create Lambda Command</a></li>
</ul>
</li>
<li><a href="#trigger-a-lambda-manually">Trigger a Lambda Manually</a></li>
<li><a href="#lambda-cron-aka-cloudwatch-scheduled-events">Lambda Cron aka CloudWatch Scheduled Events</a></li>
<li><a href="#lambda-monitoring">Lambda Monitoring</a></li>
<li><a href="#more-info">More Info</a></li>
<li><a href="#api-gateway">API Gateway</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<p>The promise of creating functions that do not require server administration is amazing,
the reality though includes a huge maze of vendor specific commands and frameworks (including permissions).</p>
<h2 id="source-code">Source Code</h2>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">"context"</span>
    <span class="s">"fmt"</span>
    <span class="s">"time"</span>

    <span class="s">"github.com/aws/aws-lambda-go/lambda"</span>
<span class="p">)</span>

<span class="c1">// MyRequest demonstrates an input value</span>
<span class="kd">type</span> <span class="nx">MyRequest</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Value</span> <span class="kt">string</span> <span class="s">`json:"value"`</span>
<span class="p">}</span>

<span class="c1">// MyResponse helps illustrate how AWS Lambda auto</span>
<span class="kd">type</span> <span class="nx">MyResponse</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Message</span> <span class="kt">string</span> <span class="s">`json:"message"`</span>
    <span class="nx">Created</span> <span class="kt">string</span> <span class="s">`json:"created"`</span>
<span class="p">}</span>

<span class="c1">// HandleRequest https://docs.aws.amazon.com/lambda/latest/dg/go-programming-model-handler-types.html</span>
<span class="kd">func</span> <span class="nx">HandleRequest</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">MyRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">MyResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UTC</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">MyResponse</span><span class="p">{</span>
        <span class="nx">Message</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">"hi %s"</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Value</span><span class="p">),</span>
        <span class="nx">Created</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">))},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">lambda</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">HandleRequest</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<ul>
<li><a href="https://aws.amazon.com/blogs/compute/announcing-go-support-for-aws-lambda">https://aws.amazon.com/blogs/compute/announcing-go-support-for-aws-lambda</a></li>
<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/go-programming-model-handler-types.html">https://docs.aws.amazon.com/lambda/latest/dg/go-programming-model-handler-types.html</a></li>
</ul>
<h2 id="aws-cli-deployment">AWS CLI Deployment</h2>
<p>To avoid some of the complexity with the CLI you may want to first dip your toes in with the Web UI creation of a Go Lambda:
<a href="https://us-west-1.console.aws.amazon.com/lambda/home?region=us-west-1#/create?firstrun=true">https://us-west-1.console.aws.amazon.com/lambda/home?region=us-west-1#/create?firstrun=true</a></p>
<h3 id="packaging-for-upload">Packaging for Upload</h3>
<p>The easy part is creating a binary...</p>
<p><code>go build -o examplebinary</code></p>
<blockquote>
<p>build into a single binary</p>
</blockquote>
<p><code>zip deployment.zip examplebinary</code></p>
<blockquote>
<p>wrap it up in a zip</p>
</blockquote>
<h3 id="prerequisites">Prerequisites</h3>
<p>Installing the awscli may be a chore (if pip is broken), but <code>sudo apt install awscli</code> (from 16.04 should be advanced enough)</p>
<p><em>Unable to locate credentials. You can configure credentials by running "aws configure".</em></p>
<p>So in order to have credentials you must create a User in your AWS Account (with programmatic access only) which will generate an API key for you. (I suggest using the WebUI)</p>
<ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html</a></li>
<li><a href="https://console.aws.amazon.com/iam/home?region=us-west-1#/users">https://console.aws.amazon.com/iam/home?region=us-west-1#/users</a></li>
</ul>
<blockquote>
<p>Do not use your "Root" Admin account in AWS for the API credentials, security best practice means creating at least one separate User</p>
</blockquote>
<h3 id="aws-permissions-and-roles">AWS Permissions and Roles</h3>
<blockquote>
<p>You may have to use the Web UI or some other mechanism to create the IAM role with the correct permissions</p>
</blockquote>
<p>Gotcha: the minimum permission would be "lambda:CreateFunction"</p>
<ul>
<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html#lambda-intro-execution-role">https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html#lambda-intro-execution-role</a></li>
<li><a href="https://console.aws.amazon.com/iam/home?region=us-west-1#/policies">https://console.aws.amazon.com/iam/home?region=us-west-1#/policies</a></li>
<li><a href="https://console.aws.amazon.com/iam/home?region=us-west-1#/roles">https://console.aws.amazon.com/iam/home?region=us-west-1#/roles</a></li>
</ul>
<p>This means the laborious process of creating a Policy that includes all the Lambda permissions (not very secure but it works)</p>
<blockquote>
<p>iam:PassRole</p>
</blockquote>
<p>Hilariously the pre-created roles listed in the documentation do not have that specific IAM extra permission, somehow by default an Admin of the account should deploy lambdas?</p>
<div class="highlight"><pre><span></span>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "iam:PassRole",
                "lambda:*"
            ],
            "Resource": "*"
        }
    ]
}
</pre></div>
<h2 id="create-an-aws-user-with-api-credentials">Create an AWS user with API Credentials</h2>
<p>So in order to have API credentials (~/.aws/credentials) you have already created:</p>
<ol>
<li>A Policy</li>
<li>A Role that can use that Policy</li>
<li>A Group that has the Policy attached</li>
<li>A User that has credentials (and is in the Group with</li>
</ol>
<h3 id="the-actual-create-lambda-command">The Actual Create Lambda Command</h3>
<div class="highlight"><pre><span></span>aws lambda create-function <span class="se">\</span>
--region us-west-1 <span class="se">\</span>
--function-name ExampleFunction <span class="se">\</span>
--zip-file fileb://./deployment.zip <span class="se">\</span>
--runtime go1.x <span class="se">\</span>
--role arn:aws:iam::1234YOURACCOUNT:role/lambda-all <span class="se">\</span>
--handler examplebinary
</pre></div>
<blockquote>
<p>fileb format = file binary</p>
</blockquote>
<p>The JSON response from creating the new lambda function (and uploading the zipped Go binary)...</p>
<div class="highlight"><pre><span></span>{
    "LastModified": "2018-06-12T04:55:36.327+0000",
    "Version": "$LATEST",
    "FunctionArn": "arn:aws:lambda:us-west-1:1234YOURACCOUNT:function:ExampleFunction",
    "MemorySize": 128,
    "Runtime": "go1.x",
    "Role": "arn:aws:iam::1234YOURACCOUNT:role/lambda-all",
    "Description": "",
    "CodeSha256": "45R3BZKesxMM3AuZ96lS9UoiOEGX964oHD/J8QQfLfQ=",
    "Timeout": 3,
    "FunctionName": "ExampleFunction",
    "Handler": "examplebinary",
    "CodeSize": 2793060
}
</pre></div>
<ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/create-function.html">https://docs.aws.amazon.com/cli/latest/reference/lambda/create-function.html</a></li>
</ul>
<h2 id="trigger-a-lambda-manually">Trigger a Lambda Manually</h2>
<p>Using the WebUI (AWS Console) you can select the function created with the CLI
<a href="https://us-west-1.console.aws.amazon.com/lambda/home?region=us-west-1#/functions">https://us-west-1.console.aws.amazon.com/lambda/home?region=us-west-1#/functions</a></p>
<p>By using the "Configure test events" (sometimes a dropdown on the right next to the Test button)</p>
<p>You can create a new "test event" , in this case a MyRequest (though any arbitrary extraneous JSON will be ignored)</p>
<blockquote>
<p>Note that the WebUI also provides a way to upload a newer zip file</p>
</blockquote>
<h2 id="lambda-cron-aka-cloudwatch-scheduled-events">Lambda Cron aka CloudWatch Scheduled Events</h2>
<p>In the WebUI you can add a trigger via the Designer (on the left)</p>
<p>Select "CloudWatch Events" -&gt; Configure triggers (scroll down) -&gt; Create a new rule</p>
<p>Configure a trigger, "Scheduled" (as opposed to Rate which is similar but different ;)</p>
<p>Name: "examplecron"</p>
<p><code>cron(16 * ? * MON-FRI *)</code></p>
<blockquote>
<p>This would be on the 16th minute every hour every day every month on Monday through Friday (every year)
cron(Minutes Hours Day-of-month Month Day-of-week Year)</p>
</blockquote>
<p>Disabling the "example" Cloud Watch Event is as easy as toggling a radio button
(this is an interesting way of controlling how/when your function executes)</p>
<ul>
<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html">https://docs.aws.amazon.com/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html</a></li>
</ul>
<h2 id="lambda-monitoring">Lambda Monitoring</h2>
<p>In the same WebUI where you view the Lambda function (by name) you can click on Monitoring and click around to see Metrics
(i.e. Lambda Cron aka CloudWatch Scheduled Events) actually "invoked" your function.</p>
<p>Of course if you haven't enabled CloudWatch Logging or more importantly created a "Log Group" then you get nothing.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html">https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html</a></li>
</ul>
<h2 id="more-info">More Info</h2>
<p>Here's a full source code example: <a href="https://github.com/johnpfeiffer/aws-go-lambda">https://github.com/johnpfeiffer/aws-go-lambda</a>
Compare the unit tests to those from a full web server handler: <a href="https://github.com/johnpfeiffer/go-web-example/blob/master/controller_test.go">https://github.com/johnpfeiffer/go-web-example/blob/master/controller_test.go</a></p>
<p>Apparently in order to test the tight integration with using AWS Lambda to consume events from other AWS Services there's a tool:
<a href="https://aws.amazon.com/about-aws/whats-new/2017/08/introducing-aws-sam-local-a-cli-tool-to-test-aws-lambda-functions-locally">https://aws.amazon.com/about-aws/whats-new/2017/08/introducing-aws-sam-local-a-cli-tool-to-test-aws-lambda-functions-locally</a></p>
<h2 id="api-gateway">API Gateway</h2>
<p>TODO (and probably using S3 too)</p>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/infrastructure-as-code-with-terraform-and-aws/" title="Previous: Infrastructure as Code with Terraform and AWS">Infrastructure as Code with Terraform and AWS</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2018-06-11T19:48:00-07:00">Jun 11, 2018</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#build-CI-CD-devops-ref">build-CI-CD-devops</a> 
            <h4>~725 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#aws-ref">aws
                    <span>3</span>
</a></li>
                <li><a href="/tags.html#cloudwatch-ref">cloudwatch
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#cron-ref">cron
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#go-ref">go
                    <span>10</span>
</a></li>
                <li><a href="/tags.html#golang-ref">golang
                    <span>10</span>
</a></li>
                <li><a href="/tags.html#iam-ref">iam
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#lambda-ref">lambda
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
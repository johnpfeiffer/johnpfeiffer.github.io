<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="service discovery, consul, cluster, clustering, config, build-CI-CD-devops, " />
        <title>Consul Service Discovery and Cluster Configuration  · johnpfeiffer
</title>
        <link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3758734-9']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/consul-service-discovery-and-cluster-configuration/"> Consul Service Discovery and Cluster Configuration  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#consul-cluster-using-docker">Consul Cluster using Docker</a></li>
<li><a href="#registering-a-service">Registering a Service</a></li>
<li><a href="#distributed-configuration">Distributed Configuration</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<h2 id="overview">Overview</h2>
<p>Basically consul is an out-of-the-box service discovery system intended for clustered and highly available applications.</p>
<ul>
<li>https://www.consul.io/intro/</li>
<li>https://www.consul.io/docs/internals/jepsen.html</li>
</ul>
<p>This kind of infrastructure simplifies the programming of distributed systems so that it is easier to deliver value quickly on the actual domain problems.</p>
<p><strong>I have certainly done my fair share of hardcoded config files to "discover" dependency services and even used chef for "config management"...
But with the evolution of devops, web scale, microservices, containers, etc. it is great to leverage an existing battle tested solution</strong></p>
<h2 id="consul-cluster-using-docker">Consul Cluster using Docker</h2>
<p>Following the straightforward work from this Docker Image we can run a cluster on a single machine:</p>
<ul>
<li>
<p>https://hub.docker.com/r/progrium/consul/</p>
<p>sudo su
docker run -d --name node1 -h node1 progrium/consul -server -bootstrap-expect 3
JOIN_IP="$(docker inspect -f '{{.NetworkSettings.IPAddress}}' node1)"
docker run -d --name node2 -h node2 progrium/consul -server -join $JOIN_IP
docker run -d --name node3 -h node3 progrium/consul -server -join $JOIN_IP
docker run -d -p 8400:8400 -p 8500:8500 -p 8600:53/udp --name node4 -h node4 progrium/consul -join $JOIN_IP</p>
<blockquote>
<p>The second 2 nodes join the first one in the cluster by using the inspected IP Address,
the last container is a consul agent (not in the quorum) but has public ports for interactivity</p>
</blockquote>
<p>curl localhost:8500/v1/catalog/nodes
    [{"Node":"node1","Address":"172.17.0.2"},{"Node":"node2","Address":"172.17.0.3"},
    {"Node":"node3","Address":"172.17.0.4"},{"Node":"node4","Address":"172.17.0.5"}]
dig @0.0.0.0 -p 8600 node1.node.consul
    ;; QUESTION SECTION:
    ;node1.node.consul.     IN  ANY</p>
<div class="highlight"><pre><span></span>;; ANSWER SECTION:
node1.node.consul.  0   IN  A   172.17.0.2
</pre></div>
</li>
</ul>
<blockquote>
<p>REST API call to the list of nodes, then DNS client to get the Record for the first node</p>
</blockquote>
<div class="highlight"><pre><span></span>curl http://localhost:8500/v1/status/leader
    "172.17.0.2:8300"
curl http://localhost:8500/v1/status/peers
    ["172.17.0.2:8300","172.17.0.3:8300","172.17.0.4:8300"]

curl http://localhost:8500/v1/health/node/node1
</pre></div>
<blockquote>
<p>some more REST calls about the basic nodes, RAFT leadership and peers, and node health</p>
</blockquote>
<ul>
<li>https://www.consul.io/docs/agent/http.html</li>
<li>
<p>https://www.consul.io/docs/agent/dns.html</p>
<p>curl http://localhost:8500/v1/catalog/services
    {"consul":[]}
curl http://localhost:8500/v1/catalog/service/web
    []</p>
<blockquote>
<p>Listing of the services available, no web service yet =)</p>
</blockquote>
</li>
</ul>
<h2 id="registering-a-service">Registering a Service</h2>
<p>Creating and running a very simplistic golang web server (assuming you have go installed ;) , <code>go run web.go</code>
<a href="https://blog.john-pfeiffer.com/go-programming-intro-with-vs-code-and-arrays-slices-functions-and-testing/">https://blog.john-pfeiffer.com/go-programming-intro-with-vs-code-and-arrays-slices-functions-and-testing/</a>
(though you could also use nginx in docker)</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"net/http"</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">myHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">"hi\n"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="nx">myHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>From the previous steps we should have an Agent where we can register the new web service...</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

curl --header <span class="s2">"content-type: application/json"</span> -X PUT -d<span class="s1">'{</span>
<span class="s1">  "ID": "web1",</span>
<span class="s1">  "Name": "web",</span>
<span class="s1">  "Tags": [</span>
<span class="s1">    "master",</span>
<span class="s1">    "v1"</span>
<span class="s1">  ],</span>
<span class="s1">  "Address": "127.0.0.1",</span>
<span class="s1">  "Port": 8080,</span>
<span class="s1">  "EnableTagOverride": false,</span>
<span class="s1">  "Check": {</span>
<span class="s1">    "HTTP": "http://localhost:8080/health",</span>
<span class="s1">    "Interval": "10s",</span>
<span class="s1">    "TTL": "15s"</span>
<span class="s1">  }</span>
<span class="s1">}'</span> http://localhost:8500/v1/agent/service/register
</pre></div>
<p>In order to verify the new service is registered (besides the 200 response code)</p>
<div class="highlight"><pre><span></span>curl http://localhost:8500/v1/catalog/services
    {"consul":[],"web":["master","v1"]}
curl http://localhost:8500/v1/health/service/web
</pre></div>
<blockquote>
<p>Our new service is created and doing well</p>
</blockquote>
<p>So many more things can be done with <a href="https://www.consul.io/docs/agent/http/agent.html#agent_service_register">https://www.consul.io/docs/agent/http/agent.html#agent_service_register</a></p>
<p>Stopping the web server (control + C) and checking that Consul has noticed Status is critical \O/</p>
<div class="highlight"><pre><span></span>curl http://localhost:8500/v1/health/checks/web
    [{"Node":"node4","CheckID":"service:web1","Name":"Service 'web' check","Status":"critical","Notes":"","Output":"TTL expired","ServiceID":"web1","ServiceName":"web"}]
</pre></div>
<p>Starting the web server again and check</p>
<div class="highlight"><pre><span></span>curl http://localhost:8500/v1/health/service/web
    [{"Node":{"Node":"node4","Address":"172.17.0.5"},
    "Service":{"ID":"web1","Service":"web","Tags":["master","v1"],"Address":"127.0.0.1","Port":8080},
    "Checks":[{"Node":"node4","CheckID":"service:web1","Name":"Service 'web'check","Status":"critical",
        "Notes":"","Output":"TTL expired","ServiceID":"web1","ServiceName":"web"},
    {"Node":"node4","CheckID":"serfHealth","Name":"Serf Health Status","Status":"passing",
        "Notes":"","Output":"Agent alive and reachable","ServiceID":"","ServiceName":""}]}]r
</pre></div>
<h2 id="distributed-configuration">Distributed Configuration</h2>
<p>A simple use case is to use the key value store to distribute other information besides services that need to be discovered, <a href="https://www.consul.io/docs/agent/http/kv.html">https://www.consul.io/docs/agent/http/kv.html</a></p>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/a-micro-story-about-migrating-a-personal-monolith-into-microservices/" title="Previous: A micro story about migrating a personal monolith into microservices">A micro story about migrating a personal monolith into microservices</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2016-08-27T21:01:00-07:00">Aug 27, 2016</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#build-CI-CD-devops-ref">build-CI-CD-devops</a> 
            <h4>~472 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#cluster-ref">cluster
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#clustering-ref">clustering
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#config-ref">config
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#consul-ref">consul
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#service-discovery-ref">service discovery
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="bitbucket, google app engine, gae, bitbucket, pipelines, ci, cd, deployment, storage.objects.list, build-CI-CD-devops, " />
        <title>Continuous Delivery with Bitbucket Pipelines and Google App Engine Deployment and the storage.objects.list error  · johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/continuous-delivery-with-bitbucket-pipelines-and-google-app-engine-deployment-and-the-storageobjectslist-error/"> Continuous Delivery with Bitbucket Pipelines and Google App Engine Deployment and the storage.objects.list error  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#google-cloud-setup">Google Cloud Setup</a></li>
<li><a href="#bitbucket-setup">Bitbucket Setup</a><ul>
<li><a href="#appyaml">app.yaml</a></li>
<li><a href="#mainpy">main.py</a></li>
</ul>
</li>
<li><a href="#bitbucket-pipelines-configuration">Bitbucket Pipelines Configuration</a><ul>
<li><a href="#configuring-the-secure-environment-variables-in-bitbucket-pipelines">Configuring the secure environment variables in Bitbucket Pipelines</a></li>
<li><a href="#bitbucket-pipelinesyml-file">bitbucket-pipelines.yml file</a></li>
<li><a href="#scriptsfetch_gae_sdkpy">scripts/fetch_gae_sdk.py</a></li>
</ul>
</li>
<li><a href="#push-a-commit-to-trigger-a-deployment">Push a commit to trigger a deployment</a></li>
<li><a href="#actually-using-automated-testing">Actually using automated testing</a></li>
<li><a href="#double-checking-security">Double checking security</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#using-docker-with-bitbucket-pipelines">Using Docker with Bitbucket Pipelines</a><ul>
<li><a href="#create-an-automated-docker-image-build-in-docker-hub">Create an automated docker image build in Docker Hub</a></li>
<li><a href="#using-a-public-image-from-docker-hub">Using a public image from Docker Hub</a></li>
<li><a href="#updating-your-bitbucket-pipelinesyml-to-use-a-public-docker-image">Updating your bitbucket-pipelines.yml to use a public docker image</a></li>
</ul>
</li>
<li><a href="#bitbucket-pipelines-and-go">Bitbucket Pipelines and Go</a></li>
<li><a href="#bitbucket-pipelines-and-testing-with-a-database">Bitbucket Pipelines and Testing with a Database</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<p>One thing that critical to writing software is actually delivering value.  That means shipping the bits, luckily the internet makes the cost of moving 1's and 0's near zero.</p>
<p>Like any other chore or drudge work the release process should be automated.</p>
<p><a href="https://en.wikipedia.org/wiki/Continuous_delivery">https://en.wikipedia.org/wiki/Continuous_delivery</a></p>
<p>I attempted to follow Google App Engine's documentation on how to setup Bitbucket Pipelines (yeah it's crazy how much free compute there is in the world such that I can tie together a free Continuous Integration service with a free Application Hosting service) but ran into a few snags I thought I'd document.</p>
<blockquote>
<p>Leveraging SaaS source control, CI, and CD means inherently placing trust in those vendors (and their ops and security teams)</p>
</blockquote>
<h2 id="google-cloud-setup">Google Cloud Setup</h2>
<p><a href="https://cloud.google.com/solutions/continuous-delivery-bitbucket-app-engine">https://cloud.google.com/solutions/continuous-delivery-bitbucket-app-engine</a></p>
<p>Besides creating an App Engine Project (python) also create the credentials to allow the automated deployment.</p>
<ol>
<li>Create a new Cloud project in Google: <a href="https://console.cloud.google.com/projectcreate">https://console.cloud.google.com/projectcreate</a></li>
<li>Also create a new App Engine Project: <a href="https://console.cloud.google.com/projectselector/appengine/create?lang=python&amp;st=true">https://console.cloud.google.com/projectselector/appengine/create?lang=python&amp;st=true</a> (you will need to choose your region such as us-central, or use the Web UI <a href="https://console.cloud.google.com/iam-admin/iam/project?project=example-john">https://console.cloud.google.com/iam-admin/iam/project?project=example-john</a> (Use the "Select a project dropdown" in the middle and in the Select menu use the + symbol on the right to "Create project")</li>
<li>Note the ID: <a href="https://console.cloud.google.com/home/dashboard?project=example-john">https://console.cloud.google.com/home/dashboard?project=example-john</a></li>
<li>BILLING on the left, enable that (and link your credit card I guess, Google are moving everything away from free - and the credit card is another way to track and correlate everything you do)</li>
<li>Enable the App Engine Admin API <a href="https://console.cloud.google.com/apis/library?project=example-john">https://console.cloud.google.com/apis/library?project=example-john</a></li>
<li>Navigate to the Google Cloud Platform Console credentials page <a href="https://console.cloud.google.com/apis/credentials?project=example-john">https://console.cloud.google.com/apis/credentials?project=example-john</a></li>
<li>Click Create credentials -&gt; Service account key</li>
<li>Select "New service account" from the Service account dropdown</li>
<li>Input a name like "Bitbucket authorization" in the Service account name field</li>
<li>ENSURE the ROLES contain at least: App Engine -&gt; <strong>App Engine Admin</strong> and Storage -&gt; <strong>Storage Admin</strong></li>
<li>Click the Create button. A copy of the JSON file will automatically download to your computer.   (if necessary on the right three dots choose "create key" -&gt; create private key for "..." JSON</li>
<li>Click Create credentials &gt; API key</li>
</ol>
<h2 id="bitbucket-setup">Bitbucket Setup</h2>
<p>Create a new repository in bitbucket that will contain the code deployed to Google App Engine (in my example I'll use the Python native one but I know soon everything will Docker based)</p>
<p>The minimum version of the two app engine python app you will need are:</p>
<h3 id="appyaml">app.yaml</h3>
<div class="highlight"><pre><span></span><span class="n">runtime</span><span class="o">:</span> <span class="n">python27</span>
<span class="n">api_version</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">threadsafe</span><span class="o">:</span> <span class="n">yes</span>

<span class="n">handlers</span><span class="o">:</span>
<span class="o">-</span> <span class="n">url</span><span class="o">:</span> <span class="o">.*</span>
  <span class="n">script</span><span class="o">:</span> <span class="n">main</span><span class="o">.</span><span class="na">app</span>

<span class="n">libraries</span><span class="o">:</span>
<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">webapp2</span>
  <span class="n">version</span><span class="o">:</span> <span class="s2">"2.5.2"</span>
</pre></div>
<p>For more info <a href="https://developers.google.com/appengine/docs/python/config/appconfig">https://developers.google.com/appengine/docs/python/config/appconfig</a></p>
<h3 id="mainpy">main.py</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">webapp2</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">)],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<p>A previous example of writing a Python web app with Google App Engine <a href="https://blog.john-pfeiffer.com/google-app-engine-python/">https://blog.john-pfeiffer.com/google-app-engine-python/</a></p>
<h2 id="bitbucket-pipelines-configuration">Bitbucket Pipelines Configuration</h2>
<p>Enable the Pipelines feature: <a href="https://bitbucket.org/johnpfeiffer/continuous-deployment-bitbucket/addon/pipelines/home#!/getting-started">https://bitbucket.org/johnpfeiffer/continuous-deployment-bitbucket/addon/pipelines/home#!/getting-started</a></p>
<h3 id="configuring-the-secure-environment-variables-in-bitbucket-pipelines">Configuring the secure environment variables in Bitbucket Pipelines</h3>
<p>Use the Bitbucket WebUI in order to securely add the three variables (project id, api key, secrets json).</p>
<p>i.e. <a href="https://bitbucket.org/johnpfeiffer/continuous-deployment-bitbucket/admin/addon/admin/pipelines/repository-variables">https://bitbucket.org/johnpfeiffer/continuous-deployment-bitbucket/admin/addon/admin/pipelines/repository-variables</a></p>
<ul>
<li>CLOUDSDK_CORE_PROJECT (the app engine project id)</li>
<li>GOOGLE_API_KEY</li>
<li>GOOGLE_CLIENT_SECRET (all of the contents of the json file pasted in)</li>
</ul>
<p><strong>Ensure the Pipelines Environment variable of GOOGLE_CLIENT_SECRET is "Secured"</strong> so it is encrypted (i.e. all asterisks in the forms or in the log output)</p>
<p>Full instructions: <a href="https://cloud.google.com/solutions/continuous-delivery-bitbucket-app-engine#setting_up_environment_variables">https://cloud.google.com/solutions/continuous-delivery-bitbucket-app-engine#setting_up_environment_variables</a></p>
<h3 id="bitbucket-pipelinesyml-file">bitbucket-pipelines.yml file</h3>
<blockquote>
<p>Before using a secret (or really any environment variables) with bitbucket pipelines you will need to have a placeholder bitbucket-pipelines.yml so that you can officially "enable" it for the repository - after that the WebUI for configuration for pipelines will become accessible =(</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="n">image</span><span class="o">:</span> <span class="n">python</span><span class="o">:</span><span class="mf">2.7</span>
<span class="n">pipelines</span><span class="o">:</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">step</span><span class="o">:</span>
        <span class="n">script</span><span class="o">:</span>
          <span class="o">-</span> <span class="n">python</span> <span class="o">--</span><span class="n">version</span>
</pre></div>
<blockquote>
<p>Use this very trivial bitbucket-pipelines.yml in order to get at least one successful validation so that you can press the "Enable" button in the Bitbucket UI (I had to zoom my browser out to workaround some broken css/javascript)</p>
</blockquote>
<p>A yaml configuration file describes the work that you instruct Bitbucket Pipelines to do, in this case we are doing the extra work of grabbing the remote google cloud SDK and installing it so that we use it with the credentials to deploy the app.</p>
<div class="highlight"><pre><span></span><span class="nv">image</span>: <span class="nv">python</span>:<span class="mi">2</span>.<span class="mi">7</span>

<span class="nv">pipelines</span>:
  <span class="nv">default</span>:
    <span class="o">-</span> <span class="nv">step</span>:
        <span class="nv">script</span>:
          <span class="o">-</span> <span class="nv">export</span> <span class="nv">CLOUDSDK_CORE_DISABLE_PROMPTS</span><span class="o">=</span><span class="mi">1</span>
          <span class="o">-</span> <span class="nv">SDK_VERSION</span><span class="o">=</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>
          <span class="o">-</span> <span class="nv">SDK_FILENAME</span><span class="o">=</span><span class="nv">google</span><span class="o">-</span><span class="nv">cloud</span><span class="o">-</span><span class="nv">sdk</span><span class="o">-</span>${<span class="nv">SDK_VERSION</span>}<span class="o">-</span><span class="nv">linux</span><span class="o">-</span><span class="nv">x86_64</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
          <span class="o">-</span> <span class="nv">curl</span> <span class="o">-</span><span class="nv">O</span> <span class="o">-</span><span class="nv">J</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">dl</span>.<span class="nv">google</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">dl</span><span class="o">/</span><span class="nv">cloudsdk</span><span class="o">/</span><span class="nv">channels</span><span class="o">/</span><span class="nv">rapid</span><span class="o">/</span><span class="nv">downloads</span><span class="o">/</span>${<span class="nv">SDK_FILENAME</span>}
          <span class="o">-</span> <span class="nv">tar</span> <span class="o">-</span><span class="nv">zxvf</span> ${<span class="nv">SDK_FILENAME</span>} <span class="o">--</span><span class="nv">directory</span> ${<span class="nv">HOME</span>}
          <span class="o">-</span> <span class="nv">export</span> <span class="nv">PATH</span><span class="o">=</span>${<span class="nv">PATH</span>}:${<span class="nv">HOME</span>}<span class="o">/</span><span class="nv">google</span><span class="o">-</span><span class="nv">cloud</span><span class="o">-</span><span class="nv">sdk</span><span class="o">/</span><span class="nv">bin</span>
          <span class="o">-</span> <span class="nv">GAE_PYTHONPATH</span><span class="o">=</span>${<span class="nv">HOME</span>}<span class="o">/</span><span class="nv">google_appengine</span>
          <span class="o">-</span> <span class="nv">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>${<span class="nv">PYTHONPATH</span>}:${<span class="nv">GAE_PYTHONPATH</span>}
          <span class="o">-</span> <span class="nv">python</span> <span class="nv">scripts</span><span class="o">/</span><span class="nv">fetch_gae_sdk</span>.<span class="nv">py</span> $<span class="ss">(</span><span class="k">dirname</span> <span class="s2">"</span><span class="s">${GAE_PYTHONPATH}</span><span class="s2">"</span><span class="ss">)</span>
          <span class="o">-</span> <span class="nv">echo</span> <span class="s2">"</span><span class="s">${PYTHONPATH}</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nv">ls</span> ${<span class="nv">GAE_PYTHONPATH</span>}
          <span class="o">-</span> <span class="nv">echo</span> <span class="s2">"</span><span class="s">key = '${GOOGLE_API_KEY}'</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="nv">api_key</span>.<span class="nv">py</span>
          <span class="o">-</span> <span class="nv">echo</span> ${<span class="nv">GOOGLE_CLIENT_SECRET</span>} <span class="o">&gt;</span> <span class="nv">client</span><span class="o">-</span><span class="nv">secret</span>.<span class="nv">json</span>
          <span class="o">-</span> <span class="nv">gcloud</span> <span class="nv">auth</span> <span class="nv">activate</span><span class="o">-</span><span class="nv">service</span><span class="o">-</span><span class="nv">account</span> <span class="o">--</span><span class="nv">key</span><span class="o">-</span><span class="nv">file</span> <span class="nv">client</span><span class="o">-</span><span class="nv">secret</span>.<span class="nv">json</span>
          <span class="o">-</span> <span class="nv">gcloud</span> <span class="o">--</span><span class="nv">verbosity</span><span class="o">=</span><span class="nv">error</span> <span class="nv">app</span> <span class="nv">deploy</span> <span class="nv">app</span>.<span class="nv">yaml</span> <span class="o">--</span><span class="nv">promote</span>
</pre></div>
<blockquote>
<p>A best practice is to pull the dependency from storage you have control over (or simply vendor the SDK in the source code) rather than downloading it every time and risking the upstream pinned version being removed</p>
</blockquote>
<ul>
<li><a href="https://bitbucket-pipelines.prod.public.atl-paas.net/validator">https://bitbucket-pipelines.prod.public.atl-paas.net/validator</a> did not work for me (crazy javascript) but in theory this would be a very helpful tool</li>
</ul>
<p>Full bitbucket pipelines documentation: <a href="https://confluence.atlassian.com/bitbucket/build-test-and-deploy-with-pipelines-792496469.html">https://confluence.atlassian.com/bitbucket/build-test-and-deploy-with-pipelines-792496469.html</a></p>
<h3 id="scriptsfetch_gae_sdkpy">scripts/fetch_gae_sdk.py</h3>
<hr/>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright 2015 Google Inc. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="c1"># Retrieved from https://github.com/Google/oauth2client</span>
<span class="sd">"""Fetch the most recent GAE SDK and decompress it in the current directory.</span>
<span class="sd">Usage:</span>
<span class="sd">    fetch_gae_sdk.py [&lt;dest_dir&gt;]</span>
<span class="sd">Current releases are listed here:</span>
<span class="sd">    https://www.googleapis.com/storage/v1/b/appengine-sdks/o?prefix=featured</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="n">_SDK_URL</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'https://www.googleapis.com/storage/v1/b/appengine-sdks/o?prefix=featured'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_gae_versions</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_info_json</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">_SDK_URL</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">version_info_json</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'items'</span><span class="p">,</span> <span class="p">{})</span>

<span class="k">def</span> <span class="nf">_version_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="n">version_string</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">version_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_sdk_urls</span><span class="p">(</span><span class="n">sdk_versions</span><span class="p">):</span>
    <span class="n">python_releases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sdk_versions</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'featured/google_appengine'</span><span class="p">)]</span>
    <span class="n">current_releases</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">python_releases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_version_tuple</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">release</span><span class="p">[</span><span class="s1">'mediaLink'</span><span class="p">]</span> <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">current_releases</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Usage: {} [&lt;destination_dir&gt;]'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">dest_dir</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">'.'</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="s1">'google_appengine'</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'GAE SDK already installed at {}, exiting.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">sdk_versions</span> <span class="o">=</span> <span class="n">get_gae_versions</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sdk_versions</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Error fetching GAE SDK version info'</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">sdk_urls</span> <span class="o">=</span> <span class="n">get_sdk_urls</span><span class="p">(</span><span class="n">sdk_versions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sdk_url</span> <span class="ow">in</span> <span class="n">sdk_urls</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sdk_contents</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">sdk_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Could not read SDK from any of {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sdk_urls</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">sdk_contents</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zip_contents</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">sdk_contents</span><span class="p">)</span>
        <span class="n">zip_contents</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'GAE SDK Installed to {}.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Error extracting SDK contents'</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]))</span>
</pre></div>
<blockquote>
<p>This is google's script to download and extract their App Engine SDK , included here only for completeness</p>
</blockquote>
<h2 id="push-a-commit-to-trigger-a-deployment">Push a commit to trigger a deployment</h2>
<p>The whole point of all of that work is to make life easier for every commit that follows.</p>
<div class="highlight"><pre><span></span><span class="n">git</span> <span class="k">add</span> <span class="c1">--all .</span>
<span class="n">git</span> <span class="k">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s1">'example google app engine app deployed via bitbucket pipelines'</span>
<span class="n">git</span> <span class="n">push</span>
</pre></div>
<p>You can monitor the results of every change in the Addon's output logs:</p>
<ul>
<li><a href="https://bitbucket.org/johnpfeiffer/continuous-deployment-bitbucket/addon/pipelines/home#!/">https://bitbucket.org/johnpfeiffer/continuous-deployment-bitbucket/addon/pipelines/home#!/</a></li>
</ul>
<p>You can monitor the deployment history in Google App Engine's console:</p>
<ul>
<li><a href="https://console.cloud.google.com/appengine/versions?project=bitbucket-pipelines&amp;serviceId=default">https://console.cloud.google.com/appengine/versions?project=bitbucket-pipelines&amp;serviceId=default</a></li>
</ul>
<p>And of course see the currently deployed application in action:</p>
<ul>
<li><a href="https://bitbucket-pipelines.appspot.com/">https://bitbucket-pipelines.appspot.com/</a></li>
</ul>
<h2 id="actually-using-automated-testing">Actually using automated testing</h2>
<p>CI (continuous integration) testing is the ideal next thing to add as this allows you to automatically prevent critical errors from being deployed to production.</p>
<p>This means adding unit tests (test_main.py) and then running them by updating bitbucket-pipelines.yml</p>
<div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">python</span> <span class="n">test_main</span><span class="p">.</span><span class="n">py</span>
</pre></div>
<p>It is also possible to keep extending the work required by installing any requirements.txt dependencies (i.e. only required for testing) or running post deployment end-to-end smoke tests.</p>
<h2 id="double-checking-security">Double checking security</h2>
<p>If your repository is public the pipelines log outputs will be public.  Double check that you are not "leaking" your API key, secrets, or hardcoded passwords. =|</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p><strong>The current Google Cloud project [go-lanscan] does not contain an App Engine application. Use <code>gcloud app create</code> to initialize an App Engine application within the project.</strong></p>
<blockquote>
<p>You need to create the initial app engine project, either with the WebUI <a href="https://console.cloud.google.com/appengine/start?project=bitbucket-pipelines">https://console.cloud.google.com/appengine/start?project=bitbucket-pipelines</a> or using the GCloud CLI</p>
</blockquote>
<p><em>You will need to be prompted for your region, i.e. us-central</em></p>
<p><strong>"Does not contain a valid app engine project"</strong></p>
<blockquote>
<p>Most likely the app.yaml has deprecated fields or invalid characters</p>
</blockquote>
<p><strong>"does not contain an App Engine application."</strong></p>
<blockquote>
<p>Most likely the app.yaml has deprecated fields or invalid characters, or maybe missing a main.py altogether</p>
</blockquote>
<p><strong>"ERROR: The [application] field is specified in file [/opt/atlassian/pipelines/agent/build/app.yaml]"</strong></p>
<blockquote>
<p>This is because previously app.yaml included "application" and "version" but those lines are now deprecated, delete them</p>
</blockquote>
<p><strong>"You do not have permission to access app "</strong></p>
<blockquote>
<p>Most likely the Role of "App Engine Admin" still needs to be added, use the IAM for the project to update the Permissions</p>
</blockquote>
<p>e.g. <a href="https://console.cloud.google.com/iam-admin/iam/project?project=bitbucket-pipelines">https://console.cloud.google.com/iam-admin/iam/project?project=bitbucket-pipelines</a></p>
<p>Or ensure you have an API key generated and added to the Bitbucket Pipelines environment ... or delete all API keys and service accounts and do them again (because it seems to get stuck if you have encrypted API key or something)</p>
<ul>
<li><a href="https://console.cloud.google.com/apis/credentials?project=bitbucket-pipelines">https://console.cloud.google.com/apis/credentials?project=bitbucket-pipelines</a></li>
<li><a href="https://console.cloud.google.com/iam-admin/serviceaccounts/project?project=bitbucket-pipelines">https://console.cloud.google.com/iam-admin/serviceaccounts/project?project=bitbucket-pipelines</a></li>
</ul>
<p><strong>"Caller does not have storage.objects.list access to bucket staging.bitbucket-pipelines.appspot.com."</strong></p>
<blockquote>
<p>Ensure the Role "Storage Object Admin" was added to the Roles during creation, see above</p>
</blockquote>
<p>This guy got really close and helped me find the hint about Storage Object Admin: <a href="http://www.deadunicornz.org/blog/2017/01/31/travis-ci-and-deploying-golang-apps-to-gae/">http://www.deadunicornz.org/blog/2017/01/31/travis-ci-and-deploying-golang-apps-to-gae/</a></p>
<h2 id="using-docker-with-bitbucket-pipelines">Using Docker with Bitbucket Pipelines</h2>
<p>I could reduce the time required to build (and decouple the build stages) by using a Docker image that already contains the GCloud SDK.</p>
<p>This also extends the flexibility if part of your build flow is to build and tag a Docker image as an artifact that can be used for multiple tests (i.e. parallelization) and especially if you are already using Docker in Production.</p>
<h3 id="create-an-automated-docker-image-build-in-docker-hub">Create an automated docker image build in Docker Hub</h3>
<p>Link a source code repository to Docker (sadly the bitbucket one requires overly broad permissions whereas the github one only requires public read)</p>
<p>Follow the steps in their tutorial to create a repository with a Dockerfile and then have it auto-build an image and upload it to Docker Hub</p>
<ul>
<li><a href="https://docs.docker.com/docker-hub/builds/">https://docs.docker.com/docker-hub/builds/</a></li>
<li><a href="https://hub.docker.com/r/foupfeiffer/gcloud-sdk/~/dockerfile/">https://hub.docker.com/r/foupfeiffer/gcloud-sdk/~/dockerfile/</a></li>
</ul>
<blockquote>
<p>Unfortunately sometimes you have to just log in to Docker Hub and press the "Trigger" button to start the build since "automatically" does not seem to trigger correctly, e.g. <a href="https://hub.docker.com/r/foupfeiffer/gcloud-sdk/~/settings/automated-builds/">https://hub.docker.com/r/foupfeiffer/gcloud-sdk/~/settings/automated-builds/</a></p>
</blockquote>
<h3 id="using-a-public-image-from-docker-hub">Using a public image from Docker Hub</h3>
<p>To verify App Engine publishing from the Docker container manually: 
<code>docker run --rm -it --volume /opt/mysecrets:/opt/mysecrets --volume /opt/myrepo:/opt/myrepo foupfeiffer/gcloud-sdk /bin/bash</code></p>
<p>Run these commands in the Docker container...</p>
<div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mysecrets</span><span class="o">/</span><span class="n">api_key</span><span class="p">.</span><span class="n">py</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">myrepo</span>
<span class="n">export</span> <span class="n">CLOUDSDK_CORE_DISABLE_PROMPTS</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">CLOUDSDK_CORE_PROJECT</span><span class="o">=</span><span class="n">example</span><span class="o">-</span><span class="n">gae</span><span class="o">-</span><span class="n">id</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">myrepo</span>
<span class="n">gcloud</span> <span class="n">auth</span> <span class="n">activate</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">account</span> <span class="c1">--key-file /opt/mysecrets/client-secret.json</span>
<span class="n">gcloud</span> <span class="c1">--verbosity=error app deploy app.yaml --promote</span>
</pre></div>
<blockquote>
<p>You are about to deploy the following services: Uploading 7 files to Google Cloud Storage</p>
</blockquote>
<p><em>This assumes you have already correctly setup your Google Cloud Project, Google App Engine Project, Google Permissions, and that your repository has the correct app.yaml and main.py</em></p>
<h3 id="updating-your-bitbucket-pipelinesyml-to-use-a-public-docker-image">Updating your bitbucket-pipelines.yml to use a public docker image</h3>
<p>With your open sourced Dockerfile and docker image built in docker hub we can simplify some of the steps in our previous bitbucket-pipelines.yml file:</p>
<div class="highlight"><pre><span></span><span class="n">image</span><span class="o">:</span> <span class="n">foupfeiffer</span><span class="o">/</span><span class="n">gcloud</span><span class="o">-</span><span class="n">sdk</span>

<span class="n">pipelines</span><span class="o">:</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">step</span><span class="o">:</span>
        <span class="n">script</span><span class="o">:</span>
          <span class="o">-</span> <span class="n">export</span> <span class="n">CLOUDSDK_CORE_DISABLE_PROMPTS</span><span class="o">=</span><span class="mi">1</span>
          <span class="o">-</span> <span class="n">echo</span> <span class="s2">"key = '${GOOGLE_API_KEY}'"</span> <span class="o">&gt;</span> <span class="n">api_key</span><span class="o">.</span><span class="na">py</span>
          <span class="o">-</span> <span class="n">echo</span> <span class="n">$</span><span class="o">{</span><span class="n">GOOGLE_CLIENT_SECRET</span><span class="o">}</span> <span class="o">&gt;</span> <span class="n">client</span><span class="o">-</span><span class="n">secret</span><span class="o">.</span><span class="na">json</span>
          <span class="o">-</span> <span class="n">gcloud</span> <span class="n">auth</span> <span class="n">activate</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">account</span> <span class="o">--</span><span class="n">key</span><span class="o">-</span><span class="n">file</span> <span class="n">client</span><span class="o">-</span><span class="n">secret</span><span class="o">.</span><span class="na">json</span>
          <span class="o">-</span> <span class="n">gcloud</span> <span class="o">--</span><span class="n">verbosity</span><span class="o">=</span><span class="n">error</span> <span class="n">app</span> <span class="n">deploy</span> <span class="n">app</span><span class="o">.</span><span class="na">yaml</span> <span class="o">--</span><span class="n">promote</span>
</pre></div>
<blockquote>
<p>One you have pushed this change every future build will have the capabilities of your docker image (i.e. go build)</p>
</blockquote>
<ul>
<li><a href="https://confluence.atlassian.com/bitbucket/use-docker-images-as-build-environments-in-bitbucket-pipelines-792298897.html">https://confluence.atlassian.com/bitbucket/use-docker-images-as-build-environments-in-bitbucket-pipelines-792298897.html</a></li>
<li><a href="https://confluence.atlassian.com/bitbucket/debug-your-pipelines-locally-with-docker-838273569.html">https://confluence.atlassian.com/bitbucket/debug-your-pipelines-locally-with-docker-838273569.html</a></li>
</ul>
<h2 id="bitbucket-pipelines-and-go">Bitbucket Pipelines and Go</h2>
<p>This article was about deploying a python application (which in my use case happened to distribute a Go binary).</p>
<p>For more information about a Golang application with Go Build and Tests...</p>
<ul>
<li><a href="https://bitbucket.org/atlassian/pipelines-examples-go/">https://bitbucket.org/atlassian/pipelines-examples-go/</a></li>
<li><a href="https://bitbucket.org/atlassian/pipelines-examples-go/src/master/bitbucket-pipelines.yml">https://bitbucket.org/atlassian/pipelines-examples-go/src/master/bitbucket-pipelines.yml</a></li>
<li><a href="https://bitbucket-pipelines.prod.public.atl-paas.net/validator">https://bitbucket-pipelines.prod.public.atl-paas.net/validator</a></li>
</ul>
<h2 id="bitbucket-pipelines-and-testing-with-a-database">Bitbucket Pipelines and Testing with a Database</h2>
<p>There is an example of how to leverage two of the most common databases, MySQL and Postgres, in your testing pipeline:</p>
<ul>
<li><a href="https://confluence.atlassian.com/bitbucket/test-with-databases-in-bitbucket-pipelines-856697462.html">https://confluence.atlassian.com/bitbucket/test-with-databases-in-bitbucket-pipelines-856697462.html</a></li>
</ul>
<p>Obviously since you can execute the pipeline with your own customer Docker image you can extend and build your required test/environment dependencies.</p>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/mid-2017-technology-and-business-prediction-for-2018-and-beyond/" title="Previous: Mid 2017 technology and business prediction for 2018 and beyond">Mid 2017 technology and business prediction for 2018 and beyond</a></li>
 
                <li class="next_article"><a href="https://blog.john-pfeiffer.com/productivity-is-a-myth/" title="Next: Productivity is a Myth">Productivity is a Myth</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2017-05-23T22:24:00-07:00">May 23, 2017</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#build-CI-CD-devops-ref">build-CI-CD-devops</a> 
            <h4>~1886 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#bitbucket-ref">bitbucket
                    <span>4</span>
</a></li>
                <li><a href="/tags.html#bitbucket-ref">bitbucket
                    <span>4</span>
</a></li>
                <li><a href="/tags.html#cd-ref">cd
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#ci-ref">ci
                    <span>3</span>
</a></li>
                <li><a href="/tags.html#deployment-ref">deployment
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#gae-ref">gae
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#google-app-engine-ref">google app engine
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#pipelines-ref">pipelines
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#storage.objects.list-ref">storage.objects.list
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
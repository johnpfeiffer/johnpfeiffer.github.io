<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="go, golang, aws, lambda, apigateway, cdk, build-CI-CD-devops, " />
        <title>Using AWS CDK to configure deploy a Golang Lambda with APIGateway  · johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/using-aws-cdk-to-configure-deploy-a-golang-lambda-with-apigateway/"> Using AWS CDK to configure deploy a Golang Lambda with APIGateway  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#install-the-aws-cdk-tool">Install the AWS CDK Tool</a></li>
<li><a href="#setup-the-project-directories">Setup the project directories</a></li>
<li><a href="#install-the-dependencies-for-aws-resources-that-cdk-will-manage">Install the dependencies for AWS resources that CDK will manage</a></li>
<li><a href="#write-the-actual-infrastructure-code">Write the actual Infrastructure Code</a><ul>
<li><a href="#output-cloudformation-from-a-cdk-typescript-file">Output CloudFormation from a CDK Typescript file</a></li>
</ul>
</li>
<li><a href="#deploy-resources-that-cdk-has-defined">Deploy resources that CDK has defined</a><ul>
<li><a href="#verify-the-new-bucket-was-created">Verify the new bucket was created</a></li>
</ul>
</li>
<li><a href="#making-updates-with-cdk">Making updates with CDK</a><ul>
<li><a href="#preview-changes-with-diff">Preview changes with diff</a></li>
<li><a href="#apply-the-new-changes">Apply the new changes</a></li>
</ul>
</li>
<li><a href="#apigateway-plus-lambda-plus-go">APIGateway plus Lambda plus Go</a><ul>
<li><a href="#a-tiny-go-web-request-handler">A tiny Go Web Request Handler</a></li>
<li><a href="#cdk-with-a-golang-lambda">CDK with a Golang Lambda</a></li>
<li><a href="#cdk-with-an-apigateway-integrated-with-a-go-lambda">CDK with an APIGateway integrated with a Go Lambda</a></li>
</ul>
</li>
<li><a href="#verify-your-new-api-gateway-and-golang-lambda-with-curl">Verify your new API Gateway and Golang Lambda with CURL</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<p>Infrastructure as Code helps guarantee the elusive determinism we all seek in building applications and services.</p>
<p>AWS have brought their own specific product out which competes with the venerable Terraform and nicely focused Serverless.</p>
<p><em>All of these products use the json syntax of CloudFormation which is the foundational AWS syntax for describing resources</em></p>
<p>It is straightforward to iteratively setup and use AWS CDK (with the native Typescript syntax).</p>
<p><em>TODO: later add a quick CDK vocabulary guide</em></p>
<h2 id="install-the-aws-cdk-tool">Install the AWS CDK Tool</h2>
<p>Have to use npm to install the cdk tool...</p>
<p><code>npm install -g aws-cdk</code></p>
<h2 id="setup-the-project-directories">Setup the project directories</h2>
<p><code>mkdir cdk-example</code></p>
<p><code>cd cdk-example</code></p>
<p>Create a subdirectory to compartmentalize all the infrastructure code (from the rest of the application)</p>
<p><code>mkdir infra</code></p>
<p><code>cd infra</code></p>
<p><code>cdk init app --language typescript</code></p>
<p><code>cdk ls</code></p>
<blockquote>
<div class="highlight"><pre><span></span><span class="err">   InfraStack</span>
</pre></div>
<p>Names are hard but whatever you pick, like <strong>"Infra"</strong>, will then show up in the AWS resources everywhere related to this project</p>
</blockquote>
<h2 id="install-the-dependencies-for-aws-resources-that-cdk-will-manage">Install the dependencies for AWS resources that CDK will manage</h2>
<p>Option 1: manually install dependencies <em>(it will automatically insert this into package.json)</em></p>
<p><code>npm install @aws-cdk/aws-s3 @aws-cdk/aws-lambda</code></p>
<p>Option 2: write the lines into packages.json and run at the command line in the infra directory: <code>npm install</code></p>
<blockquote>
<p>Writing files first (and ensuring they are in version control) is a more IaaC pattern</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="s2">"dependencies"</span><span class="err">:</span> <span class="p">{</span>
  <span class="nt">"@aws-cdk/aws-s3"</span><span class="p">:</span> <span class="s2">"*"</span><span class="p">,</span>
  <span class="nt">"@aws-cdk/core"</span><span class="p">:</span> <span class="s2">"*"</span><span class="p">,</span>
  <span class="nt">"source-map-support"</span><span class="p">:</span> <span class="s2">"^0.5.16"</span>
<span class="p">}</span>
</pre></div>
<h2 id="write-the-actual-infrastructure-code">Write the actual Infrastructure Code</h2>
<p>The initial application template creates an empty "class" that represents the "stack"
<em>A stack is the group of resources together</em></p>
<p><strong>lib/infra-stack.ts</strong> has only 2 changes to the default file, the import of S3 and the new Bucket resource "MyExampleBucket"</p>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">cdk</span> <span class="nx">from</span> <span class="s1">'@aws-cdk/core'</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">s3</span> <span class="nx">from</span> <span class="s1">'@aws-cdk/aws-s3'</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">InfraStack</span> <span class="kr">extends</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Stack</span> <span class="p">{</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="nx">scope</span>: <span class="kt">cdk.Construct</span><span class="p">,</span> <span class="nx">id</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">props?</span>: <span class="kt">cdk.StackProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

    <span class="k">new</span> <span class="nx">s3</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">'MyExampleBucket'</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">versioned</span>: <span class="kt">true</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>The import renames are important to be consistent in subsequent code, so if something is "cdk" then it is cdk.Construct</p>
</blockquote>
<h3 id="output-cloudformation-from-a-cdk-typescript-file">Output CloudFormation from a CDK Typescript file</h3>
<p><code>cdk synth</code></p>
<blockquote>
<p>this command will output to the display the CloudFormation that will be sent/used by AWS</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="nt">Resources</span><span class="p">:</span>
  <span class="nt">MyExampleBucket8D68EFCA</span><span class="p">:</span>
    <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::S3::Bucket</span>
    <span class="nt">Properties</span><span class="p">:</span>
      <span class="nt">VersioningConfiguration</span><span class="p">:</span>
        <span class="nt">Status</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Enabled</span>
    <span class="nt">UpdateReplacePolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
    <span class="nt">DeletionPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
    <span class="nt">Metadata</span><span class="p">:</span>
      <span class="l l-Scalar l-Scalar-Plain">aws:cdk:path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">InfraStack/MyExampleBucket/Resource</span>
  <span class="nt">CDKMetadata</span><span class="p">:</span>
    <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::CDK::Metadata</span>
    <span class="nt">Properties</span><span class="p">:</span>
</pre></div>
<p>To preview what will occur between changes to the .ts file...</p>
<p><code>cdk diff</code></p>
<h2 id="deploy-resources-that-cdk-has-defined">Deploy resources that CDK has defined</h2>
<p><code>cdk deploy</code></p>
<blockquote>
<p>warning, really making a change in AWS (based on your creds)</p>
</blockquote>
<div class="highlight"><pre><span></span>InfraStack

InfraStack: deploying...
InfraStack: creating CloudFormation changeset...
<span class="o">(</span><span class="m">3</span>/3<span class="o">)</span>

Stack ARN:
arn:aws:cloudformation:us-east-1:409670809604:stack/InfraStack/b5167030-00fb-11eb-9f36-12f8925a37c4
</pre></div>
<h3 id="verify-the-new-bucket-was-created">Verify the new bucket was created</h3>
<p><code>aws s3 ls | grep MyExampleBucket</code></p>
<p><em>this assumes you have installed the AWS CLI like <code>sudo apt install awscli</code></em></p>
<p><code>aws cloudformation list-stacks | grep InfraStack</code></p>
<blockquote>
<p>this listing will also show deleted Stacks</p>
</blockquote>
<h2 id="making-updates-with-cdk">Making updates with CDK</h2>
<p>A tiny snippet change to allow bucket deletion...</p>
<ul>
<li><a href="https://docs.aws.amazon.com/cdk/latest/guide/hello_world.html">https://docs.aws.amazon.com/cdk/latest/guide/hello_world.html</a></li>
<li><a href="https://docs.aws.amazon.com/cdk/api/latest/typescript/api/aws-s3.html">https://docs.aws.amazon.com/cdk/api/latest/typescript/api/aws-s3.html</a></li>
<li><a href="https://docs.aws.amazon.com/cdk/api/latest/typescript/api/aws-s3/bucketpolicyprops.html#aws_s3_BucketPolicyProps">https://docs.aws.amazon.com/cdk/api/latest/typescript/api/aws-s3/bucketpolicyprops.html#aws_s3_BucketPolicyProps</a></li>
<li>
<p><a href="https://docs.aws.amazon.com/cdk/api/latest/typescript/api/core/removalpolicy.html#core_RemovalPolicy">https://docs.aws.amazon.com/cdk/api/latest/typescript/api/core/removalpolicy.html#core_RemovalPolicy</a></p>
<p>:::typescript
new s3.Bucket(this, 'MyExampleBucket', {
  versioned: true,
      removalPolicy: cdk.RemovalPolicy.DESTROY
});</p>
</li>
</ul>
<h3 id="preview-changes-with-diff">Preview changes with diff</h3>
<p><code>cdk diff</code></p>
<div class="highlight"><pre><span></span>Stack InfraStack
Resources
<span class="o">[</span>~<span class="o">]</span> AWS::S3::Bucket JohnPBucket JohnPBucket8D68EFCA
 ├─ <span class="o">[</span>~<span class="o">]</span> DeletionPolicy
 │   ├─ <span class="o">[</span>-<span class="o">]</span> Retain
 │   └─ <span class="o">[</span>+<span class="o">]</span> Delete
 └─ <span class="o">[</span>~<span class="o">]</span> UpdateReplacePolicy
     ├─ <span class="o">[</span>-<span class="o">]</span> Retain
     └─ <span class="o">[</span>+<span class="o">]</span> Delete
</pre></div>
<h3 id="apply-the-new-changes">Apply the new changes</h3>
<p><code>cdk deploy</code></p>
<div class="highlight"><pre><span></span>InfraStack: deploying...
InfraStack: creating CloudFormation changeset...
</pre></div>
<p><code>cdk destroy</code></p>
<p><code>aws s3 ls | grep MyExampleBucket</code></p>
<p><code>aws cloudformation list-stacks | grep InfraStack</code></p>
<p>CDK enables "InfrastructureAsCode" and command line (or scripted) resource management, yet you must still understand the intricacies of the domain (i.e. that s3 buckets have policies and do not get destroyed by default)</p>
<blockquote>
<p>s3 buckets are designed by default to not delete with a Stack, you must change the removal policy to do so</p>
</blockquote>
<hr/>
<h2 id="apigateway-plus-lambda-plus-go">APIGateway plus Lambda plus Go</h2>
<h3 id="a-tiny-go-web-request-handler">A tiny Go Web Request Handler</h3>
<p>Put a simple placeholder Golang Lambda in place <em>using the Gin web framework for convenience</em></p>
<p><code>mkdir cdk-example/examplefunction/ ; cd cdk-example/examplefunction/</code></p>
<p><code>vim main.go</code></p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s2">"context"</span>
        <span class="s2">"log"</span>

        <span class="s2">"github.com/aws/aws-lambda-go/events"</span>
        <span class="s2">"github.com/aws/aws-lambda-go/lambda"</span>
        <span class="s2">"github.com/awslabs/aws-lambda-go-api-proxy/gin"</span>
        <span class="s2">"github.com/gin-gonic/gin"</span>
<span class="p">)</span>

<span class="n">var</span> <span class="n">ginLambda</span> <span class="o">*</span><span class="n">ginadapter</span><span class="o">.</span><span class="n">GinLambda</span>

<span class="o">//</span> <span class="k">for</span> <span class="n">convenience</span> <span class="n">leverage</span> <span class="n">the</span> <span class="n">Go</span> <span class="n">init</span> <span class="n">startup</span> <span class="n">concept</span> <span class="n">to</span> <span class="n">define</span> <span class="n">a</span> <span class="k">global</span> <span class="n">web</span> <span class="n">server</span> <span class="nb">object</span>
<span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">stdout</span> <span class="ow">and</span> <span class="n">stderr</span> <span class="n">are</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">AWS</span> <span class="n">CloudWatch</span> <span class="n">Logs</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">"Gin starting"</span><span class="p">)</span>
        <span class="n">r</span> <span class="p">:</span><span class="o">=</span> <span class="n">gin</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="s2">"/ping"</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">gin</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">c</span><span class="o">.</span><span class="n">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">gin</span><span class="o">.</span><span class="n">H</span><span class="p">{</span>
                        <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"pong"</span><span class="p">,</span>
                <span class="p">})</span>
        <span class="p">})</span>
        <span class="n">ginLambda</span> <span class="o">=</span> <span class="n">ginadapter</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="p">}</span>


<span class="o">//</span> <span class="n">Handler</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">function</span> <span class="n">that</span> <span class="n">executes</span> <span class="k">for</span> <span class="n">every</span> <span class="n">Request</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">Lambda</span>
<span class="n">func</span> <span class="n">Handler</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyRequest</span><span class="p">)</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">APIGatewayProxyResponse</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ginLambda</span><span class="o">.</span><span class="n">ProxyWithContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">lambda</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">Handler</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p><code>go mod init</code></p>
<blockquote>
<p>Ensure dependencies (like the AWS SDK) are recognized by the Go package manager</p>
</blockquote>
<p><code>go test</code></p>
<blockquote>
<p>This is the simplest way to trigger downloading the dependencies (imported packages)</p>
</blockquote>
<p><a href="https://blog.golang.org/using-go-modules">https://blog.golang.org/using-go-modules</a></p>
<p><code>GOOS=linux GOARCH=amd64 go build -o main main.go</code></p>
<blockquote>
<p>compile for the target arch , AWS Lambda ("firecracker") is Linux =]</p>
</blockquote>
<p><a href="https://www.usenix.org/system/files/nsdi20-paper-agache.pdf">https://www.usenix.org/system/files/nsdi20-paper-agache.pdf</a></p>
<h3 id="cdk-with-a-golang-lambda">CDK with a Golang Lambda</h3>
<p>No working from just the "infra" subdirectory in our project:</p>
<ul>
<li><strong>cdk-example/infra/package.json</strong></li>
<li><strong>cdk-example/infra/lib/infra-stack.ts</strong></li>
</ul>
<p><code>cd cdk-example/infra/</code></p>
<p>First update <strong>package.json</strong></p>
<div class="highlight"><pre><span></span><span class="s2">"dependencies"</span><span class="o">:</span> <span class="p">{</span>
  <span class="s2">"@aws-cdk/core"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
  <span class="s2">"@aws-cdk/aws-s3"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
  <span class="s2">"@aws-cdk/aws-s3-assets"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
  <span class="s2">"@aws-cdk/aws-lambda"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
  <span class="s2">"source-map-support"</span><span class="o">:</span> <span class="s2">"^0.5.16"</span>
<span class="p">}</span>
</pre></div>
<p>Do not forget to <code>npm install</code></p>
<p>Next update the <strong>lib/infra-stack.ts</strong></p>
<blockquote>
<p>Layout the resources from the deepest dependency first, so in this case a place for the golang function to be zipped</p>
</blockquote>
<ul>
<li><a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-s3-assets-readme.html">https://docs.aws.amazon.com/cdk/api/latest/docs/aws-s3-assets-readme.html</a></li>
<li>
<p><a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-lambda-readme.html#handler-code">https://docs.aws.amazon.com/cdk/api/latest/docs/aws-lambda-readme.html#handler-code</a></p>
<p>:::typescript
import * as cdk from '@aws-cdk/core';
import * as s3 from '@aws-cdk/aws-s3';
import * as lambda from '@aws-cdk/aws-lambda';
import assets = require("@aws-cdk/aws-s3-assets")
import path = require("path")</p>
<p>export class InfraStack extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Golang</span> <span class="n">binaries</span> <span class="n">must</span> <span class="n">have</span> <span class="n">a</span> <span class="n">place</span> <span class="k">where</span> <span class="n">they</span> <span class="k">are</span> <span class="n">uploaded</span> <span class="k">to</span> <span class="n">s3</span> <span class="k">as</span> <span class="n">a</span> <span class="p">.</span><span class="n">zip</span>
<span class="n">const</span> <span class="n">asset</span> <span class="o">=</span> <span class="k">new</span> <span class="n">assets</span><span class="p">.</span><span class="n">Asset</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="s1">'ExampleFunctionZip'</span><span class="p">,</span> <span class="err">{</span>
  <span class="n">path</span><span class="p">:</span> <span class="n">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">,</span> <span class="s1">'../../examplefunction'</span><span class="p">),</span>
<span class="err">}</span><span class="p">);</span>

<span class="n">const</span> <span class="k">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">lambda</span><span class="p">.</span><span class="k">Function</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="ss">"ExampleFunction"</span><span class="p">,</span> <span class="err">{</span>
  <span class="n">runtime</span><span class="p">:</span> <span class="n">lambda</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">GO_1_X</span><span class="p">,</span>
  <span class="k">handler</span><span class="p">:</span> <span class="ss">"main"</span><span class="p">,</span>
  <span class="n">code</span><span class="p">:</span> <span class="n">lambda</span><span class="p">.</span><span class="n">Code</span><span class="p">.</span><span class="n">fromBucket</span><span class="p">(</span>
    <span class="n">asset</span><span class="p">.</span><span class="n">bucket</span><span class="p">,</span>
    <span class="n">asset</span><span class="p">.</span><span class="n">s3ObjectKey</span>
  <span class="p">),</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>
<p>}
}</p>
</li>
</ul>
<p><code>cdk synth</code></p>
<blockquote>
<p>outputting the CloudFormation is a quick way to valied the syntax and see any warnings</p>
</blockquote>
<p><code>cdk deploy</code></p>
<div class="highlight"><pre><span></span>InfraStack: deploying...
<span class="o">[</span><span class="m">0</span>%<span class="o">]</span> start: Publishing 05e95f6b38c932a779e68a7a685e9950eca688e775c77f84787f6fa3e2ade474:current
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> success: Published 05e95f6b38c932a779e68a7a685e9950eca688e775c77f84787f6fa3e2ade474:current
InfraStack: creating CloudFormation changeset...
 <span class="o">(</span><span class="m">4</span>/4<span class="o">)</span>
 InfraStack

Stack ARN:
arn:aws:cloudformation:us-east-1:409670809604:stack/InfraStack/248d2960-0104-11eb-8cc5-0ac853a0932f
</pre></div>
<blockquote>
<p>Use the AWS Console UI and visually look at the cloud formation stacks</p>
</blockquote>
<p>e.g. <a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/">https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/</a></p>
<p>When you filter and click on your new stack (e.g. InfraStack) you will be able to see the Resources associated with that stack</p>
<p>The default policy "AWSLambdaBasicExecutionRole" will actually allow the Lambda to output logs to Cloudwatch</p>
<h3 id="cdk-with-an-apigateway-integrated-with-a-go-lambda">CDK with an APIGateway integrated with a Go Lambda</h3>
<p>Create the APIG and attach it to the Lambda:</p>
<p>First update <strong>infra/package.json</strong></p>
<div class="highlight"><pre><span></span>  <span class="s2">"dependencies"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"@aws-cdk/aws-apigateway"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
    <span class="s2">"@aws-cdk/aws-lambda"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
    <span class="s2">"@aws-cdk/aws-s3"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
    <span class="s2">"@aws-cdk/aws-s3-assets"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
    <span class="s2">"@aws-cdk/core"</span><span class="o">:</span> <span class="s2">"*"</span><span class="p">,</span>
    <span class="s2">"source-map-support"</span><span class="o">:</span> <span class="s2">"^0.5.16"</span>
  <span class="p">}</span>
</pre></div>
<p><code>npm install</code></p>
<p>Define the API Gateway in CDK <em>(only adding a few more lines)</em></p>
<p><a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-apigateway-readme.html#aws-lambda-backed-apis">https://docs.aws.amazon.com/cdk/api/latest/docs/aws-apigateway-readme.html#aws-lambda-backed-apis</a></p>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">cdk</span> <span class="nx">from</span> <span class="s1">'@aws-cdk/core'</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">s3</span> <span class="nx">from</span> <span class="s1">'@aws-cdk/aws-s3'</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">lambda</span> <span class="nx">from</span> <span class="s1">'@aws-cdk/aws-lambda'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">assets</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"@aws-cdk/aws-s3-assets"</span><span class="p">)</span>
<span class="kr">import</span> <span class="nx">apigw</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"@aws-cdk/aws-apigateway"</span><span class="p">)</span>
<span class="kr">import</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>


<span class="kr">export</span> <span class="kr">class</span> <span class="nx">InfraStack</span> <span class="kr">extends</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">Stack</span> <span class="p">{</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="nx">scope</span>: <span class="kt">cdk.Construct</span><span class="p">,</span> <span class="nx">id</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">props?</span>: <span class="kt">cdk.StackProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span>

    <span class="c1">// Golang binaries must have a place where they are uploaded to s3 as a .zip</span>
    <span class="kr">const</span> <span class="nx">asset</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">assets</span><span class="p">.</span><span class="nx">Asset</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">'ExampleFunctionZip'</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">path</span>: <span class="kt">path.join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'../../examplefunction'</span><span class="p">),</span>
    <span class="p">});</span>

    <span class="kr">const</span> <span class="nx">myhandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">lambda</span><span class="p">.</span><span class="nb">Function</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">"ExampleFunction"</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">runtime</span>: <span class="kt">lambda.Runtime.GO_1_X</span><span class="p">,</span>
      <span class="nx">handler</span><span class="o">:</span> <span class="s2">"main"</span><span class="p">,</span>
      <span class="nx">code</span>: <span class="kt">lambda.Code.fromBucket</span><span class="p">(</span>
        <span class="nx">asset</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span>
        <span class="nx">asset</span><span class="p">.</span><span class="nx">s3ObjectKey</span>
      <span class="p">),</span>
    <span class="p">});</span>

    <span class="c1">// all routes (and REST verbs) will pass through to the lambda</span>
    <span class="kr">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">apigw</span><span class="p">.</span><span class="nx">LambdaRestApi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">'examplefunction'</span><span class="p">,</span> <span class="p">{</span><span class="nx">handler</span>: <span class="kt">myhandler</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>one gotcha is the ordering of imports, have the "path" one last</p>
</blockquote>
<p><code>cdk synth</code></p>
<blockquote>
<p>now the CloudFormation is very verbose =|</p>
</blockquote>
<p><em>upon inspection you will see the type of integration Lambda is as desired, AWS_PROXY</em></p>
<p><code>cdk deploy</code></p>
<blockquote>
<p>There is a warning about security because AssumeRole</p>
</blockquote>
<div class="highlight"><pre><span></span>InfraStack: deploying...
<span class="o">[</span><span class="m">0</span>%<span class="o">]</span> start: Publishing 05e95f6b38c932a779e68a7a685e9950eca688e775c77f84787f6fa3e2ade474:current
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> success: Published 05e95f6b38c932a779e68a7a685e9950eca688e775c77f84787f6fa3e2ade474:current
InfraStack: creating CloudFormation changeset...
  <span class="o">(</span><span class="m">14</span>/14<span class="o">)</span>
InfraStack

Outputs:
InfraStack.examplefunctionEndpoint65D9943D <span class="o">=</span> https://abc123.execute-api.us-east-1.amazonaws.com/prod/

Stack ARN:
arn:aws:cloudformation:us-east-1:409670809604:stack/InfraStack/248d2960-0104-11eb-8cc5-0ac853a0932f
</pre></div>
<h2 id="verify-your-new-api-gateway-and-golang-lambda-with-curl">Verify your new API Gateway and Golang Lambda with CURL</h2>
<p>The very helpful output means you can use <code>CURL</code> directly <em>(as you get to ignore the whole "this apigateway needs to be deployed to a stage")</em></p>
<p><code>curl https://abc123.execute-api.us-east-1.amazonaws.com/prod/ping</code></p>
<p><em>you should get back either 404 or "pong" =)</em></p>
<p>To see how much more work it is to do (and understand) the API Gateway concepts... </p>
<ul>
<li><a href="https://blog.john-pfeiffer.com/localstack-apigateway-lambda-and-s3-integration-testing/">https://blog.john-pfeiffer.com/localstack-apigateway-lambda-and-s3-integration-testing/</a></li>
</ul>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/localstack-apigateway-lambda-and-s3-integration-testing/" title="Previous: Localstack APIGateway Lambda and S3 integration testing">Localstack APIGateway Lambda and S3 integration testing</a></li>
 
                <li class="next_article"><a href="https://blog.john-pfeiffer.com/sorting-in-golang/" title="Next: Sorting in Golang">Sorting in Golang</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2020-09-27T14:48:00-07:00">Sep 27, 2020</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#build-CI-CD-devops-ref">build-CI-CD-devops</a> 
            <h4>~1206 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#apigateway-ref">apigateway
                    <span>3</span>
</a></li>
                <li><a href="/tags.html#aws-ref">aws
                    <span>6</span>
</a></li>
                <li><a href="/tags.html#cdk-ref">cdk
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#go-ref">go
                    <span>13</span>
</a></li>
                <li><a href="/tags.html#golang-ref">golang
                    <span>13</span>
</a></li>
                <li><a href="/tags.html#lambda-ref">lambda
                    <span>3</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
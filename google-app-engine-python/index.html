<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="programming, google app engine, python, webapp2, programming, " />
        <title>Google App Engine Python  · johnpfeiffer
</title>
        <link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3758734-9']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/google-app-engine-python/"> Google App Engine Python  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#setting-up">Setting Up</a><ul>
<li><a href="#a-first-helloworldappyaml">A first helloworld/app.yaml</a></li>
<li><a href="#helloworldmainpy">helloworld/main.py</a></li>
<li><a href="#view-the-app-on-your-local-machine">View the app on your local machine</a></li>
<li><a href="#upload-the-app-to-google-app-engine">Upload the app to Google App Engine</a></li>
</ul>
</li>
<li><a href="#download-an-existing-application-from-google-app-engine">Download an existing application from Google App Engine</a></li>
<li><a href="#updating-the-application-for-routes-and-post-requests">Updating the Application for routes and POST requests</a><ul>
<li><a href="#appyaml">app.yaml</a></li>
<li><a href="#mainpy">main.py</a></li>
<li><a href="#update-the-google-app-engine-application-code-that-is-running-in-the-cloud">Update the google app engine application code that is running in the cloud</a></li>
</ul>
</li>
<li><a href="#a-simple-single-file-crud-app-using-the-google-appengine-database">A simple single file CRUD app using the Google AppEngine Database</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<h2 id="setting-up">Setting Up</h2>
<p>Sign up for Google App Engine (gmail + SMS verification)</p>
<p>"Google App Engine (often referred to as GAE or simply App Engine, and also used by the acronym GAE/J) is a platform as a service (PaaS) cloud computing platform for developing and hosting web applications in Google-managed data centers."</p>
<p>The Admin Dashboard is linked to your Google profile <a href="https://console.cloud.google.com">https://console.cloud.google.com</a></p>
<p>Login and create an Application (e.g. named john-pfeiffer reachable at <a href="http://john-pfeiffer.appspot.com">http://john-pfeiffer.appspot.com</a>)</p>
<p>Download and extract the SDK (e.g. gae-python.zip)</p>
<div class="highlight"><pre><span></span>cd google_appengine
cp -a new_project_template helloworld
</pre></div>
<blockquote>
<p>Inside is the minimum file structucture required to have an application</p>
</blockquote>
<ul>
<li>app.yaml is the configuration file</li>
<li>index.yaml is how to override configuration for database indices</li>
<li>favicon.ico is the icon that appears in the browser tab or bookmark <a href="https://en.wikipedia.org/wiki/Favicon">https://en.wikipedia.org/wiki/Favicon</a></li>
<li>main.py is the entrypoint for your application</li>
</ul>
<hr/>
<h3 id="a-first-helloworldappyaml">A first helloworld/app.yaml</h3>
<div class="highlight"><pre><span></span><span class="n">application</span><span class="o">:</span> <span class="n">john</span><span class="o">-</span><span class="n">pfeiffer</span>
<span class="n">version</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">runtime</span><span class="o">:</span> <span class="n">python27</span>
<span class="n">api_version</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">threadsafe</span><span class="o">:</span> <span class="n">yes</span>

<span class="n">handlers</span><span class="o">:</span>
<span class="o">-</span> <span class="n">url</span><span class="o">:</span> <span class="o">/</span><span class="n">favicon</span><span class="o">\.</span><span class="n">ico</span>
<span class="n">static_files</span><span class="o">:</span> <span class="n">favicon</span><span class="o">.</span><span class="na">ico</span>
<span class="n">upload</span><span class="o">:</span> <span class="n">favicon</span><span class="o">\.</span><span class="n">ico</span>

<span class="o">-</span> <span class="n">url</span><span class="o">:</span> <span class="o">.*</span>
<span class="n">script</span><span class="o">:</span> <span class="n">main</span><span class="o">.</span><span class="na">app</span>

<span class="n">libraries</span><span class="o">:</span>
<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">webapp2</span>
<span class="n">version</span><span class="o">:</span> <span class="s2">"2.5.2"</span>
</pre></div>
<h3 id="helloworldmainpy">helloworld/main.py</h3>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">webapp2</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Hi World!'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">)],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<h3 id="view-the-app-on-your-local-machine">View the app on your local machine</h3>
<div class="highlight"><pre><span></span>cd google_appengine
./dev_appserver.py ./helloworld

    INFO 2012-12-27 04:20:20,399 dev_appserver_multiprocess.py:655]
    Running application dev\~john-pfeiffer on port 8080:
    http://localhost:8080

    INFO 2012-12-27 04:20:20,399 dev_appserver_multiprocess.py:657] Admin console is available at: http://localhost:8080/\_ah/admin
</pre></div>
<h3 id="upload-the-app-to-google-app-engine">Upload the app to Google App Engine</h3>
<div class="highlight"><pre><span></span><span class="o">./</span><span class="nt">appcfg</span><span class="nc">.py</span> <span class="nt">update</span> <span class="nt">helloworld</span><span class="o">/</span>

    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Host</span><span class="o">:</span> <span class="nt">appengine</span><span class="nc">.google.com</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Application</span><span class="o">:</span> <span class="nt">john-pfeiffer</span><span class="o">;</span> <span class="nt">version</span><span class="o">:</span> <span class="nt">1</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Starting</span> <span class="nt">update</span> <span class="nt">of</span> <span class="nt">app</span><span class="o">:</span> <span class="nt">john-pfeiffer</span><span class="o">,</span> <span class="nt">version</span><span class="o">:</span> <span class="nt">1</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Getting</span> <span class="nt">current</span> <span class="nt">resource</span> <span class="nt">limits</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Scanning</span> <span class="nt">files</span> <span class="nt">on</span> <span class="nt">local</span> <span class="nt">disk</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Cloning</span> <span class="nt">1</span> <span class="nt">static</span> <span class="nt">file</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Cloning</span> <span class="nt">3</span> <span class="nt">application</span> <span class="nt">files</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Uploading</span> <span class="nt">1</span> <span class="nt">files</span> <span class="nt">and</span> <span class="nt">blobs</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Uploaded</span> <span class="nt">1</span> <span class="nt">files</span> <span class="nt">and</span> <span class="nt">blobs</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Compilation</span> <span class="nt">starting</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Compilation</span> <span class="nt">completed</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:44</span> <span class="nt">PM</span> <span class="nt">Starting</span> <span class="nt">deployment</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:45</span> <span class="nt">PM</span> <span class="nt">Checking</span> <span class="nt">if</span> <span class="nt">deployment</span> <span class="nt">succeeded</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:45</span> <span class="nt">PM</span> <span class="nt">Will</span> <span class="nt">check</span> <span class="nt">again</span> <span class="nt">in</span> <span class="nt">1</span> <span class="nt">seconds</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:45</span> <span class="nt">PM</span> <span class="nt">Checking</span> <span class="nt">if</span> <span class="nt">deployment</span> <span class="nt">succeeded</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:45</span> <span class="nt">PM</span> <span class="nt">Will</span> <span class="nt">check</span> <span class="nt">again</span> <span class="nt">in</span> <span class="nt">2</span> <span class="nt">seconds</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:45</span> <span class="nt">PM</span> <span class="nt">Checking</span> <span class="nt">if</span> <span class="nt">deployment</span> <span class="nt">succeeded</span><span class="o">.</span>
    <span class="nt">07</span><span class="nd">:45</span> <span class="nt">PM</span> <span class="nt">Deployment</span> <span class="nt">successful</span><span class="o">.</span>
</pre></div>
<p>Verify with <code>curl http://john-pfeiffer.appspot.com</code></p>
<h2 id="download-an-existing-application-from-google-app-engine">Download an existing application from Google App Engine</h2>
<div class="highlight"><pre><span></span>mkdir -p /tmp/myapp
appcfg.py download_app -A john-pfeiffer /tmp/myapp
</pre></div>
<blockquote>
<p>This will use OAuth 2 to open a browser/give you a link where you can confirm the action
Once confirmed it will download the latest version off your application code and files
This is independent of and not a replacement for version control!</p>
</blockquote>
<h2 id="updating-the-application-for-routes-and-post-requests">Updating the Application for routes and POST requests</h2>
<p>It is easy to use the MVC pattern while inheriting from the framework <a href="https://webapp-improved.appspot.com/guide/handlers.html">https://webapp-improved.appspot.com/guide/handlers.html</a></p>
<h3 id="appyaml">app.yaml</h3>
<blockquote>
<p>Note that the version has to be explicitly updated in order to deploy something new</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="n">application</span><span class="o">:</span> <span class="n">john</span><span class="o">-</span><span class="n">pfeiffer</span>
<span class="n">version</span><span class="o">:</span> <span class="mi">6</span>
<span class="n">runtime</span><span class="o">:</span> <span class="n">python27</span>
<span class="n">api_version</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">threadsafe</span><span class="o">:</span> <span class="n">yes</span>

<span class="n">handlers</span><span class="o">:</span>
<span class="o">-</span> <span class="n">url</span><span class="o">:</span> <span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="na">ico</span>
<span class="n">static_files</span><span class="o">:</span> <span class="n">favicon</span><span class="o">.</span><span class="na">ico</span>
<span class="n">upload</span><span class="o">:</span> <span class="n">favicon</span><span class="o">.</span><span class="na">ico</span>

<span class="o">-</span> <span class="n">url</span><span class="o">:</span> <span class="o">/.*</span>
<span class="n">script</span><span class="o">:</span> <span class="n">main</span><span class="o">.</span><span class="na">app</span>

<span class="n">libraries</span><span class="o">:</span>
<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">webapp2</span>
<span class="n">version</span><span class="o">:</span> <span class="s2">"2.5.2"</span>
</pre></div>
<h3 id="mainpy">main.py</h3>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">webapp2</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'hello John Pfeiffer!'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PageOne</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">            PageOne</span>
<span class="s2">        """</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">PageTwo</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'PageTwo'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span>
        <span class="n">post_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">get_values</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">post_values</span><span class="p">))</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'/page-one'</span><span class="p">,</span> <span class="n">PageOne</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'/page-two'</span><span class="p">,</span> <span class="n">PageTwo</span><span class="p">)</span>
    <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">run_wsgi_app</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<h3 id="update-the-google-app-engine-application-code-that-is-running-in-the-cloud">Update the google app engine application code that is running in the cloud</h3>
<div class="highlight"><pre><span></span>./appcfg.py update john-pfeiffer
</pre></div>
<blockquote>
<p>update does not publish the new version yet</p>
</blockquote>
<div class="highlight"><pre><span></span>./appcfg.py set_default_version john-pfeiffer
</pre></div>
<blockquote>
<p>or you can use the WebUI dashboard to change the default or delete a Version for an Application Instance</p>
</blockquote>
<p><a href="https://cloud.google.com/appengine/docs/python/config/appref">https://cloud.google.com/appengine/docs/python/config/appref</a></p>
<hr/>
<h2 id="a-simple-single-file-crud-app-using-the-google-appengine-database">A simple single file CRUD app using the Google AppEngine Database</h2>
<p>Google AppEngine applications can leverage the platforms NoSQL database <a href="https://cloud.google.com/appengine/docs/python/datastore/">https://cloud.google.com/appengine/docs/python/datastore/</a></p>
<p>The example application below also shows how to override the default 404 and 500 errors with custom jinja2 templates which would require installing the jinja2 dependency and an extra subdirectory named templates with the HTML</p>
<blockquote>
<p><a href="https://blog.john-pfeiffer.com/jinja2-a-web-html-template-layout-for-everyone/">https://blog.john-pfeiffer.com/jinja2-a-web-html-template-layout-for-everyone/</a></p>
<p><a href="https://cloud.google.com/appengine/docs/python/ndb/">https://cloud.google.com/appengine/docs/python/ndb/</a> has improved and deprecated the DB Datastore library used below</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># 2013-01-20 johnpfeiffer</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">webapp2</span>
<span class="kn">import</span> <span class="nn">jinja2</span>

<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">db</span>

<span class="n">jinja_environment</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span> <span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span> <span class="n">__file__</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span> <span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTimeProperty</span><span class="p">(</span> <span class="n">auto_now_add</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>


<span class="c1"># TODO: navigation bar</span>
<span class="k">class</span> <span class="nc">MainPage</span><span class="p">(</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span> <span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"""Welcome &lt;br/&gt;</span>

<span class="s2">         &lt;form action="/listnodes" method="get"&gt;</span>
<span class="s2">             &lt;input type="submit" value="List Nodes"&gt;</span>
<span class="s2">         &lt;/form&gt;</span>
<span class="s2">         &lt;br/&gt;</span>
<span class="s2">         &lt;form action="/createnodeform" method="get"&gt;</span>
<span class="s2">             &lt;input type="submit" value="Create Node"&gt;</span>
<span class="s2">         &lt;/form&gt;</span>
<span class="s2">         &lt;form action="/deletenode" method="post"&gt;</span>
<span class="s2">             &lt;label&gt;id&lt;/label&gt;&lt;/td&gt;&lt;td&gt;&lt;input type="text" id="id" name="id" /&gt;</span>
<span class="s2">             &lt;input type="submit" value="Delete Node"&gt;</span>
<span class="s2">         &lt;/form&gt;</span>

<span class="s2">         """</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>


<span class="k">class</span> <span class="nc">ListNodes</span><span class="p">(</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span> <span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'Welcome &lt;br/&gt;'</span> <span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Query</span><span class="p">(</span> <span class="n">Node</span> <span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">order</span><span class="p">(</span> <span class="s2">"name"</span> <span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> , </span><span class="si">%s</span><span class="s2"> , </span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%s</span><span class="s2"> )&lt;br/&gt;"</span> <span class="o">%</span> <span class="p">(</span> <span class="s2">"name"</span> <span class="p">,</span> <span class="s2">"id"</span> <span class="p">,</span> <span class="s2">"parent_id"</span> <span class="p">,</span> <span class="s2">"created"</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">q</span> <span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> , </span><span class="si">%s</span><span class="s2"> , </span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%s</span><span class="s2"> )&lt;br/&gt;"</span> <span class="o">%</span> <span class="p">(</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">date</span> <span class="p">)</span> <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>


<span class="c1"># TODO: use template system</span>
<span class="k">class</span> <span class="nc">CreateNode</span><span class="p">(</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span> <span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'Create uses POST'</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
    <span class="n">post_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span>

    <span class="c1"># todo extract to helper for input validation and sanitization</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">post_values</span><span class="p">[</span> <span class="s2">"nodename"</span> <span class="p">]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">post_values</span><span class="p">[</span> <span class="s2">"id"</span> <span class="p">]</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">post_values</span><span class="p">[</span> <span class="s2">"parentid"</span> <span class="p">]</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">parent_id</span> <span class="o">==</span> <span class="bp">None</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'ERROR: DEBUG:'</span> <span class="p">,</span> <span class="n">post_values</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="n">node</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="n">parent_id</span>

        <span class="n">node</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'successfully created: '</span> <span class="o">+</span> <span class="n">name</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"""</span>
<span class="s2">         &lt;form action="/listnodes" method="get"&gt;</span>
<span class="s2">             &lt;input type="submit" value="List Nodes"&gt;</span>
<span class="s2">         &lt;/form&gt;</span>
<span class="s2">        """</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>


<span class="k">class</span> <span class="nc">CreateNodeForm</span><span class="p">(</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span> <span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"""</span>
<span class="s2">         &lt;form action="/createnode" method="post"&gt;</span>
<span class="s2">            &lt;table&gt;</span>
<span class="s2">                &lt;tr&gt;&lt;td&gt;&lt;label&gt;node name&lt;/label&gt;&lt;/td&gt;&lt;td&gt;&lt;input type="text" id="nodename" name="nodename" /&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s2">                &lt;tr&gt;&lt;td&gt;&lt;label&gt;id&lt;/label&gt;&lt;/td&gt;&lt;td&gt;&lt;input type="text" id="id" name="id" /&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s2">                &lt;tr&gt;&lt;td&gt;&lt;label&gt;parent id&lt;/label&gt;&lt;/td&gt;&lt;td&gt;&lt;input type="text" id="parentid" name="parentid" /&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s2">                &lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;input type="submit"&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s2">            &lt;/table&gt;</span>
<span class="s2">          &lt;/form&gt;</span>
<span class="s2">        """</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>


<span class="c1"># TODO: use template system</span>
<span class="k">class</span> <span class="nc">DeleteNode</span><span class="p">(</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span> <span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'Delete uses POST'</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">'&lt;html&gt;&lt;body&gt;'</span> <span class="p">)</span>
    <span class="n">post_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span>

    <span class="c1"># todo extract to helper for input validation and sanitization</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">post_values</span><span class="p">[</span> <span class="s2">"id"</span> <span class="p">]</span>

<span class="c1">#    q = db.Query( Node )    # keys_only is faster and cheaper than retrieving the entities</span>
<span class="c1">#    q.filter( "id=" , id )</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">keys_only</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="s2">"id="</span><span class="p">,</span> <span class="nb">id</span> <span class="p">)</span>
    <span class="n">node_to_delete</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1">#    db.delete( )</span>
<span class="c1">#    node_key =          # __key__</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> , </span><span class="si">%s</span><span class="s2"> , </span><span class="si">%s</span><span class="s2"> ( </span><span class="si">%s</span><span class="s2"> )&lt;br/&gt;"</span> <span class="o">%</span> <span class="p">(</span> <span class="s2">"name"</span> <span class="p">,</span> <span class="nb">id</span> <span class="p">,</span> <span class="s2">"parent_id"</span> <span class="p">,</span> <span class="n">node_to_delete</span> <span class="p">)</span> <span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span> <span class="p">)</span>



<span class="c1"># url handler below -----------------------------</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">(</span> <span class="p">[</span>
  <span class="p">(</span> <span class="s1">'/'</span><span class="p">,</span> <span class="n">MainPage</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s1">'/listnodes'</span> <span class="p">,</span> <span class="n">ListNodes</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s1">'/createnode'</span> <span class="p">,</span> <span class="n">CreateNode</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s1">'/createnodeform'</span> <span class="p">,</span> <span class="n">CreateNodeForm</span> <span class="p">),</span>
  <span class="p">(</span> <span class="s1">'/deletenode'</span> <span class="p">,</span> <span class="n">DeleteNode</span> <span class="p">)</span>
<span class="p">],</span> <span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>



<span class="k">def</span> <span class="nf">handle_404</span> <span class="p">(</span><span class="n">request</span> <span class="p">,</span> <span class="n">response</span> <span class="p">,</span> <span class="n">exception</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">template_dictionary</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'title'</span> <span class="p">:</span> <span class="s1">'ERROR 404'</span> <span class="p">,</span> <span class="s1">'body_content'</span> <span class="p">:</span> <span class="n">exception</span><span class="o">.</span><span class="n">status</span> <span class="p">}</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">jinja_environment</span><span class="o">.</span><span class="n">get_template</span> <span class="p">(</span> <span class="s1">'templates/error.html'</span> <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span> <span class="p">(</span> <span class="n">template_dictionary</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_status</span> <span class="p">(</span> <span class="n">exception</span><span class="o">.</span><span class="n">status_int</span> <span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_500</span> <span class="p">(</span><span class="n">request</span> <span class="p">,</span> <span class="n">response</span> <span class="p">,</span> <span class="n">exception</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span> <span class="p">(</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span> <span class="p">(</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span> <span class="p">(</span> <span class="n">exception</span> <span class="p">)</span>
    <span class="n">template_dictionary</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'title'</span> <span class="p">:</span> <span class="s1">'Meow'</span> <span class="p">,</span> <span class="s1">'body_content'</span> <span class="p">:</span> <span class="s1">'Meow.  Meow meow meow, meow meow.'</span> <span class="p">}</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">jinja_environment</span><span class="o">.</span><span class="n">get_template</span> <span class="p">(</span> <span class="s1">'templates/error.html'</span> <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span> <span class="p">(</span> <span class="n">template_dictionary</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_status</span> <span class="p">(</span> <span class="mi">500</span> <span class="p">)</span>


<span class="n">app</span><span class="o">.</span><span class="n">error_handlers</span> <span class="p">[</span> <span class="mi">404</span> <span class="p">]</span> <span class="o">=</span> <span class="n">handle_404</span>
<span class="n">app</span><span class="o">.</span><span class="n">error_handlers</span> <span class="p">[</span> <span class="mi">500</span> <span class="p">]</span> <span class="o">=</span> <span class="n">handle_500</span>
</pre></div>
</td></tr></table>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/server-operations-cloud-versus-build-your-own/" title="Previous: Server Operations: Cloud versus Build Your Own">Server Operations: Cloud versus Build Your Own</a></li>
 
                <li class="next_article"><a href="https://blog.john-pfeiffer.com/fix-byobu-infinite-scroll-bug-on-ubuntu-1204-precise-pangolin/" title="Next: Fix Byobu infinite scroll bug on Ubuntu 12.04 Precise Pangolin">Fix Byobu infinite scroll bug on Ubuntu 12.04 Precise Pangolin</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2013-01-26T15:01:00-08:00">Jan 26, 2013</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#programming-ref">programming</a> 
            <h4>~1171 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#google-app-engine-ref">google app engine
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#programming-ref">programming
                    <span>6</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>9</span>
</a></li>
                <li><a href="/tags.html#webapp2-ref">webapp2
                    <span>2</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="go, golang, web, gorilla mux, http, template, heroku, postgres, programming, " />
        <title>Go Web Development and Templates with Heroku  · johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/go-web-development-and-templates-with-heroku/"> Go Web Development and Templates with Heroku  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#a-simple-http-server">A simple http server</a></li>
<li><a href="#go-dependency-management">Go Dependency Management</a></li>
<li><a href="#deploying-to-heroku-from-github-via-travis-ci">Deploying to Heroku from Github via Travis-CI</a><ul>
<li><a href="#heroku-prerequisites">Heroku Prerequisites</a></li>
<li><a href="#configuring-the-application-with-heroku">Configuring the Application with Heroku</a></li>
<li><a href="#travis-ci">Travis-CI</a></li>
<li><a href="#test-it">Test It</a></li>
</ul>
</li>
<li><a href="#templates-for-content">Templates for Content</a><ul>
<li><a href="#passing-variables-to-a-template">Passing Variables to a Template</a></li>
</ul>
</li>
<li><a href="#testdrivendesign-and-gorilla-mux">TestDrivenDesign and Gorilla Mux</a></li>
<li><a href="#miscellaneous">Miscellaneous</a><ul>
<li><a href="#logs-from-heroku">Logs from Heroku</a></li>
<li><a href="#environment-variables-for-configuration">Environment Variables for Configuration</a></li>
<li><a href="#custom-domains-with-heroku">Custom Domains with Heroku</a></li>
<li><a href="#downloading-the-source-code-from-heroku">Downloading the source code from Heroku</a></li>
</ul>
</li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Please create a new version controlled source code repository using Github or Bitbucket or ?.</li>
<li>Have Golang installed</li>
<li>Download and install the official Go dependency tool "dep", <a href="https://golang.github.io/dep/docs/installation.html">https://golang.github.io/dep/docs/installation.html</a></li>
</ul>
<h2 id="a-simple-http-server">A simple http server</h2>
<p>Your source repository currently only needs a single file: <strong>main.go</strong></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"log"</span>
        <span class="s">"net/http"</span>
        <span class="s">"os"</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">myHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">"hi"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">port</span> <span class="o">:=</span> <span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="s">"PORT"</span><span class="p">,</span> <span class="s">"8080"</span><span class="p">)</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"Listening on port"</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="nx">myHandler</span><span class="p">)</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">":"</span><span class="o">+</span><span class="nx">port</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">defaultValue</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">:=</span> <span class="nx">defaultValue</span>
        <span class="nx">val</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">LookupEnv</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
                <span class="nx">result</span> <span class="p">=</span> <span class="nx">val</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>another example of a trivial web server using only the standard library</p>
</blockquote>
<p>Verify it runs locally with: <code>go run main.go</code></p>
<blockquote>
<p>your browser should see "hi" in http://localhost:8080 and use "control + c" to cancel and quit the command line web server application</p>
</blockquote>
<p>While previous examples used Google App Engine  <a href="https://blog.john-pfeiffer.com/go-programming-intro-with-vs-code-and-arrays-slices-functions-and-testing/#a-simple-web-server">https://blog.john-pfeiffer.com/go-programming-intro-with-vs-code-and-arrays-slices-functions-and-testing/#a-simple-web-server</a>, here we will leverage Heroku for deploying our web application.</p>
<h2 id="go-dependency-management">Go Dependency Management</h2>
<p>First download and install the Go dependency tool:</p>
<ul>
<li><a href="https://github.com/golang/dep">https://github.com/golang/dep</a></li>
<li><a href="https://devcenter.heroku.com/articles/go-apps-with-dep#build-configuration">https://devcenter.heroku.com/articles/go-apps-with-dep#build-configuration</a></li>
<li>
<p><a href="https://devcenter.heroku.com/articles/go-apps-with-dep#getting-started">https://devcenter.heroku.com/articles/go-apps-with-dep#getting-started</a></p>
<p>cd DIRECTORY/OF/WEBAPP
dep init
go list -e .
echo "[metadata.heroku]" &gt;&gt; Gopkg.toml
echo "  root-package = \"<code>go list -e .</code>\"" &gt;&gt; Gopkg.toml
git status ; git diff
git add --all .
git commit -m "initial web app and using go dep"
git push</p>
</li>
<li>
<p>Example simple Go dep configuration file <a href="https://github.com/johnpfeiffer/web-go/blob/master/Gopkg.toml">https://github.com/johnpfeiffer/web-go/blob/master/Gopkg.toml</a></p>
</li>
</ul>
<h2 id="deploying-to-heroku-from-github-via-travis-ci">Deploying to Heroku from Github via Travis-CI</h2>
<h3 id="heroku-prerequisites">Heroku Prerequisites</h3>
<ol>
<li>Download and install the heroku CLI <a href="https://devcenter.heroku.com/articles/getting-started-with-go#set-up">https://devcenter.heroku.com/articles/getting-started-with-go#set-up</a></li>
<li><code>cd /opt ; wget https://cli-assets.heroku.com/branches/stable/heroku-linux-amd64.tar.gz</code></li>
<li><code>tar xf heroku-linux-amd64.tar.gz</code></li>
<li><code>/opt/heroku/bin/heroku --version ; /opt/heroku/bin/heroku --help</code></li>
<li><code>/opt/heroku/bin/heroku login</code> <em>this will prompt for your email and password and store the credentials in ~/.netrc</em></li>
</ol>
<blockquote>
<p>For extra security consider using heroku CLI inside of an ephemeral docker container or a script that removes the credentials after each usage</p>
</blockquote>
<p><em>These instructions will now assume heroku "just works", i.e. <code>alias heroku='/opt/heroku/bin/heroku'</code></em></p>
<h3 id="configuring-the-application-with-heroku">Configuring the Application with Heroku</h3>
<div class="highlight"><pre><span></span><span class="nb">cd</span> DIRECTORY/OF/WEBAPP
heroku <span class="nb">help</span>
heroku create APPNAME --buildpack heroku/go
heroku status
</pre></div>
<blockquote>
<p>This has created an empty Go application in heroku</p>
</blockquote>
<p>Later on when deploying the application to heroku if you receive the following error: <em>No default language could be detected for this app</em>, it means you did not set the buildpack language yet...</p>
<p><em>If you missed setting the buildpack language via CLI you can also use the WebUI after the app was already created <a href="https://dashboard.heroku.com/apps/APPNAME/settings">https://dashboard.heroku.com/apps/APPNAME/settings</a></em></p>
<ul>
<li><a href="https://devcenter.heroku.com/articles/buildpacks">https://devcenter.heroku.com/articles/buildpacks</a></li>
</ul>
<p>Another gotcha is if you have not configured a dependency manager (even without dependencies!) you will see this error <em>App not compatible with buildpack</em>.</p>
<h3 id="travis-ci">Travis-CI</h3>
<ul>
<li><a href="https://docs.travis-ci.com/user/deployment/heroku/">https://docs.travis-ci.com/user/deployment/heroku/</a></li>
</ul>
<p>First you will need to have retrieved your auth token: <code>heroku auth:token</code></p>
<p>You can connect the repository that was already created in Github to Travis via <a href="https://travis-ci.org">https://travis-ci.org</a> , more specifically at <a href="https://travis-ci.org/profile/USERNAME">https://travis-ci.org/profile/USERNAME</a></p>
<blockquote>
<p>you may need to "sync account" if you very recently created a repository , otherwise you will see this error: <em>repository not known to https://api.travis-ci.org/: USERNAME/REPONAME</em></p>
</blockquote>
<div class="highlight"><pre><span></span>docker run -it --rm ruby:alpine /bin/sh
apk update
apk add --no-cache build-base git
gem install travis travis-lint
travis <span class="nb">help</span>
</pre></div>
<blockquote>
<p>This docker example avoids installing ruby locally ;p</p>
</blockquote>
<p>Inside of the docker container you will need (using "vi" ;) to create a dummy .travis.yml file with the content:</p>
<div class="highlight"><pre><span></span><span class="n">deploy</span><span class="o">:</span>
  <span class="n">provider</span><span class="o">:</span> <span class="n">heroku</span>
  <span class="n">api_key</span><span class="o">:</span>
    <span class="n">secure</span><span class="o">:</span> <span class="s2">"YOUR ENCRYPTED API KEY"</span>
</pre></div>
<p>You can then run the following command which will update the .travis.yml file with the real encrypted auth token.
<code>travis encrypt YOUR-HEROKU-TOKEN --add deploy.api_key -r USERNAME/REPONAME</code></p>
<p>In your source code repository your real .travis.yml file will be:</p>
<div class="highlight"><pre><span></span><span class="n">language</span><span class="o">:</span> <span class="n">go</span>
<span class="n">script</span><span class="o">:</span> <span class="n">go</span> <span class="kd">get</span> <span class="o">&amp;&amp;</span> <span class="n">go</span> <span class="n">test</span> <span class="o">-</span><span class="n">v</span>
<span class="n">notifications</span><span class="o">:</span>
  <span class="n">email</span><span class="o">:</span> <span class="kc">false</span>

<span class="n">deploy</span><span class="o">:</span>
  <span class="n">provider</span><span class="o">:</span> <span class="n">heroku</span>
  <span class="n">api_key</span><span class="o">:</span>
    <span class="n">secure</span><span class="o">:</span> <span class="n">ABCD1234XYZLONGENCRYPTEDSTRING</span>
</pre></div>
<h3 id="test-it">Test It</h3>
<p>Now a browser that hits the Heroku URL will see "hi" , <a href="https://web-go.herokuapp.com/">https://web-go.herokuapp.com/</a></p>
<h2 id="templates-for-content">Templates for Content</h2>
<p>Separating out the static html content from dynamic and business logic parts of the application is a key way to remain modular.
Templates built into the Go standard library can provide output that is safe from code injection.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">indexTemplate</span> <span class="p">=</span> <span class="nx">GetIndexTemplate</span><span class="p">()</span>

<span class="kd">func</span> <span class="nx">myHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">indexTemplate</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">NoData</span><span class="p">{})</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>This small change to our previous <em>main.go</em> allows our default web handler (aka controller) to return html</p>
</blockquote>
<p><em>indextemplate.go</em></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">"html/template"</span>

<span class="c1">// NoData is an empty struct as I do not pass anything into the template</span>
<span class="kd">type</span> <span class="nx">NoData</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// GetIndexTemplate returns the index.html template https://golang.org/pkg/html/template/#Template</span>
<span class="kd">func</span> <span class="nx">GetIndexTemplate</span><span class="p">()</span> <span class="o">*</span><span class="nx">template</span><span class="p">.</span><span class="nx">Template</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">indexTemplate</span> <span class="p">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">"index"</span><span class="p">).</span><span class="nx">Parse</span><span class="p">(</span><span class="s">`&lt;html&gt;&lt;head&gt;&lt;style type="text/css"&gt;</span>
<span class="s">body{</span>
<span class="s">  font-size: 1.9em;</span>
<span class="s">}</span>
<span class="s">&lt;/style&gt;&lt;/head&gt;&lt;body&gt;hi&lt;/body&gt;&lt;/html&gt;</span>
<span class="s">`</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">indexTemplate</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>The function just returns the rendered template; since it is only called once in main it is not inefficient, and Must will panic if the template has an error</p>
</blockquote>
<p><code>go run main.go indextemplate.go</code> allows you to test it locally</p>
<ul>
<li><a href="https://golang.org/pkg/html/template/">https://golang.org/pkg/html/template/</a></li>
</ul>
<h3 id="passing-variables-to-a-template">Passing Variables to a Template</h3>
<h2 id="testdrivendesign-and-gorilla-mux">TestDrivenDesign and Gorilla Mux</h2>
<p>Tests help us communicate. Libraries and Composition, not Frameworks and Magic.</p>
<ul>
<li>TODO: Go Web and JSON</li>
<li>TODO: integrating heroku postgres , <a href="https://devcenter.heroku.com/articles/getting-started-with-go#use-a-database">https://devcenter.heroku.com/articles/getting-started-with-go#use-a-database</a></li>
<li><a href="https://github.com/johnpfeiffer/go-web-example">https://github.com/johnpfeiffer/go-web-example</a></li>
</ul>
<h2 id="miscellaneous">Miscellaneous</h2>
<h3 id="logs-from-heroku">Logs from Heroku</h3>
<p>To see the logs from the web application running in heroku: <code>heroku logs --app APPNAME --tail</code></p>
<h3 id="environment-variables-for-configuration">Environment Variables for Configuration</h3>
<ul>
<li><a href="https://devcenter.heroku.com/articles/getting-started-with-go#define-config-vars">https://devcenter.heroku.com/articles/getting-started-with-go#define-config-vars</a></li>
</ul>
<h3 id="custom-domains-with-heroku">Custom Domains with Heroku</h3>
<p>To use a custom domain name for your traffic <a href="https://devcenter.heroku.com/articles/custom-domains">https://devcenter.heroku.com/articles/custom-domains</a></p>
<h3 id="downloading-the-source-code-from-heroku">Downloading the source code from Heroku</h3>
<p>To download the source code from a running Heroku application: <code>heroku git:clone --app APPNAME</code> <a href="https://devcenter.heroku.com/articles/git-clone-heroku-app">https://devcenter.heroku.com/articles/git-clone-heroku-app</a></p>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://blog.john-pfeiffer.com/working-successfully-with-remote-contractors/" title="Previous: Working successfully with remote contractors">Working successfully with remote contractors</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2018-05-01T20:37:00-07:00">May 1, 2018</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#programming-ref">programming</a> 
            <h4>~805 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#go-ref">go
                    <span>9</span>
</a></li>
                <li><a href="/tags.html#golang-ref">golang
                    <span>9</span>
</a></li>
                <li><a href="/tags.html#gorilla-mux-ref">gorilla mux
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#heroku-ref">heroku
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#http-ref">http
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#postgres-ref">postgres
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#template-ref">template
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#web-ref">web
                    <span>3</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>
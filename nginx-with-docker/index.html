<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="john pfeiffer" />
        <meta name="copyright" content="john pfeiffer" />

<meta name="keywords" content="docker, nginx, virtualization, " />
        <title>nginx with Docker  Â· johnpfeiffer
</title>
        <!--link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css"-->
        <!--link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet"-->
        <link href="https://blog.john-pfeiffer.com/theme/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://blog.john-pfeiffer.com/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://blog.john-pfeiffer.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://blog.john-pfeiffer.com/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
	<div id="content-sans-footer">
        <div class="dropdown-backdrop">

			<div class="navbar navbar-static-top">
				<div class="navbar-inner">
					<div class="container">
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="https://blog.john-pfeiffer.com/"><span class=site-name>johnpfeiffer</span></a>
						<div class="nav-collapse collapse">
							<ul class="nav pull-right top-menu">
								<li ><a href="https://blog.john-pfeiffer.com">Home</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/john-likes/">John Likes</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/categories.html">Categories</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/tags.html">Tags</a></li>
								<li ><a href="https://blog.john-pfeiffer.com/archives.html">Archives</a></li>
								<li><form class="navbar-search" action="https://blog.john-pfeiffer.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span1"></div>
				<div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://blog.john-pfeiffer.com/nginx-with-docker/"> nginx with Docker  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#nginx-overview">nginx overview</a></li>
<li><a href="#docker-pull-nginx">docker pull nginx</a></li>
<li><a href="#docker-nginx-interactive-container">docker nginx interactive container</a></li>
<li><a href="#running-nginx-manually-in-the-interactive-docker-container">running nginx manually in the interactive docker container</a><ul>
<li><a href="#nginx-version-and-modules">nginx version and modules</a></li>
<li><a href="#test-your-config-file">Test your config file</a></li>
<li><a href="#run-nginx-directly">run nginx directly</a></li>
</ul>
</li>
<li><a href="#nginxconf">nginx.conf</a></li>
<li><a href="#build-your-own-nginx-dockerfile">Build your own nginx Dockerfile</a><ul>
<li><a href="#converting-an-existing-nginx-3rd-party-module-to-a-dynamic-module">Converting an existing nginx 3rd party module to a dynamic module</a></li>
</ul>
</li>
<li><a href="#configuring-nginx">Configuring nginx</a><ul>
<li><a href="#etcnginxnginxconf">/etc/nginx/nginx.conf</a></li>
<li><a href="#nginx-with-ssl">nginx with ssl</a><ul>
<li><a href="#etcnginxnginxconf_1">/etc/nginx/nginx.conf</a></li>
<li><a href="#openssl-self-signed-certificates">openssl self signed certificates</a></li>
<li><a href="#dockerized-nginx-with-ssl">dockerized nginx with ssl</a></li>
</ul>
</li>
<li><a href="#nginx-with-ssl-and-http2">nginx with ssl and http/2</a><ul>
<li><a href="#etcnginxnginxconf_2">/etc/nginx/nginx.conf</a></li>
<li><a href="#verifying-http2">Verifying HTTP/2</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#nginx-with-php-fpm">nginx with php-fpm</a><ul>
<li><a href="#investigate-php-fpm-in-docker">Investigate php-fpm in Docker</a></li>
<li><a href="#configure-nginx">Configure nginx</a><ul>
<li><a href="#some-test-content">Some Test Content</a></li>
</ul>
</li>
<li><a href="#docker-composeyml">docker-compose.yml</a></li>
<li><a href="#docker-compose-up-to-start-nginx-and-php-fpm">docker-compose up to start nginx and php-fpm</a></li>
</ul>
</li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
<h2 id="nginx-overview">nginx overview</h2>
<p><a href="http://nginx.org/en/">http://nginx.org/en/</a> is one of the most popular performant web servers in the world (and it's pretty handy as a reverse proxy or load balancer too!). <a href="http://nginx.org/en/docs/http/load_balancing.html">http://nginx.org/en/docs/http/load_balancing.html</a></p>
<p><a href="https://github.com/nginx/nginx">https://github.com/nginx/nginx</a> is written in c (very performant but often needs to be compiled , especially with any of the extra 3rd party modules <a href="https://www.nginx.com/resources/wiki/modules/">https://www.nginx.com/resources/wiki/modules/</a>).</p>
<p>A recent update means "...optionally load separate shared object files at runtime as modules" 
<a href="https://www.nginx.com/blog/dynamic-modules-nginx-1-9-11/">https://www.nginx.com/blog/dynamic-modules-nginx-1-9-11/</a></p>
<h2 id="docker-pull-nginx">docker pull nginx</h2>
<p>With Docker most of the time is spent in preparation, configuration, and testing.  The advantage is that less time is wasted on compiling, packaging, etc. (for all those still eeking out another 1% in efficiency via esoteric flags and bundling all sorts of custom modules - good luck!)</p>
<p>One quick way to attempt to leverage nginx as a front end for your projects is using containers with Docker <a href="https://hub.docker.com/_/nginx/">https://hub.docker.com/_/nginx/</a></p>
<div class="highlight"><pre><span></span><code>sudo su
docker pull nginx:alpine
docker images
</code></pre></div>
<blockquote>
<p>This will grab the latest image based on the very small alpine linux <a href="https://en.wikipedia.org/wiki/Alpine_Linux">https://en.wikipedia.org/wiki/Alpine_Linux</a>, around 13 MB vs 191 MB for the traditional nginx:latest which is based on debian jessie <a href="https://en.wikipedia.org/wiki/Debian">https://en.wikipedia.org/wiki/Debian</a></p>
</blockquote>
<p><a href="https://hub.docker.com/r/library/nginx/tags/">https://hub.docker.com/r/library/nginx/tags/</a> contains what other versions of nginx are provided by the vendor as Docker Images, the default build/image has quite a few modules <a href="http://nginx.org/en/docs/">http://nginx.org/en/docs/</a></p>
<blockquote>
<p>all future references to docker commands will assume you are root or typing sudo first</p>
</blockquote>
<h2 id="docker-nginx-interactive-container">docker nginx interactive container</h2>
<div class="highlight"><pre><span></span><code>docker run --rm --publish 127.0.0.1:80:80 nginx
</code></pre></div>
<blockquote>
<p>starts an ephemeral container that binds the container port 80 to the local Host port 80 (binding to 127.0.0.1 prevents any other access except from the Host) , note by not explicitly sharing port 443 it is not connected/available</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">-</span><span class="n">a</span>
<span class="n">CONTAINER</span><span class="w"> </span><span class="n">ID</span><span class="w">        </span><span class="n">IMAGE</span><span class="w">               </span><span class="n">COMMAND</span><span class="w">                  </span><span class="n">CREATED</span><span class="w">             </span><span class="n">STATUS</span><span class="w">                 </span><span class="n">PORTS</span><span class="w">                           </span><span class="n">NAMES</span>
<span class="mf">3f</span><span class="n">ccf15a3c24</span><span class="w">        </span><span class="n">nginx</span><span class="w">               </span><span class="s">"nginx -g '</span><span class="n">daemon</span><span class="w"> </span><span class="n">off</span><span class="s">"   3 seconds ago       Up 2 seconds        127.0.0.1:80-&gt;80/tcp, 443/tcp   pensive_elion</span>

<span class="s">netstat -antp</span>
<span class="s">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="s">tcp        0      0 127.0.0.1:80            0.0.0.0:*               LISTEN      5826/docker-proxy</span>


<span class="s">curl 127.0.0.1:80</span>
</code></pre></div>
<blockquote>
<p><code>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</code> is part of the default nginx home page, (success)</p>
</blockquote>
<p>You will notice the access logs are being output to the console (where the docker container is running).</p>
<div class="highlight"><pre><span></span><code><span class="mf">192.168.1.100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">01</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mf">1970</span><span class="p">:</span><span class="mf">01</span><span class="p">:</span><span class="mf">00</span><span class="p">:</span><span class="mf">59</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">"GET / HTTP/1.1"</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="mf">612</span><span class="w"> </span><span class="s">"-"</span><span class="w"> </span><span class="s">"curl/7.38.0"</span><span class="w"> </span><span class="s">"-"</span>
</code></pre></div>
<p><code>Control + C</code> will terminate the container</p>
<h2 id="running-nginx-manually-in-the-interactive-docker-container">running nginx manually in the interactive docker container</h2>
<div class="highlight"><pre><span></span><code>docker run --rm -i -t --publish 127.0.0.1:80:80 nginx /bin/bash
</code></pre></div>
<blockquote>
<p>Starting as root inside the container </p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="mi">@557</span><span class="n">ac197e2c1</span><span class="o">:/</span><span class="err">#</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">nginx</span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span>
</code></pre></div>
<h3 id="nginx-version-and-modules">nginx version and modules</h3>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="mi">@557</span><span class="n">ac197e2c1</span><span class="o">:/</span><span class="err">#</span><span class="w"> </span><span class="n">nginx</span><span class="w"> </span><span class="o">-</span><span class="n">V</span>
<span class="w">    </span><span class="n">nginx</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.9.7</span>
<span class="w">    </span><span class="n">built</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="mf">4.9.2</span><span class="w"> </span><span class="p">(</span><span class="n">Debian</span><span class="w"> </span><span class="mf">4.9.2</span><span class="mi">-10</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="n">built</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">OpenSSL</span><span class="w"> </span><span class="mf">1.0.1</span><span class="n">k</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">Jan</span><span class="w"> </span><span class="mi">2015</span>
<span class="w">    </span><span class="n">TLS</span><span class="w"> </span><span class="n">SNI</span><span class="w"> </span><span class="n">support</span><span class="w"> </span><span class="n">enabled</span>
<span class="w">    </span><span class="n">configure</span><span class="w"> </span><span class="n">arguments</span><span class="o">:</span><span class="w"> </span><span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="o">--</span><span class="n">sbin</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="o">--</span><span class="n">conf</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="o">--</span><span class="n">error</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">error</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">access</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">--</span><span class="n">pid</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">--</span><span class="n">lock</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">lock</span><span class="w"> </span><span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">body</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">client_temp</span><span class="w"> </span><span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">proxy_temp</span><span class="w"> </span><span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">fastcgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_temp</span><span class="w"> </span><span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">uwsgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">uwsgi_temp</span><span class="w"> </span><span class="o">--</span><span class="n">http</span><span class="o">-</span><span class="n">scgi</span><span class="o">-</span><span class="n">temp</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">scgi_temp</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">nginx</span><span class="w"> </span><span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">nginx</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_ssl_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_realip_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_addition_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_sub_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_dav_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_flv_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_mp4_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_gunzip_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_gzip_static_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_random_index_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_secure_link_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_stub_status_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_auth_request_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">stream</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">stream_ssl_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">mail</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">mail_ssl_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">aio</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">http_v2_module</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">cc</span><span class="o">-</span><span class="n">opt</span><span class="o">=</span><span class="err">'</span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O2</span><span class="w"> </span><span class="o">-</span><span class="n">fstack</span><span class="o">-</span><span class="n">protector</span><span class="o">-</span><span class="k">strong</span><span class="w"> </span><span class="o">-</span><span class="n">Wformat</span><span class="w"> </span><span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">format</span><span class="o">-</span><span class="n">security</span><span class="w"> </span><span class="o">-</span><span class="n">Wp</span><span class="p">,</span><span class="o">-</span><span class="n">D_FORTIFY_SOURCE</span><span class="o">=</span><span class="mi">2</span><span class="err">'</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">ld</span><span class="o">-</span><span class="n">opt</span><span class="o">=</span><span class="err">'</span><span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">-</span><span class="n">z</span><span class="p">,</span><span class="n">relro</span><span class="w"> </span><span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">--</span><span class="n">as</span><span class="o">-</span><span class="n">needed</span><span class="err">'</span><span class="w"> </span><span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">ipv6</span>
</code></pre></div>
<h3 id="test-your-config-file">Test your config file</h3>
<div class="highlight"><pre><span></span><code>nginx -t -c /etc/nginx/nginx.conf -g "daemon off;"
</code></pre></div>
<blockquote>
<p>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful</p>
</blockquote>
<h3 id="run-nginx-directly">run nginx directly</h3>
<div class="highlight"><pre><span></span><code>/usr/sbin/nginx -c /etc/nginx/nginx.conf
</code></pre></div>
<blockquote>
<p>-g "pid /var/run/nginx.pid; worker_processes 2;" from <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/commandline/">https://www.nginx.com/resources/wiki/start/topics/tutorials/commandline/</a></p>
</blockquote>
<h2 id="nginxconf">nginx.conf</h2>
<p>While there are quite a few ways to configure nginx one choice to make with Docker is to either</p>
<ol>
<li>
<p><code>docker run --name some-nginx -v /some/nginx.conf:/etc/nginx/nginx.conf:ro -d nginx</code></p>
<blockquote>
<p>run docker as a daemon with a specified Container Name and override the container nginx.conf file with /some/nginx.conf from the hose</p>
</blockquote>
</li>
<li>
<p>Use a Dockerfile (based on the upstream nginx Docker image) to copy your own configuration file and other custom bits in and build your own custom Docker image (a highly recommended way of not being completely dependent on an upstream provider - especially if you push your Docker Image to your own private registry afterwards)</p>
</li>
</ol>
<p>e.g. <a href="https://hub.docker.com/r/jwilder/nginx-proxy/~/dockerfile/">https://hub.docker.com/r/jwilder/nginx-proxy/~/dockerfile/</a> which also has "Foreman in Go lang" and makes use of expecting the Host to provide the SSL certificates</p>
<ul>
<li><a href="https://www.nginx.com/resources/admin-guide/nginx-web-server/">https://www.nginx.com/resources/admin-guide/nginx-web-server/</a></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/examples/full/">https://www.nginx.com/resources/wiki/start/topics/examples/full/</a></li>
</ul>
<p>Quickly testing the nginx configuration file using an ephemeral docker container:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--publish<span class="w"> </span><span class="m">127</span>.0.0.1:80:80<span class="w"> </span>nginx<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">"nginx -t -c /etc/nginx/nginx.conf"</span>
<span class="w">    </span>nginx:<span class="w"> </span>the<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span>syntax<span class="w"> </span>is<span class="w"> </span>ok
<span class="w">    </span>nginx:<span class="w"> </span>configuration<span class="w"> </span>file<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span><span class="nb">test</span><span class="w"> </span>is<span class="w"> </span>successful
</code></pre></div>
<h2 id="build-your-own-nginx-dockerfile">Build your own nginx Dockerfile</h2>
<p>If you require 3rd party modules then you will have to build nginx from source, e.g.
<a href="https://github.com/openresty/headers-more-nginx-module#installation">https://github.com/openresty/headers-more-nginx-module#installation</a></p>
<p>That being the case you'll probably want to have a build process with 2 Docker files:</p>
<ol>
<li>the first Dockerfile will contain build-essentials, gcc, make, etc. so that you can build the binary from source (with any 3rd party modules) <a href="http://nginx.org/en/docs/configure.html">http://nginx.org/en/docs/configure.html</a></li>
<li>The second docker image would be your "production container" where you copy in the custom nginx binary, install the dependencies (i.e. openssl), and setup the default config.</li>
</ol>
<h3 id="converting-an-existing-nginx-3rd-party-module-to-a-dynamic-module">Converting an existing nginx 3rd party module to a dynamic module</h3>
<p>Since NGINX 1.9.11 supports dynamic modules and attempts to maintain API compatibility then it is possible to sometimes convert a module into a dynamic module (i.e. build the shared library object)</p>
<div class="highlight"><pre><span></span><code>./configure --add-dynamic-module=/opt/source/ngx_my_module/
make -f objs/Makefile modules
</code></pre></div>
<blockquote>
<p>Look for .so files in the objs directory after compilation or the modules subdirectory during installation</p>
</blockquote>
<p><a href="https://www.nginx.com/resources/wiki/extending/converting/">https://www.nginx.com/resources/wiki/extending/converting/</a></p>
<h2 id="configuring-nginx">Configuring nginx</h2>
<p>There are entire books about how to configure nginx so I will just jot down some basics for myself.</p>
<h3 id="etcnginxnginxconf">/etc/nginx/nginx.conf</h3>
<div class="highlight"><pre><span></span><code><span class="n">user</span><span class="w"> </span><span class="n">nginx</span><span class="p">;</span>
<span class="n">worker_processes</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="n">pid</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">pid</span><span class="p">;</span>

<span class="n">events</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">worker_connections</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">http</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1"># include /etc/nginx/conf.d/*.conf;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<ul>
<li>Run the service as the www-data user and define 4 worker processes</li>
<li>define an HTTP server that listens on port 80 by default</li>
<li>the root location will return the contents of /var/www</li>
<li>a best practice is to use multiple configuration files in the conf.d directory (as a really long complex configuration in a single is difficult to maintain)</li>
<li>BUT we must comment it out as in the installation there can be a default.conf that overrides our nginx.conf</li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><code>sudo docker run -it --rm --publish 0.0.0.0:80:80 --volume /tmp/nginx.conf:/etc/nginx/nginx.conf:ro  nginx:alpine /bin/sh
</code></pre></div>
<blockquote>
<p>debug the image interactively by overriding the default CMD with a shell (remember that Alpine is limited so <code>apk update</code> and <code>apk add SOMENAME</code></p>
</blockquote>
<div class="highlight"><pre><span></span><code>sudo docker run --rm --publish 0.0.0.0:80:80 --volume /tmp/nginx.conf:/etc/nginx/nginx.conf:ro  nginx:alpine /bin/sh -c "nginx -t -c /etc/nginx/nginx.conf"
</code></pre></div>
<blockquote>
<p>alternative method to just test your configuration file</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">--</span><span class="n">publish</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="n">ro</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="n">ro</span><span class="w">  </span><span class="n">nginx</span><span class="p">:</span><span class="n">alpine</span>
</code></pre></div>
<blockquote>
<p>assumes you have a config file and some index file defined</p>
</blockquote>
<div class="highlight"><pre><span></span><code>echo<span class="w"> </span>"<span class="nt">&lt;html&gt;&lt;body&gt;</span>hi<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>"<span class="w"> </span>&gt;<span class="w"> </span>/var/www/index.html
</code></pre></div>
<p>That's it, now you have nginx serving static files! (curl localhost OR use a browser and visit localhost or http://hostfqdn)</p>
<blockquote>
<p>of course /tmp is an insecure location so please store production nginx configuration files and web content from a secure directory in the docker host filesystem</p>
</blockquote>
<ul>
<li><a href="http://nginx.org/en/docs/beginners_guide.html">http://nginx.org/en/docs/beginners_guide.html</a></li>
<li><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_processes">http://nginx.org/en/docs/ngx_core_module.html#worker_processes</a></li>
</ul>
<h3 id="nginx-with-ssl">nginx with ssl</h3>
<p>It is hard to imagine running a production (or even test or dev server that should mirror production) without SSL since all traffic could be intercepted or hijacked.  It takes a little more work but clearly it is an important step in running a service that others will use.</p>
<h4 id="etcnginxnginxconf_1">/etc/nginx/nginx.conf</h4>
<div class="highlight"><pre><span></span><code><span class="n">user</span><span class="w"> </span><span class="n">nobody</span><span class="p">;</span>
<span class="n">worker_processes</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="n">pid</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">pid</span><span class="p">;</span>

<span class="n">events</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">worker_connections</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">http</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="p">;</span>

<span class="w">        </span><span class="n">ssl_certificate</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span><span class="p">;</span>
<span class="w">        </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span><span class="p">;</span>

<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="openssl-self-signed-certificates">openssl self signed certificates</h4>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>req<span class="w"> </span>-subj<span class="w"> </span>'/CN=example.com/O=My<span class="w"> </span>Company<span class="w"> </span>Name<span class="w"> </span>LTD./C=US'<span class="w"> </span>-new<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-days<span class="w"> </span>365<span class="w"> </span>-nodes<span class="w"> </span>-x509<span class="w"> </span>-keyout<span class="w"> </span>/tmp/server.key<span class="w"> </span>-out<span class="w"> </span>/tmp/server.crt

mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/www

echo<span class="w"> </span>"<span class="nt">&lt;html&gt;&lt;body&gt;</span>hi<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>"<span class="w"> </span>&gt;<span class="w"> </span>/tmp/www/index.html
</code></pre></div>
<h4 id="dockerized-nginx-with-ssl">dockerized nginx with ssl</h4>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">--</span><span class="n">publish</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">443</span><span class="p">:</span><span class="mi">443</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="n">ro</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="n">ro</span><span class="w">  </span><span class="n">nginx</span><span class="p">:</span><span class="n">alpine</span>

<span class="n">curl</span><span class="w"> </span><span class="o">--</span><span class="n">insecure</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span>
<span class="n">firefox</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span>
</code></pre></div>
<ul>
<li><a href="http://nginx.org/en/docs/http/configuring_https_servers.html">http://nginx.org/en/docs/http/configuring_https_servers.html</a></li>
</ul>
<h3 id="nginx-with-ssl-and-http2">nginx with ssl and http/2</h3>
<p><a href="https://en.wikipedia.org/wiki/HTTP/2">https://en.wikipedia.org/wiki/HTTP/2</a> is a new and more capable and performant standard for the venerable HTTP protocol.  It has widespread vendor support so you can use most modern servers (e.g. nginx) and most modern browsers (e.g. chrome) and get the benefits immediately. (With of course all sorts of fallbacks for legacy clients)</p>
<h4 id="etcnginxnginxconf_2">/etc/nginx/nginx.conf</h4>
<div class="highlight"><pre><span></span><code><span class="n">user</span><span class="w"> </span><span class="n">nobody</span><span class="p">;</span>
<span class="n">worker_processes</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="n">pid</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">pid</span><span class="p">;</span>

<span class="n">events</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">worker_connections</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">http</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//$</span><span class="n">host</span><span class="o">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="w"> </span><span class="n">http2</span><span class="w"> </span><span class="n">default_server</span><span class="p">;</span>

<span class="w">        </span><span class="n">ssl_certificate</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span><span class="p">;</span>
<span class="w">        </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span><span class="p">;</span>

<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>Assuming the previous nginx with ssl steps of creating a certificate and content, be aware that <strong>browsers permanently CACHE the 301 redirect</strong> so use Private Browsing mode otherwise you will never see a different result for localhost =[</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">--</span><span class="n">publish</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="o">--</span><span class="n">publish</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">443</span><span class="p">:</span><span class="mi">443</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="n">ro</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="n">ro</span><span class="w">  </span><span class="n">nginx</span><span class="p">:</span><span class="n">alpine</span>
</code></pre></div>
<h4 id="verifying-http2">Verifying HTTP/2</h4>
<p><strong>curl</strong></p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;title&gt;</span>301<span class="w"> </span>Moved<span class="w"> </span>Permanently<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body</span><span class="w"> </span><span class="na">bgcolor=</span><span class="s">"white"</span><span class="nt">&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>301<span class="w"> </span>Moved<span class="w"> </span>Permanently<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="nt">&lt;hr&gt;&lt;center&gt;</span>nginx/1.9.12<span class="nt">&lt;/center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>


curl<span class="w"> </span>--insecure<span class="w"> </span>--location<span class="w"> </span>localhost

<span class="nt">&lt;html&gt;&lt;body&gt;</span>hi<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div>
<p><strong>openssl s_client</strong></p>
<div class="highlight"><pre><span></span><code><span class="nv">openssl</span><span class="w"> </span><span class="nv">s_client</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="nv">localhost</span>:<span class="mi">443</span><span class="w"> </span><span class="o">-</span><span class="nv">nextprotoneg</span><span class="w"> </span><span class="s1">''</span>

<span class="nv">CONNECTED</span><span class="ss">(</span><span class="mi">00000003</span><span class="ss">)</span>
<span class="nv">Protocols</span><span class="w"> </span><span class="nv">advertised</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">server</span>:<span class="w"> </span><span class="nv">h2</span>,<span class="w"> </span><span class="nv">http</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span>
</code></pre></div>
<p><strong>chrome browser</strong></p>
<p>Browse directly to https://localhost/ with the chrome extension installed: <a href="https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin/related?hl=en">https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin/related?hl=en</a></p>
<p>The blue lightning symbol on the far far right (next to the "hamburger") indicates HTTP/2 is working.</p>
<blockquote>
<p><strong>browsers permanently CACHE the 301 redirect</strong> so connecting to http://localhost will forever see a different result for localhost =[</p>
</blockquote>
<ol>
<li>Browse directly to https://localhost/  (If using a self signed certificate accept any warnings about insecure SSL)</li>
<li>Chrome/Chromium Settings -&gt; More tools -&gt; Developer tools (aka Control + Shift + I)</li>
<li>Click on the Network section</li>
<li>Control + Shift + F5 to reload (or click on the arrow circling up)</li>
<li>Right click on the Name colum in the result so that you can add results for column heading, "Protocol"</li>
<li>
<p>Control + Shift + F5 to reload (or click on the arrow circling up)</p>
<p>Protocol: h2</p>
</li>
<li>
<p><a href="https://www.nginx.com/blog/nginx-1-9-5/">https://www.nginx.com/blog/nginx-1-9-5/</a></p>
</li>
<li><a href="https://blog.cloudflare.com/tools-for-debugging-testing-and-using-http-2/">https://blog.cloudflare.com/tools-for-debugging-testing-and-using-http-2/</a></li>
<li><a href="http://tech.finn.no/2015/09/25/setup-nginx-with-http2-for-local-development/">http://tech.finn.no/2015/09/25/setup-nginx-with-http2-for-local-development/</a></li>
</ol>
<h2 id="nginx-with-php-fpm">nginx with php-fpm</h2>
<h3 id="investigate-php-fpm-in-docker">Investigate php-fpm in Docker</h3>
<p>This hack is fun but proves unnecessary when using Docker Compose later...</p>
<p>:::bash
    docker pull php:5.5-fpm-alpine
    ifconfig | grep Bc
    docker run -it --rm --publish 0.0.0.0:9000:9000 php:5.5-fpm-alpine /bin/sh
    route -n
    php-fpm --version
    sed -i 's/listen = 127.0.0.1:9000/listen = 0.0.0.0:9000/g' /usr/local/etc/php-fpm.d/www.conf
    php-fpm --fpm-config /usr/local/etc/php-fpm.conf</p>
<blockquote>
<ul>
<li>ifconfig and route -n are to discover the docker host IP Address via the default gateway 172.17.0.1</li>
<li>contains include=etc/php-fpm.d/*.conf</li>
<li>/usr/local/etc/php-fpm.d/www.conf</li>
</ul>
</blockquote>
<ul>
<li><a href="https://hub.docker.com/_/php/">https://hub.docker.com/_/php/</a></li>
<li><a href="http://php.net/manual/en/install.fpm.configuration.php">http://php.net/manual/en/install.fpm.configuration.php</a></li>
</ul>
<h3 id="configure-nginx">Configure nginx</h3>
<p><code>vi /etc/nginx/nginx.conf</code></p>
<div class="highlight"><pre><span></span><code><span class="n">worker_processes</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="n">pid</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">pid</span><span class="p">;</span>

<span class="n">events</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">worker_connections</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">http</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
<span class="w">            </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span>\<span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
<span class="w">            </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="p">;</span>
<span class="w">            </span><span class="n">fastcgi_index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>

<span class="w">            </span><span class="c1"># depends on Docker linking or hostfile for fpm to resolve</span>
<span class="w">            </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">fpm</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>

<span class="w">            </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">SCRIPT_FILENAME</span><span class="w"> </span><span class="o">$</span><span class="n">document_root</span><span class="o">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
<span class="w">            </span><span class="c1"># https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-5385</span>
<span class="w">            </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">HTTP_PROXY</span><span class="w"> </span><span class="s2">""</span><span class="p">;</span>

<span class="w">            </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>a basic nginx config that forwards .php requests to fpm on port 9000</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">--</span><span class="n">publish</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="n">ro</span><span class="w"> </span><span class="o">--</span><span class="n">volume</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">:</span><span class="n">ro</span><span class="w">  </span><span class="n">nginx</span><span class="p">:</span><span class="n">alpine</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="n">route</span><span class="w"> </span><span class="o">-</span><span class="n">n</span>
</code></pre></div>
<blockquote>
<p>This manual command proves unnecessary with Docker Compose but can be useful to debug (i.e. run the php-fpm container first, then run this one since it depends on fpm)</p>
</blockquote>
<h4 id="some-test-content">Some Test Content</h4>
<p>Create the following files to test the various cases...</p>
<p><code>vi /tmp/www/html/foo.html</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;html&gt;&lt;body&gt;</span>hi<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div>
<p><code>vi /tmp/www/html/index.php</code></p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>
    <span class="k">print</span> <span class="s2">"&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p><code>vi /tmp/www/html/bar.php</code></p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>
    <span class="k">print</span> <span class="s2">"bar"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<h3 id="docker-composeyml">docker-compose.yml</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># https://docs.docker.com/compose/compose-file/</span>

<span class="n">nginx</span><span class="p">:</span>
<span class="w">  </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">nginx</span><span class="p">:</span><span class="n">alpine</span>
<span class="w">  </span><span class="n">ports</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="s2">"80:80"</span>
<span class="w">  </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span><span class="n">ro</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>
<span class="w">  </span><span class="n">links</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">fpm</span>

<span class="n">fpm</span><span class="p">:</span>
<span class="w">  </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">php</span><span class="p">:</span><span class="mf">5.5</span><span class="o">-</span><span class="n">fpm</span><span class="o">-</span><span class="n">alpine</span>
<span class="w">  </span><span class="n">ports</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="s2">"9000:9000"</span>
<span class="w">  </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>

<span class="c1"># http://stackoverflow.com/questions/29905953/how-to-correctly-link-php-fpm-and-nginx-docker-containers-together</span>
<span class="c1"># http://stackoverflow.com/questions/35388590/issue-with-docker-compose-container-command-not-found</span>
</code></pre></div>
<h3 id="docker-compose-up-to-start-nginx-and-php-fpm">docker-compose up to start nginx and php-fpm</h3>
<div class="highlight"><pre><span></span><code>docker-compose<span class="w"> </span>up
docker-compose<span class="w"> </span>rm<span class="w"> </span>-f
curl<span class="w"> </span>localhost:80/foo.html
curl<span class="w"> </span>localhost:80/bar.php
curl<span class="w"> </span>localhost:80/index.php
</code></pre></div>
<p>Another tiny step forward in tying together a lot of moving pieces =]</p>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">Â« <a href="https://blog.john-pfeiffer.com/meeting-bjarne-stroustrup-creator-of-c-plus-plus-in-the-atlassian-dev-den/" title="Previous: Meeting Bjarne Stroustrup, creator of C plus plus, in the Atlassian Dev Den">Meeting Bjarne Stroustrup, creator of C plus plus, in the Atlassian Dev Den</a></li>
 
                <li class="next_article"><a href="https://blog.john-pfeiffer.com/build-automation-using-packer-to-build-an-ami-use-immutable-not-chef/" title="Next: Build Automation using packer to build an AMI use immutable not chef">Build Automation using packer to build an AMI use immutable not chef</a> Â»</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-06-13T08:00:00-07:00">Jun 13, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#virtualization-ref">virtualization</a> 
            <h4>~1739 words</h4>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#docker-ref">docker
                    <span>5</span>
</a></li>
                <li><a href="/tags.html#nginx-ref">nginx
                    <span>4</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
				</div>
				<div class="span1"></div>
			</div>
		</div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>